(function(C,pe){typeof exports=="object"&&typeof module<"u"?pe(exports,require("leaflet")):typeof define=="function"&&define.amd?define(["exports","leaflet"],pe):(C=typeof globalThis<"u"?globalThis:C||self,pe(C.Allmaps={},C.L))})(this,function(C,pe){"use strict";function uo(r){const t=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(r){for(const e in r)if(e!=="default"){const n=Object.getOwnPropertyDescriptor(r,e);Object.defineProperty(t,e,n.get?n:{enumerable:!0,get:()=>r[e]})}}return t.default=r,Object.freeze(t)}const pt=uo(pe);function $r(r){return Array.isArray(r)?`[${r.map(t=>$r(t)).join(",")}]`:typeof r=="number"?`${r}`:typeof r=="string"?`"${r}"`:typeof r=="object"&&r!==null?Object.keys(r).sort().map(t=>`${t}:${$r(r[t])}`).join("|"):String(r)}async function fo(r){const t=await crypto.subtle.digest("SHA-1",new TextEncoder().encode(r));return Array.from(new Uint8Array(t)).map(i=>i.toString(16).padStart(2,"0")).join("")}async function Jn(r,t=16){return(await fo(String(r))).slice(0,t)}async function po(r,t){return await Jn($r(r),t)}var H;(function(r){r.assertEqual=i=>i;function t(i){}r.assertIs=t;function e(i){throw new Error}r.assertNever=e,r.arrayToEnum=i=>{const s={};for(const a of i)s[a]=a;return s},r.getValidEnumValues=i=>{const s=r.objectKeys(i).filter(o=>typeof i[i[o]]!="number"),a={};for(const o of s)a[o]=i[o];return r.objectValues(a)},r.objectValues=i=>r.objectKeys(i).map(function(s){return i[s]}),r.objectKeys=typeof Object.keys=="function"?i=>Object.keys(i):i=>{const s=[];for(const a in i)Object.prototype.hasOwnProperty.call(i,a)&&s.push(a);return s},r.find=(i,s)=>{for(const a of i)if(s(a))return a},r.isInteger=typeof Number.isInteger=="function"?i=>Number.isInteger(i):i=>typeof i=="number"&&isFinite(i)&&Math.floor(i)===i;function n(i,s=" | "){return i.map(a=>typeof a=="string"?`'${a}'`:a).join(s)}r.joinValues=n,r.jsonStringifyReplacer=(i,s)=>typeof s=="bigint"?s.toString():s})(H||(H={}));var Xr;(function(r){r.mergeShapes=(t,e)=>({...t,...e})})(Xr||(Xr={}));const O=H.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),Wt=r=>{switch(typeof r){case"undefined":return O.undefined;case"string":return O.string;case"number":return isNaN(r)?O.nan:O.number;case"boolean":return O.boolean;case"function":return O.function;case"bigint":return O.bigint;case"symbol":return O.symbol;case"object":return Array.isArray(r)?O.array:r===null?O.null:r.then&&typeof r.then=="function"&&r.catch&&typeof r.catch=="function"?O.promise:typeof Map<"u"&&r instanceof Map?O.map:typeof Set<"u"&&r instanceof Set?O.set:typeof Date<"u"&&r instanceof Date?O.date:O.object;default:return O.unknown}},R=H.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]),go=r=>JSON.stringify(r,null,2).replace(/"([^"]+)":/g,"$1:");class Mt extends Error{constructor(t){super(),this.issues=[],this.addIssue=n=>{this.issues=[...this.issues,n]},this.addIssues=(n=[])=>{this.issues=[...this.issues,...n]};const e=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,e):this.__proto__=e,this.name="ZodError",this.issues=t}get errors(){return this.issues}format(t){const e=t||function(s){return s.message},n={_errors:[]},i=s=>{for(const a of s.issues)if(a.code==="invalid_union")a.unionErrors.map(i);else if(a.code==="invalid_return_type")i(a.returnTypeError);else if(a.code==="invalid_arguments")i(a.argumentsError);else if(a.path.length===0)n._errors.push(e(a));else{let o=n,c=0;for(;c<a.path.length;){const h=a.path[c];c===a.path.length-1?(o[h]=o[h]||{_errors:[]},o[h]._errors.push(e(a))):o[h]=o[h]||{_errors:[]},o=o[h],c++}}};return i(this),n}toString(){return this.message}get message(){return JSON.stringify(this.issues,H.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(t=e=>e.message){const e={},n=[];for(const i of this.issues)i.path.length>0?(e[i.path[0]]=e[i.path[0]]||[],e[i.path[0]].push(t(i))):n.push(t(i));return{formErrors:n,fieldErrors:e}}get formErrors(){return this.flatten()}}Mt.create=r=>new Mt(r);const ge=(r,t)=>{let e;switch(r.code){case R.invalid_type:r.received===O.undefined?e="Required":e=`Expected ${r.expected}, received ${r.received}`;break;case R.invalid_literal:e=`Invalid literal value, expected ${JSON.stringify(r.expected,H.jsonStringifyReplacer)}`;break;case R.unrecognized_keys:e=`Unrecognized key(s) in object: ${H.joinValues(r.keys,", ")}`;break;case R.invalid_union:e="Invalid input";break;case R.invalid_union_discriminator:e=`Invalid discriminator value. Expected ${H.joinValues(r.options)}`;break;case R.invalid_enum_value:e=`Invalid enum value. Expected ${H.joinValues(r.options)}, received '${r.received}'`;break;case R.invalid_arguments:e="Invalid function arguments";break;case R.invalid_return_type:e="Invalid function return type";break;case R.invalid_date:e="Invalid date";break;case R.invalid_string:typeof r.validation=="object"?"includes"in r.validation?(e=`Invalid input: must include "${r.validation.includes}"`,typeof r.validation.position=="number"&&(e=`${e} at one or more positions greater than or equal to ${r.validation.position}`)):"startsWith"in r.validation?e=`Invalid input: must start with "${r.validation.startsWith}"`:"endsWith"in r.validation?e=`Invalid input: must end with "${r.validation.endsWith}"`:H.assertNever(r.validation):r.validation!=="regex"?e=`Invalid ${r.validation}`:e="Invalid";break;case R.too_small:r.type==="array"?e=`Array must contain ${r.exact?"exactly":r.inclusive?"at least":"more than"} ${r.minimum} element(s)`:r.type==="string"?e=`String must contain ${r.exact?"exactly":r.inclusive?"at least":"over"} ${r.minimum} character(s)`:r.type==="number"?e=`Number must be ${r.exact?"exactly equal to ":r.inclusive?"greater than or equal to ":"greater than "}${r.minimum}`:r.type==="date"?e=`Date must be ${r.exact?"exactly equal to ":r.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(r.minimum))}`:e="Invalid input";break;case R.too_big:r.type==="array"?e=`Array must contain ${r.exact?"exactly":r.inclusive?"at most":"less than"} ${r.maximum} element(s)`:r.type==="string"?e=`String must contain ${r.exact?"exactly":r.inclusive?"at most":"under"} ${r.maximum} character(s)`:r.type==="number"?e=`Number must be ${r.exact?"exactly":r.inclusive?"less than or equal to":"less than"} ${r.maximum}`:r.type==="bigint"?e=`BigInt must be ${r.exact?"exactly":r.inclusive?"less than or equal to":"less than"} ${r.maximum}`:r.type==="date"?e=`Date must be ${r.exact?"exactly":r.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(r.maximum))}`:e="Invalid input";break;case R.custom:e="Invalid input";break;case R.invalid_intersection_types:e="Intersection results could not be merged";break;case R.not_multiple_of:e=`Number must be a multiple of ${r.multipleOf}`;break;case R.not_finite:e="Number must be finite";break;default:e=t.defaultError,H.assertNever(r)}return{message:e}};let Kn=ge;function mo(r){Kn=r}function Ze(){return Kn}const $e=r=>{const{data:t,path:e,errorMaps:n,issueData:i}=r,s=[...e,...i.path||[]],a={...i,path:s};let o="";const c=n.filter(h=>!!h).slice().reverse();for(const h of c)o=h(a,{data:t,defaultError:o}).message;return{...i,path:s,message:i.message||o}},yo=[];function N(r,t){const e=$e({issueData:t,data:r.data,path:r.path,errorMaps:[r.common.contextualErrorMap,r.schemaErrorMap,Ze(),ge].filter(n=>!!n)});r.common.issues.push(e)}class at{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(t,e){const n=[];for(const i of e){if(i.status==="aborted")return j;i.status==="dirty"&&t.dirty(),n.push(i.value)}return{status:t.value,value:n}}static async mergeObjectAsync(t,e){const n=[];for(const i of e)n.push({key:await i.key,value:await i.value});return at.mergeObjectSync(t,n)}static mergeObjectSync(t,e){const n={};for(const i of e){const{key:s,value:a}=i;if(s.status==="aborted"||a.status==="aborted")return j;s.status==="dirty"&&t.dirty(),a.status==="dirty"&&t.dirty(),s.value!=="__proto__"&&(typeof a.value<"u"||i.alwaysSet)&&(n[s.value]=a.value)}return{status:t.value,value:n}}}const j=Object.freeze({status:"aborted"}),Qn=r=>({status:"dirty",value:r}),lt=r=>({status:"valid",value:r}),qr=r=>r.status==="aborted",Hr=r=>r.status==="dirty",me=r=>r.status==="valid",Xe=r=>typeof Promise<"u"&&r instanceof Promise;var L;(function(r){r.errToObj=t=>typeof t=="string"?{message:t}:t||{},r.toString=t=>typeof t=="string"?t:t?.message})(L||(L={}));class St{constructor(t,e,n,i){this._cachedPath=[],this.parent=t,this.data=e,this._path=n,this._key=i}get path(){return this._cachedPath.length||(this._key instanceof Array?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const ti=(r,t)=>{if(me(t))return{success:!0,data:t.value};if(!r.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const e=new Mt(r.common.issues);return this._error=e,this._error}}};function B(r){if(!r)return{};const{errorMap:t,invalid_type_error:e,required_error:n,description:i}=r;if(t&&(e||n))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return t?{errorMap:t,description:i}:{errorMap:(a,o)=>a.code!=="invalid_type"?{message:o.defaultError}:typeof o.data>"u"?{message:n??o.defaultError}:{message:e??o.defaultError},description:i}}class F{constructor(t){this.spa=this.safeParseAsync,this._def=t,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this)}get description(){return this._def.description}_getType(t){return Wt(t.data)}_getOrReturnCtx(t,e){return e||{common:t.parent.common,data:t.data,parsedType:Wt(t.data),schemaErrorMap:this._def.errorMap,path:t.path,parent:t.parent}}_processInputParams(t){return{status:new at,ctx:{common:t.parent.common,data:t.data,parsedType:Wt(t.data),schemaErrorMap:this._def.errorMap,path:t.path,parent:t.parent}}}_parseSync(t){const e=this._parse(t);if(Xe(e))throw new Error("Synchronous parse encountered promise.");return e}_parseAsync(t){const e=this._parse(t);return Promise.resolve(e)}parse(t,e){const n=this.safeParse(t,e);if(n.success)return n.data;throw n.error}safeParse(t,e){var n;const i={common:{issues:[],async:(n=e?.async)!==null&&n!==void 0?n:!1,contextualErrorMap:e?.errorMap},path:e?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:t,parsedType:Wt(t)},s=this._parseSync({data:t,path:i.path,parent:i});return ti(i,s)}async parseAsync(t,e){const n=await this.safeParseAsync(t,e);if(n.success)return n.data;throw n.error}async safeParseAsync(t,e){const n={common:{issues:[],contextualErrorMap:e?.errorMap,async:!0},path:e?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:t,parsedType:Wt(t)},i=this._parse({data:t,path:n.path,parent:n}),s=await(Xe(i)?i:Promise.resolve(i));return ti(n,s)}refine(t,e){const n=i=>typeof e=="string"||typeof e>"u"?{message:e}:typeof e=="function"?e(i):e;return this._refinement((i,s)=>{const a=t(i),o=()=>s.addIssue({code:R.custom,...n(i)});return typeof Promise<"u"&&a instanceof Promise?a.then(c=>c?!0:(o(),!1)):a?!0:(o(),!1)})}refinement(t,e){return this._refinement((n,i)=>t(n)?!0:(i.addIssue(typeof e=="function"?e(n,i):e),!1))}_refinement(t){return new Et({schema:this,typeName:D.ZodEffects,effect:{type:"refinement",refinement:t}})}superRefine(t){return this._refinement(t)}optional(){return Nt.create(this,this._def)}nullable(){return Yt.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return _t.create(this,this._def)}promise(){return re.create(this,this._def)}or(t){return Te.create([this,t],this._def)}and(t){return xe.create(this,t,this._def)}transform(t){return new Et({...B(this._def),schema:this,typeName:D.ZodEffects,effect:{type:"transform",transform:t}})}default(t){const e=typeof t=="function"?t:()=>t;return new Ie({...B(this._def),innerType:this,defaultValue:e,typeName:D.ZodDefault})}brand(){return new ri({typeName:D.ZodBranded,type:this,...B(this._def)})}catch(t){const e=typeof t=="function"?t:()=>t;return new Qe({...B(this._def),innerType:this,catchValue:e,typeName:D.ZodCatch})}describe(t){const e=this.constructor;return new e({...this._def,description:t})}pipe(t){return Se.create(this,t)}readonly(){return er.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const vo=/^c[^\s-]{8,}$/i,wo=/^[a-z][a-z0-9]*$/,To=/^[0-9A-HJKMNP-TV-Z]{26}$/,xo=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,Mo=/^(?!\.)(?!.*\.\.)([A-Z0-9_+-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,bo="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$";let Yr;const _o=/^(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))$/,Eo=/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,Io=r=>r.precision?r.offset?new RegExp(`^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}\\.\\d{${r.precision}}(([+-]\\d{2}(:?\\d{2})?)|Z)$`):new RegExp(`^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}\\.\\d{${r.precision}}Z$`):r.precision===0?r.offset?new RegExp("^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(([+-]\\d{2}(:?\\d{2})?)|Z)$"):new RegExp("^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}Z$"):r.offset?new RegExp("^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(\\.\\d+)?(([+-]\\d{2}(:?\\d{2})?)|Z)$"):new RegExp("^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(\\.\\d+)?Z$");function So(r,t){return!!((t==="v4"||!t)&&_o.test(r)||(t==="v6"||!t)&&Eo.test(r))}class bt extends F{_parse(t){if(this._def.coerce&&(t.data=String(t.data)),this._getType(t)!==O.string){const s=this._getOrReturnCtx(t);return N(s,{code:R.invalid_type,expected:O.string,received:s.parsedType}),j}const n=new at;let i;for(const s of this._def.checks)if(s.kind==="min")t.data.length<s.value&&(i=this._getOrReturnCtx(t,i),N(i,{code:R.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),n.dirty());else if(s.kind==="max")t.data.length>s.value&&(i=this._getOrReturnCtx(t,i),N(i,{code:R.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),n.dirty());else if(s.kind==="length"){const a=t.data.length>s.value,o=t.data.length<s.value;(a||o)&&(i=this._getOrReturnCtx(t,i),a?N(i,{code:R.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}):o&&N(i,{code:R.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}),n.dirty())}else if(s.kind==="email")Mo.test(t.data)||(i=this._getOrReturnCtx(t,i),N(i,{validation:"email",code:R.invalid_string,message:s.message}),n.dirty());else if(s.kind==="emoji")Yr||(Yr=new RegExp(bo,"u")),Yr.test(t.data)||(i=this._getOrReturnCtx(t,i),N(i,{validation:"emoji",code:R.invalid_string,message:s.message}),n.dirty());else if(s.kind==="uuid")xo.test(t.data)||(i=this._getOrReturnCtx(t,i),N(i,{validation:"uuid",code:R.invalid_string,message:s.message}),n.dirty());else if(s.kind==="cuid")vo.test(t.data)||(i=this._getOrReturnCtx(t,i),N(i,{validation:"cuid",code:R.invalid_string,message:s.message}),n.dirty());else if(s.kind==="cuid2")wo.test(t.data)||(i=this._getOrReturnCtx(t,i),N(i,{validation:"cuid2",code:R.invalid_string,message:s.message}),n.dirty());else if(s.kind==="ulid")To.test(t.data)||(i=this._getOrReturnCtx(t,i),N(i,{validation:"ulid",code:R.invalid_string,message:s.message}),n.dirty());else if(s.kind==="url")try{new URL(t.data)}catch{i=this._getOrReturnCtx(t,i),N(i,{validation:"url",code:R.invalid_string,message:s.message}),n.dirty()}else s.kind==="regex"?(s.regex.lastIndex=0,s.regex.test(t.data)||(i=this._getOrReturnCtx(t,i),N(i,{validation:"regex",code:R.invalid_string,message:s.message}),n.dirty())):s.kind==="trim"?t.data=t.data.trim():s.kind==="includes"?t.data.includes(s.value,s.position)||(i=this._getOrReturnCtx(t,i),N(i,{code:R.invalid_string,validation:{includes:s.value,position:s.position},message:s.message}),n.dirty()):s.kind==="toLowerCase"?t.data=t.data.toLowerCase():s.kind==="toUpperCase"?t.data=t.data.toUpperCase():s.kind==="startsWith"?t.data.startsWith(s.value)||(i=this._getOrReturnCtx(t,i),N(i,{code:R.invalid_string,validation:{startsWith:s.value},message:s.message}),n.dirty()):s.kind==="endsWith"?t.data.endsWith(s.value)||(i=this._getOrReturnCtx(t,i),N(i,{code:R.invalid_string,validation:{endsWith:s.value},message:s.message}),n.dirty()):s.kind==="datetime"?Io(s).test(t.data)||(i=this._getOrReturnCtx(t,i),N(i,{code:R.invalid_string,validation:"datetime",message:s.message}),n.dirty()):s.kind==="ip"?So(t.data,s.version)||(i=this._getOrReturnCtx(t,i),N(i,{validation:"ip",code:R.invalid_string,message:s.message}),n.dirty()):H.assertNever(s);return{status:n.value,value:t.data}}_regex(t,e,n){return this.refinement(i=>t.test(i),{validation:e,code:R.invalid_string,...L.errToObj(n)})}_addCheck(t){return new bt({...this._def,checks:[...this._def.checks,t]})}email(t){return this._addCheck({kind:"email",...L.errToObj(t)})}url(t){return this._addCheck({kind:"url",...L.errToObj(t)})}emoji(t){return this._addCheck({kind:"emoji",...L.errToObj(t)})}uuid(t){return this._addCheck({kind:"uuid",...L.errToObj(t)})}cuid(t){return this._addCheck({kind:"cuid",...L.errToObj(t)})}cuid2(t){return this._addCheck({kind:"cuid2",...L.errToObj(t)})}ulid(t){return this._addCheck({kind:"ulid",...L.errToObj(t)})}ip(t){return this._addCheck({kind:"ip",...L.errToObj(t)})}datetime(t){var e;return typeof t=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,message:t}):this._addCheck({kind:"datetime",precision:typeof t?.precision>"u"?null:t?.precision,offset:(e=t?.offset)!==null&&e!==void 0?e:!1,...L.errToObj(t?.message)})}regex(t,e){return this._addCheck({kind:"regex",regex:t,...L.errToObj(e)})}includes(t,e){return this._addCheck({kind:"includes",value:t,position:e?.position,...L.errToObj(e?.message)})}startsWith(t,e){return this._addCheck({kind:"startsWith",value:t,...L.errToObj(e)})}endsWith(t,e){return this._addCheck({kind:"endsWith",value:t,...L.errToObj(e)})}min(t,e){return this._addCheck({kind:"min",value:t,...L.errToObj(e)})}max(t,e){return this._addCheck({kind:"max",value:t,...L.errToObj(e)})}length(t,e){return this._addCheck({kind:"length",value:t,...L.errToObj(e)})}nonempty(t){return this.min(1,L.errToObj(t))}trim(){return new bt({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new bt({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new bt({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(t=>t.kind==="datetime")}get isEmail(){return!!this._def.checks.find(t=>t.kind==="email")}get isURL(){return!!this._def.checks.find(t=>t.kind==="url")}get isEmoji(){return!!this._def.checks.find(t=>t.kind==="emoji")}get isUUID(){return!!this._def.checks.find(t=>t.kind==="uuid")}get isCUID(){return!!this._def.checks.find(t=>t.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(t=>t.kind==="cuid2")}get isULID(){return!!this._def.checks.find(t=>t.kind==="ulid")}get isIP(){return!!this._def.checks.find(t=>t.kind==="ip")}get minLength(){let t=null;for(const e of this._def.checks)e.kind==="min"&&(t===null||e.value>t)&&(t=e.value);return t}get maxLength(){let t=null;for(const e of this._def.checks)e.kind==="max"&&(t===null||e.value<t)&&(t=e.value);return t}}bt.create=r=>{var t;return new bt({checks:[],typeName:D.ZodString,coerce:(t=r?.coerce)!==null&&t!==void 0?t:!1,...B(r)})};function Ao(r,t){const e=(r.toString().split(".")[1]||"").length,n=(t.toString().split(".")[1]||"").length,i=e>n?e:n,s=parseInt(r.toFixed(i).replace(".","")),a=parseInt(t.toFixed(i).replace(".",""));return s%a/Math.pow(10,i)}class Ut extends F{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(t){if(this._def.coerce&&(t.data=Number(t.data)),this._getType(t)!==O.number){const s=this._getOrReturnCtx(t);return N(s,{code:R.invalid_type,expected:O.number,received:s.parsedType}),j}let n;const i=new at;for(const s of this._def.checks)s.kind==="int"?H.isInteger(t.data)||(n=this._getOrReturnCtx(t,n),N(n,{code:R.invalid_type,expected:"integer",received:"float",message:s.message}),i.dirty()):s.kind==="min"?(s.inclusive?t.data<s.value:t.data<=s.value)&&(n=this._getOrReturnCtx(t,n),N(n,{code:R.too_small,minimum:s.value,type:"number",inclusive:s.inclusive,exact:!1,message:s.message}),i.dirty()):s.kind==="max"?(s.inclusive?t.data>s.value:t.data>=s.value)&&(n=this._getOrReturnCtx(t,n),N(n,{code:R.too_big,maximum:s.value,type:"number",inclusive:s.inclusive,exact:!1,message:s.message}),i.dirty()):s.kind==="multipleOf"?Ao(t.data,s.value)!==0&&(n=this._getOrReturnCtx(t,n),N(n,{code:R.not_multiple_of,multipleOf:s.value,message:s.message}),i.dirty()):s.kind==="finite"?Number.isFinite(t.data)||(n=this._getOrReturnCtx(t,n),N(n,{code:R.not_finite,message:s.message}),i.dirty()):H.assertNever(s);return{status:i.value,value:t.data}}gte(t,e){return this.setLimit("min",t,!0,L.toString(e))}gt(t,e){return this.setLimit("min",t,!1,L.toString(e))}lte(t,e){return this.setLimit("max",t,!0,L.toString(e))}lt(t,e){return this.setLimit("max",t,!1,L.toString(e))}setLimit(t,e,n,i){return new Ut({...this._def,checks:[...this._def.checks,{kind:t,value:e,inclusive:n,message:L.toString(i)}]})}_addCheck(t){return new Ut({...this._def,checks:[...this._def.checks,t]})}int(t){return this._addCheck({kind:"int",message:L.toString(t)})}positive(t){return this._addCheck({kind:"min",value:0,inclusive:!1,message:L.toString(t)})}negative(t){return this._addCheck({kind:"max",value:0,inclusive:!1,message:L.toString(t)})}nonpositive(t){return this._addCheck({kind:"max",value:0,inclusive:!0,message:L.toString(t)})}nonnegative(t){return this._addCheck({kind:"min",value:0,inclusive:!0,message:L.toString(t)})}multipleOf(t,e){return this._addCheck({kind:"multipleOf",value:t,message:L.toString(e)})}finite(t){return this._addCheck({kind:"finite",message:L.toString(t)})}safe(t){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:L.toString(t)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:L.toString(t)})}get minValue(){let t=null;for(const e of this._def.checks)e.kind==="min"&&(t===null||e.value>t)&&(t=e.value);return t}get maxValue(){let t=null;for(const e of this._def.checks)e.kind==="max"&&(t===null||e.value<t)&&(t=e.value);return t}get isInt(){return!!this._def.checks.find(t=>t.kind==="int"||t.kind==="multipleOf"&&H.isInteger(t.value))}get isFinite(){let t=null,e=null;for(const n of this._def.checks){if(n.kind==="finite"||n.kind==="int"||n.kind==="multipleOf")return!0;n.kind==="min"?(e===null||n.value>e)&&(e=n.value):n.kind==="max"&&(t===null||n.value<t)&&(t=n.value)}return Number.isFinite(e)&&Number.isFinite(t)}}Ut.create=r=>new Ut({checks:[],typeName:D.ZodNumber,coerce:r?.coerce||!1,...B(r)});class Vt extends F{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(t){if(this._def.coerce&&(t.data=BigInt(t.data)),this._getType(t)!==O.bigint){const s=this._getOrReturnCtx(t);return N(s,{code:R.invalid_type,expected:O.bigint,received:s.parsedType}),j}let n;const i=new at;for(const s of this._def.checks)s.kind==="min"?(s.inclusive?t.data<s.value:t.data<=s.value)&&(n=this._getOrReturnCtx(t,n),N(n,{code:R.too_small,type:"bigint",minimum:s.value,inclusive:s.inclusive,message:s.message}),i.dirty()):s.kind==="max"?(s.inclusive?t.data>s.value:t.data>=s.value)&&(n=this._getOrReturnCtx(t,n),N(n,{code:R.too_big,type:"bigint",maximum:s.value,inclusive:s.inclusive,message:s.message}),i.dirty()):s.kind==="multipleOf"?t.data%s.value!==BigInt(0)&&(n=this._getOrReturnCtx(t,n),N(n,{code:R.not_multiple_of,multipleOf:s.value,message:s.message}),i.dirty()):H.assertNever(s);return{status:i.value,value:t.data}}gte(t,e){return this.setLimit("min",t,!0,L.toString(e))}gt(t,e){return this.setLimit("min",t,!1,L.toString(e))}lte(t,e){return this.setLimit("max",t,!0,L.toString(e))}lt(t,e){return this.setLimit("max",t,!1,L.toString(e))}setLimit(t,e,n,i){return new Vt({...this._def,checks:[...this._def.checks,{kind:t,value:e,inclusive:n,message:L.toString(i)}]})}_addCheck(t){return new Vt({...this._def,checks:[...this._def.checks,t]})}positive(t){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:L.toString(t)})}negative(t){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:L.toString(t)})}nonpositive(t){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:L.toString(t)})}nonnegative(t){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:L.toString(t)})}multipleOf(t,e){return this._addCheck({kind:"multipleOf",value:t,message:L.toString(e)})}get minValue(){let t=null;for(const e of this._def.checks)e.kind==="min"&&(t===null||e.value>t)&&(t=e.value);return t}get maxValue(){let t=null;for(const e of this._def.checks)e.kind==="max"&&(t===null||e.value<t)&&(t=e.value);return t}}Vt.create=r=>{var t;return new Vt({checks:[],typeName:D.ZodBigInt,coerce:(t=r?.coerce)!==null&&t!==void 0?t:!1,...B(r)})};class ye extends F{_parse(t){if(this._def.coerce&&(t.data=!!t.data),this._getType(t)!==O.boolean){const n=this._getOrReturnCtx(t);return N(n,{code:R.invalid_type,expected:O.boolean,received:n.parsedType}),j}return lt(t.data)}}ye.create=r=>new ye({typeName:D.ZodBoolean,coerce:r?.coerce||!1,...B(r)});class Xt extends F{_parse(t){if(this._def.coerce&&(t.data=new Date(t.data)),this._getType(t)!==O.date){const s=this._getOrReturnCtx(t);return N(s,{code:R.invalid_type,expected:O.date,received:s.parsedType}),j}if(isNaN(t.data.getTime())){const s=this._getOrReturnCtx(t);return N(s,{code:R.invalid_date}),j}const n=new at;let i;for(const s of this._def.checks)s.kind==="min"?t.data.getTime()<s.value&&(i=this._getOrReturnCtx(t,i),N(i,{code:R.too_small,message:s.message,inclusive:!0,exact:!1,minimum:s.value,type:"date"}),n.dirty()):s.kind==="max"?t.data.getTime()>s.value&&(i=this._getOrReturnCtx(t,i),N(i,{code:R.too_big,message:s.message,inclusive:!0,exact:!1,maximum:s.value,type:"date"}),n.dirty()):H.assertNever(s);return{status:n.value,value:new Date(t.data.getTime())}}_addCheck(t){return new Xt({...this._def,checks:[...this._def.checks,t]})}min(t,e){return this._addCheck({kind:"min",value:t.getTime(),message:L.toString(e)})}max(t,e){return this._addCheck({kind:"max",value:t.getTime(),message:L.toString(e)})}get minDate(){let t=null;for(const e of this._def.checks)e.kind==="min"&&(t===null||e.value>t)&&(t=e.value);return t!=null?new Date(t):null}get maxDate(){let t=null;for(const e of this._def.checks)e.kind==="max"&&(t===null||e.value<t)&&(t=e.value);return t!=null?new Date(t):null}}Xt.create=r=>new Xt({checks:[],coerce:r?.coerce||!1,typeName:D.ZodDate,...B(r)});class qe extends F{_parse(t){if(this._getType(t)!==O.symbol){const n=this._getOrReturnCtx(t);return N(n,{code:R.invalid_type,expected:O.symbol,received:n.parsedType}),j}return lt(t.data)}}qe.create=r=>new qe({typeName:D.ZodSymbol,...B(r)});class ve extends F{_parse(t){if(this._getType(t)!==O.undefined){const n=this._getOrReturnCtx(t);return N(n,{code:R.invalid_type,expected:O.undefined,received:n.parsedType}),j}return lt(t.data)}}ve.create=r=>new ve({typeName:D.ZodUndefined,...B(r)});class we extends F{_parse(t){if(this._getType(t)!==O.null){const n=this._getOrReturnCtx(t);return N(n,{code:R.invalid_type,expected:O.null,received:n.parsedType}),j}return lt(t.data)}}we.create=r=>new we({typeName:D.ZodNull,...B(r)});class Qt extends F{constructor(){super(...arguments),this._any=!0}_parse(t){return lt(t.data)}}Qt.create=r=>new Qt({typeName:D.ZodAny,...B(r)});class qt extends F{constructor(){super(...arguments),this._unknown=!0}_parse(t){return lt(t.data)}}qt.create=r=>new qt({typeName:D.ZodUnknown,...B(r)});class Ot extends F{_parse(t){const e=this._getOrReturnCtx(t);return N(e,{code:R.invalid_type,expected:O.never,received:e.parsedType}),j}}Ot.create=r=>new Ot({typeName:D.ZodNever,...B(r)});class He extends F{_parse(t){if(this._getType(t)!==O.undefined){const n=this._getOrReturnCtx(t);return N(n,{code:R.invalid_type,expected:O.void,received:n.parsedType}),j}return lt(t.data)}}He.create=r=>new He({typeName:D.ZodVoid,...B(r)});class _t extends F{_parse(t){const{ctx:e,status:n}=this._processInputParams(t),i=this._def;if(e.parsedType!==O.array)return N(e,{code:R.invalid_type,expected:O.array,received:e.parsedType}),j;if(i.exactLength!==null){const a=e.data.length>i.exactLength.value,o=e.data.length<i.exactLength.value;(a||o)&&(N(e,{code:a?R.too_big:R.too_small,minimum:o?i.exactLength.value:void 0,maximum:a?i.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:i.exactLength.message}),n.dirty())}if(i.minLength!==null&&e.data.length<i.minLength.value&&(N(e,{code:R.too_small,minimum:i.minLength.value,type:"array",inclusive:!0,exact:!1,message:i.minLength.message}),n.dirty()),i.maxLength!==null&&e.data.length>i.maxLength.value&&(N(e,{code:R.too_big,maximum:i.maxLength.value,type:"array",inclusive:!0,exact:!1,message:i.maxLength.message}),n.dirty()),e.common.async)return Promise.all([...e.data].map((a,o)=>i.type._parseAsync(new St(e,a,e.path,o)))).then(a=>at.mergeArray(n,a));const s=[...e.data].map((a,o)=>i.type._parseSync(new St(e,a,e.path,o)));return at.mergeArray(n,s)}get element(){return this._def.type}min(t,e){return new _t({...this._def,minLength:{value:t,message:L.toString(e)}})}max(t,e){return new _t({...this._def,maxLength:{value:t,message:L.toString(e)}})}length(t,e){return new _t({...this._def,exactLength:{value:t,message:L.toString(e)}})}nonempty(t){return this.min(1,t)}}_t.create=(r,t)=>new _t({type:r,minLength:null,maxLength:null,exactLength:null,typeName:D.ZodArray,...B(t)});function te(r){if(r instanceof Q){const t={};for(const e in r.shape){const n=r.shape[e];t[e]=Nt.create(te(n))}return new Q({...r._def,shape:()=>t})}else return r instanceof _t?new _t({...r._def,type:te(r.element)}):r instanceof Nt?Nt.create(te(r.unwrap())):r instanceof Yt?Yt.create(te(r.unwrap())):r instanceof At?At.create(r.items.map(t=>te(t))):r}class Q extends F{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;const t=this._def.shape(),e=H.objectKeys(t);return this._cached={shape:t,keys:e}}_parse(t){if(this._getType(t)!==O.object){const h=this._getOrReturnCtx(t);return N(h,{code:R.invalid_type,expected:O.object,received:h.parsedType}),j}const{status:n,ctx:i}=this._processInputParams(t),{shape:s,keys:a}=this._getCached(),o=[];if(!(this._def.catchall instanceof Ot&&this._def.unknownKeys==="strip"))for(const h in i.data)a.includes(h)||o.push(h);const c=[];for(const h of a){const l=s[h],u=i.data[h];c.push({key:{status:"valid",value:h},value:l._parse(new St(i,u,i.path,h)),alwaysSet:h in i.data})}if(this._def.catchall instanceof Ot){const h=this._def.unknownKeys;if(h==="passthrough")for(const l of o)c.push({key:{status:"valid",value:l},value:{status:"valid",value:i.data[l]}});else if(h==="strict")o.length>0&&(N(i,{code:R.unrecognized_keys,keys:o}),n.dirty());else if(h!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const h=this._def.catchall;for(const l of o){const u=i.data[l];c.push({key:{status:"valid",value:l},value:h._parse(new St(i,u,i.path,l)),alwaysSet:l in i.data})}}return i.common.async?Promise.resolve().then(async()=>{const h=[];for(const l of c){const u=await l.key;h.push({key:u,value:await l.value,alwaysSet:l.alwaysSet})}return h}).then(h=>at.mergeObjectSync(n,h)):at.mergeObjectSync(n,c)}get shape(){return this._def.shape()}strict(t){return L.errToObj,new Q({...this._def,unknownKeys:"strict",...t!==void 0?{errorMap:(e,n)=>{var i,s,a,o;const c=(a=(s=(i=this._def).errorMap)===null||s===void 0?void 0:s.call(i,e,n).message)!==null&&a!==void 0?a:n.defaultError;return e.code==="unrecognized_keys"?{message:(o=L.errToObj(t).message)!==null&&o!==void 0?o:c}:{message:c}}}:{}})}strip(){return new Q({...this._def,unknownKeys:"strip"})}passthrough(){return new Q({...this._def,unknownKeys:"passthrough"})}extend(t){return new Q({...this._def,shape:()=>({...this._def.shape(),...t})})}merge(t){return new Q({unknownKeys:t._def.unknownKeys,catchall:t._def.catchall,shape:()=>({...this._def.shape(),...t._def.shape()}),typeName:D.ZodObject})}setKey(t,e){return this.augment({[t]:e})}catchall(t){return new Q({...this._def,catchall:t})}pick(t){const e={};return H.objectKeys(t).forEach(n=>{t[n]&&this.shape[n]&&(e[n]=this.shape[n])}),new Q({...this._def,shape:()=>e})}omit(t){const e={};return H.objectKeys(this.shape).forEach(n=>{t[n]||(e[n]=this.shape[n])}),new Q({...this._def,shape:()=>e})}deepPartial(){return te(this)}partial(t){const e={};return H.objectKeys(this.shape).forEach(n=>{const i=this.shape[n];t&&!t[n]?e[n]=i:e[n]=i.optional()}),new Q({...this._def,shape:()=>e})}required(t){const e={};return H.objectKeys(this.shape).forEach(n=>{if(t&&!t[n])e[n]=this.shape[n];else{let s=this.shape[n];for(;s instanceof Nt;)s=s._def.innerType;e[n]=s}}),new Q({...this._def,shape:()=>e})}keyof(){return ei(H.objectKeys(this.shape))}}Q.create=(r,t)=>new Q({shape:()=>r,unknownKeys:"strip",catchall:Ot.create(),typeName:D.ZodObject,...B(t)}),Q.strictCreate=(r,t)=>new Q({shape:()=>r,unknownKeys:"strict",catchall:Ot.create(),typeName:D.ZodObject,...B(t)}),Q.lazycreate=(r,t)=>new Q({shape:r,unknownKeys:"strip",catchall:Ot.create(),typeName:D.ZodObject,...B(t)});class Te extends F{_parse(t){const{ctx:e}=this._processInputParams(t),n=this._def.options;function i(s){for(const o of s)if(o.result.status==="valid")return o.result;for(const o of s)if(o.result.status==="dirty")return e.common.issues.push(...o.ctx.common.issues),o.result;const a=s.map(o=>new Mt(o.ctx.common.issues));return N(e,{code:R.invalid_union,unionErrors:a}),j}if(e.common.async)return Promise.all(n.map(async s=>{const a={...e,common:{...e.common,issues:[]},parent:null};return{result:await s._parseAsync({data:e.data,path:e.path,parent:a}),ctx:a}})).then(i);{let s;const a=[];for(const c of n){const h={...e,common:{...e.common,issues:[]},parent:null},l=c._parseSync({data:e.data,path:e.path,parent:h});if(l.status==="valid")return l;l.status==="dirty"&&!s&&(s={result:l,ctx:h}),h.common.issues.length&&a.push(h.common.issues)}if(s)return e.common.issues.push(...s.ctx.common.issues),s.result;const o=a.map(c=>new Mt(c));return N(e,{code:R.invalid_union,unionErrors:o}),j}}get options(){return this._def.options}}Te.create=(r,t)=>new Te({options:r,typeName:D.ZodUnion,...B(t)});const Ye=r=>r instanceof be?Ye(r.schema):r instanceof Et?Ye(r.innerType()):r instanceof _e?[r.value]:r instanceof zt?r.options:r instanceof Ee?Object.keys(r.enum):r instanceof Ie?Ye(r._def.innerType):r instanceof ve?[void 0]:r instanceof we?[null]:null;class Je extends F{_parse(t){const{ctx:e}=this._processInputParams(t);if(e.parsedType!==O.object)return N(e,{code:R.invalid_type,expected:O.object,received:e.parsedType}),j;const n=this.discriminator,i=e.data[n],s=this.optionsMap.get(i);return s?e.common.async?s._parseAsync({data:e.data,path:e.path,parent:e}):s._parseSync({data:e.data,path:e.path,parent:e}):(N(e,{code:R.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[n]}),j)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(t,e,n){const i=new Map;for(const s of e){const a=Ye(s.shape[t]);if(!a)throw new Error(`A discriminator value for key \`${t}\` could not be extracted from all schema options`);for(const o of a){if(i.has(o))throw new Error(`Discriminator property ${String(t)} has duplicate value ${String(o)}`);i.set(o,s)}}return new Je({typeName:D.ZodDiscriminatedUnion,discriminator:t,options:e,optionsMap:i,...B(n)})}}function Jr(r,t){const e=Wt(r),n=Wt(t);if(r===t)return{valid:!0,data:r};if(e===O.object&&n===O.object){const i=H.objectKeys(t),s=H.objectKeys(r).filter(o=>i.indexOf(o)!==-1),a={...r,...t};for(const o of s){const c=Jr(r[o],t[o]);if(!c.valid)return{valid:!1};a[o]=c.data}return{valid:!0,data:a}}else if(e===O.array&&n===O.array){if(r.length!==t.length)return{valid:!1};const i=[];for(let s=0;s<r.length;s++){const a=r[s],o=t[s],c=Jr(a,o);if(!c.valid)return{valid:!1};i.push(c.data)}return{valid:!0,data:i}}else return e===O.date&&n===O.date&&+r==+t?{valid:!0,data:r}:{valid:!1}}class xe extends F{_parse(t){const{status:e,ctx:n}=this._processInputParams(t),i=(s,a)=>{if(qr(s)||qr(a))return j;const o=Jr(s.value,a.value);return o.valid?((Hr(s)||Hr(a))&&e.dirty(),{status:e.value,value:o.data}):(N(n,{code:R.invalid_intersection_types}),j)};return n.common.async?Promise.all([this._def.left._parseAsync({data:n.data,path:n.path,parent:n}),this._def.right._parseAsync({data:n.data,path:n.path,parent:n})]).then(([s,a])=>i(s,a)):i(this._def.left._parseSync({data:n.data,path:n.path,parent:n}),this._def.right._parseSync({data:n.data,path:n.path,parent:n}))}}xe.create=(r,t,e)=>new xe({left:r,right:t,typeName:D.ZodIntersection,...B(e)});class At extends F{_parse(t){const{status:e,ctx:n}=this._processInputParams(t);if(n.parsedType!==O.array)return N(n,{code:R.invalid_type,expected:O.array,received:n.parsedType}),j;if(n.data.length<this._def.items.length)return N(n,{code:R.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),j;!this._def.rest&&n.data.length>this._def.items.length&&(N(n,{code:R.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),e.dirty());const s=[...n.data].map((a,o)=>{const c=this._def.items[o]||this._def.rest;return c?c._parse(new St(n,a,n.path,o)):null}).filter(a=>!!a);return n.common.async?Promise.all(s).then(a=>at.mergeArray(e,a)):at.mergeArray(e,s)}get items(){return this._def.items}rest(t){return new At({...this._def,rest:t})}}At.create=(r,t)=>{if(!Array.isArray(r))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new At({items:r,typeName:D.ZodTuple,rest:null,...B(t)})};class Me extends F{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(t){const{status:e,ctx:n}=this._processInputParams(t);if(n.parsedType!==O.object)return N(n,{code:R.invalid_type,expected:O.object,received:n.parsedType}),j;const i=[],s=this._def.keyType,a=this._def.valueType;for(const o in n.data)i.push({key:s._parse(new St(n,o,n.path,o)),value:a._parse(new St(n,n.data[o],n.path,o))});return n.common.async?at.mergeObjectAsync(e,i):at.mergeObjectSync(e,i)}get element(){return this._def.valueType}static create(t,e,n){return e instanceof F?new Me({keyType:t,valueType:e,typeName:D.ZodRecord,...B(n)}):new Me({keyType:bt.create(),valueType:t,typeName:D.ZodRecord,...B(e)})}}class Ke extends F{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(t){const{status:e,ctx:n}=this._processInputParams(t);if(n.parsedType!==O.map)return N(n,{code:R.invalid_type,expected:O.map,received:n.parsedType}),j;const i=this._def.keyType,s=this._def.valueType,a=[...n.data.entries()].map(([o,c],h)=>({key:i._parse(new St(n,o,n.path,[h,"key"])),value:s._parse(new St(n,c,n.path,[h,"value"]))}));if(n.common.async){const o=new Map;return Promise.resolve().then(async()=>{for(const c of a){const h=await c.key,l=await c.value;if(h.status==="aborted"||l.status==="aborted")return j;(h.status==="dirty"||l.status==="dirty")&&e.dirty(),o.set(h.value,l.value)}return{status:e.value,value:o}})}else{const o=new Map;for(const c of a){const h=c.key,l=c.value;if(h.status==="aborted"||l.status==="aborted")return j;(h.status==="dirty"||l.status==="dirty")&&e.dirty(),o.set(h.value,l.value)}return{status:e.value,value:o}}}}Ke.create=(r,t,e)=>new Ke({valueType:t,keyType:r,typeName:D.ZodMap,...B(e)});class Ht extends F{_parse(t){const{status:e,ctx:n}=this._processInputParams(t);if(n.parsedType!==O.set)return N(n,{code:R.invalid_type,expected:O.set,received:n.parsedType}),j;const i=this._def;i.minSize!==null&&n.data.size<i.minSize.value&&(N(n,{code:R.too_small,minimum:i.minSize.value,type:"set",inclusive:!0,exact:!1,message:i.minSize.message}),e.dirty()),i.maxSize!==null&&n.data.size>i.maxSize.value&&(N(n,{code:R.too_big,maximum:i.maxSize.value,type:"set",inclusive:!0,exact:!1,message:i.maxSize.message}),e.dirty());const s=this._def.valueType;function a(c){const h=new Set;for(const l of c){if(l.status==="aborted")return j;l.status==="dirty"&&e.dirty(),h.add(l.value)}return{status:e.value,value:h}}const o=[...n.data.values()].map((c,h)=>s._parse(new St(n,c,n.path,h)));return n.common.async?Promise.all(o).then(c=>a(c)):a(o)}min(t,e){return new Ht({...this._def,minSize:{value:t,message:L.toString(e)}})}max(t,e){return new Ht({...this._def,maxSize:{value:t,message:L.toString(e)}})}size(t,e){return this.min(t,e).max(t,e)}nonempty(t){return this.min(1,t)}}Ht.create=(r,t)=>new Ht({valueType:r,minSize:null,maxSize:null,typeName:D.ZodSet,...B(t)});class ee extends F{constructor(){super(...arguments),this.validate=this.implement}_parse(t){const{ctx:e}=this._processInputParams(t);if(e.parsedType!==O.function)return N(e,{code:R.invalid_type,expected:O.function,received:e.parsedType}),j;function n(o,c){return $e({data:o,path:e.path,errorMaps:[e.common.contextualErrorMap,e.schemaErrorMap,Ze(),ge].filter(h=>!!h),issueData:{code:R.invalid_arguments,argumentsError:c}})}function i(o,c){return $e({data:o,path:e.path,errorMaps:[e.common.contextualErrorMap,e.schemaErrorMap,Ze(),ge].filter(h=>!!h),issueData:{code:R.invalid_return_type,returnTypeError:c}})}const s={errorMap:e.common.contextualErrorMap},a=e.data;if(this._def.returns instanceof re){const o=this;return lt(async function(...c){const h=new Mt([]),l=await o._def.args.parseAsync(c,s).catch(v=>{throw h.addIssue(n(c,v)),h}),u=await Reflect.apply(a,this,l);return await o._def.returns._def.type.parseAsync(u,s).catch(v=>{throw h.addIssue(i(u,v)),h})})}else{const o=this;return lt(function(...c){const h=o._def.args.safeParse(c,s);if(!h.success)throw new Mt([n(c,h.error)]);const l=Reflect.apply(a,this,h.data),u=o._def.returns.safeParse(l,s);if(!u.success)throw new Mt([i(l,u.error)]);return u.data})}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...t){return new ee({...this._def,args:At.create(t).rest(qt.create())})}returns(t){return new ee({...this._def,returns:t})}implement(t){return this.parse(t)}strictImplement(t){return this.parse(t)}static create(t,e,n){return new ee({args:t||At.create([]).rest(qt.create()),returns:e||qt.create(),typeName:D.ZodFunction,...B(n)})}}class be extends F{get schema(){return this._def.getter()}_parse(t){const{ctx:e}=this._processInputParams(t);return this._def.getter()._parse({data:e.data,path:e.path,parent:e})}}be.create=(r,t)=>new be({getter:r,typeName:D.ZodLazy,...B(t)});class _e extends F{_parse(t){if(t.data!==this._def.value){const e=this._getOrReturnCtx(t);return N(e,{received:e.data,code:R.invalid_literal,expected:this._def.value}),j}return{status:"valid",value:t.data}}get value(){return this._def.value}}_e.create=(r,t)=>new _e({value:r,typeName:D.ZodLiteral,...B(t)});function ei(r,t){return new zt({values:r,typeName:D.ZodEnum,...B(t)})}class zt extends F{_parse(t){if(typeof t.data!="string"){const e=this._getOrReturnCtx(t),n=this._def.values;return N(e,{expected:H.joinValues(n),received:e.parsedType,code:R.invalid_type}),j}if(this._def.values.indexOf(t.data)===-1){const e=this._getOrReturnCtx(t),n=this._def.values;return N(e,{received:e.data,code:R.invalid_enum_value,options:n}),j}return lt(t.data)}get options(){return this._def.values}get enum(){const t={};for(const e of this._def.values)t[e]=e;return t}get Values(){const t={};for(const e of this._def.values)t[e]=e;return t}get Enum(){const t={};for(const e of this._def.values)t[e]=e;return t}extract(t){return zt.create(t)}exclude(t){return zt.create(this.options.filter(e=>!t.includes(e)))}}zt.create=ei;class Ee extends F{_parse(t){const e=H.getValidEnumValues(this._def.values),n=this._getOrReturnCtx(t);if(n.parsedType!==O.string&&n.parsedType!==O.number){const i=H.objectValues(e);return N(n,{expected:H.joinValues(i),received:n.parsedType,code:R.invalid_type}),j}if(e.indexOf(t.data)===-1){const i=H.objectValues(e);return N(n,{received:n.data,code:R.invalid_enum_value,options:i}),j}return lt(t.data)}get enum(){return this._def.values}}Ee.create=(r,t)=>new Ee({values:r,typeName:D.ZodNativeEnum,...B(t)});class re extends F{unwrap(){return this._def.type}_parse(t){const{ctx:e}=this._processInputParams(t);if(e.parsedType!==O.promise&&e.common.async===!1)return N(e,{code:R.invalid_type,expected:O.promise,received:e.parsedType}),j;const n=e.parsedType===O.promise?e.data:Promise.resolve(e.data);return lt(n.then(i=>this._def.type.parseAsync(i,{path:e.path,errorMap:e.common.contextualErrorMap})))}}re.create=(r,t)=>new re({type:r,typeName:D.ZodPromise,...B(t)});class Et extends F{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===D.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(t){const{status:e,ctx:n}=this._processInputParams(t),i=this._def.effect||null,s={addIssue:a=>{N(n,a),a.fatal?e.abort():e.dirty()},get path(){return n.path}};if(s.addIssue=s.addIssue.bind(s),i.type==="preprocess"){const a=i.transform(n.data,s);return n.common.issues.length?{status:"dirty",value:n.data}:n.common.async?Promise.resolve(a).then(o=>this._def.schema._parseAsync({data:o,path:n.path,parent:n})):this._def.schema._parseSync({data:a,path:n.path,parent:n})}if(i.type==="refinement"){const a=o=>{const c=i.refinement(o,s);if(n.common.async)return Promise.resolve(c);if(c instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return o};if(n.common.async===!1){const o=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});return o.status==="aborted"?j:(o.status==="dirty"&&e.dirty(),a(o.value),{status:e.value,value:o.value})}else return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(o=>o.status==="aborted"?j:(o.status==="dirty"&&e.dirty(),a(o.value).then(()=>({status:e.value,value:o.value}))))}if(i.type==="transform")if(n.common.async===!1){const a=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});if(!me(a))return a;const o=i.transform(a.value,s);if(o instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:e.value,value:o}}else return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(a=>me(a)?Promise.resolve(i.transform(a.value,s)).then(o=>({status:e.value,value:o})):a);H.assertNever(i)}}Et.create=(r,t,e)=>new Et({schema:r,typeName:D.ZodEffects,effect:t,...B(e)}),Et.createWithPreprocess=(r,t,e)=>new Et({schema:t,effect:{type:"preprocess",transform:r},typeName:D.ZodEffects,...B(e)});class Nt extends F{_parse(t){return this._getType(t)===O.undefined?lt(void 0):this._def.innerType._parse(t)}unwrap(){return this._def.innerType}}Nt.create=(r,t)=>new Nt({innerType:r,typeName:D.ZodOptional,...B(t)});class Yt extends F{_parse(t){return this._getType(t)===O.null?lt(null):this._def.innerType._parse(t)}unwrap(){return this._def.innerType}}Yt.create=(r,t)=>new Yt({innerType:r,typeName:D.ZodNullable,...B(t)});class Ie extends F{_parse(t){const{ctx:e}=this._processInputParams(t);let n=e.data;return e.parsedType===O.undefined&&(n=this._def.defaultValue()),this._def.innerType._parse({data:n,path:e.path,parent:e})}removeDefault(){return this._def.innerType}}Ie.create=(r,t)=>new Ie({innerType:r,typeName:D.ZodDefault,defaultValue:typeof t.default=="function"?t.default:()=>t.default,...B(t)});class Qe extends F{_parse(t){const{ctx:e}=this._processInputParams(t),n={...e,common:{...e.common,issues:[]}},i=this._def.innerType._parse({data:n.data,path:n.path,parent:{...n}});return Xe(i)?i.then(s=>({status:"valid",value:s.status==="valid"?s.value:this._def.catchValue({get error(){return new Mt(n.common.issues)},input:n.data})})):{status:"valid",value:i.status==="valid"?i.value:this._def.catchValue({get error(){return new Mt(n.common.issues)},input:n.data})}}removeCatch(){return this._def.innerType}}Qe.create=(r,t)=>new Qe({innerType:r,typeName:D.ZodCatch,catchValue:typeof t.catch=="function"?t.catch:()=>t.catch,...B(t)});class tr extends F{_parse(t){if(this._getType(t)!==O.nan){const n=this._getOrReturnCtx(t);return N(n,{code:R.invalid_type,expected:O.nan,received:n.parsedType}),j}return{status:"valid",value:t.data}}}tr.create=r=>new tr({typeName:D.ZodNaN,...B(r)});const Ro=Symbol("zod_brand");class ri extends F{_parse(t){const{ctx:e}=this._processInputParams(t),n=e.data;return this._def.type._parse({data:n,path:e.path,parent:e})}unwrap(){return this._def.type}}class Se extends F{_parse(t){const{status:e,ctx:n}=this._processInputParams(t);if(n.common.async)return(async()=>{const s=await this._def.in._parseAsync({data:n.data,path:n.path,parent:n});return s.status==="aborted"?j:s.status==="dirty"?(e.dirty(),Qn(s.value)):this._def.out._parseAsync({data:s.value,path:n.path,parent:n})})();{const i=this._def.in._parseSync({data:n.data,path:n.path,parent:n});return i.status==="aborted"?j:i.status==="dirty"?(e.dirty(),{status:"dirty",value:i.value}):this._def.out._parseSync({data:i.value,path:n.path,parent:n})}}static create(t,e){return new Se({in:t,out:e,typeName:D.ZodPipeline})}}class er extends F{_parse(t){const e=this._def.innerType._parse(t);return me(e)&&(e.value=Object.freeze(e.value)),e}}er.create=(r,t)=>new er({innerType:r,typeName:D.ZodReadonly,...B(t)});const ni=(r,t={},e)=>r?Qt.create().superRefine((n,i)=>{var s,a;if(!r(n)){const o=typeof t=="function"?t(n):typeof t=="string"?{message:t}:t,c=(a=(s=o.fatal)!==null&&s!==void 0?s:e)!==null&&a!==void 0?a:!0,h=typeof o=="string"?{message:o}:o;i.addIssue({code:"custom",...h,fatal:c})}}):Qt.create(),Co={object:Q.lazycreate};var D;(function(r){r.ZodString="ZodString",r.ZodNumber="ZodNumber",r.ZodNaN="ZodNaN",r.ZodBigInt="ZodBigInt",r.ZodBoolean="ZodBoolean",r.ZodDate="ZodDate",r.ZodSymbol="ZodSymbol",r.ZodUndefined="ZodUndefined",r.ZodNull="ZodNull",r.ZodAny="ZodAny",r.ZodUnknown="ZodUnknown",r.ZodNever="ZodNever",r.ZodVoid="ZodVoid",r.ZodArray="ZodArray",r.ZodObject="ZodObject",r.ZodUnion="ZodUnion",r.ZodDiscriminatedUnion="ZodDiscriminatedUnion",r.ZodIntersection="ZodIntersection",r.ZodTuple="ZodTuple",r.ZodRecord="ZodRecord",r.ZodMap="ZodMap",r.ZodSet="ZodSet",r.ZodFunction="ZodFunction",r.ZodLazy="ZodLazy",r.ZodLiteral="ZodLiteral",r.ZodEnum="ZodEnum",r.ZodEffects="ZodEffects",r.ZodNativeEnum="ZodNativeEnum",r.ZodOptional="ZodOptional",r.ZodNullable="ZodNullable",r.ZodDefault="ZodDefault",r.ZodCatch="ZodCatch",r.ZodPromise="ZodPromise",r.ZodBranded="ZodBranded",r.ZodPipeline="ZodPipeline",r.ZodReadonly="ZodReadonly"})(D||(D={}));const Po=(r,t={message:`Input not instance of ${r.name}`})=>ni(e=>e instanceof r,t),ii=bt.create,si=Ut.create,ko=tr.create,Oo=Vt.create,oi=ye.create,No=Xt.create,Lo=qe.create,Do=ve.create,jo=we.create,Bo=Qt.create,Go=qt.create,Fo=Ot.create,Wo=He.create,Uo=_t.create,Vo=Q.create,zo=Q.strictCreate,Zo=Te.create,$o=Je.create,Xo=xe.create,qo=At.create,Ho=Me.create,Yo=Ke.create,Jo=Ht.create,Ko=ee.create,Qo=be.create,ta=_e.create,ea=zt.create,ra=Ee.create,na=re.create,ai=Et.create,ia=Nt.create,sa=Yt.create,oa=Et.createWithPreprocess,aa=Se.create;var m=Object.freeze({__proto__:null,defaultErrorMap:ge,setErrorMap:mo,getErrorMap:Ze,makeIssue:$e,EMPTY_PATH:yo,addIssueToContext:N,ParseStatus:at,INVALID:j,DIRTY:Qn,OK:lt,isAborted:qr,isDirty:Hr,isValid:me,isAsync:Xe,get util(){return H},get objectUtil(){return Xr},ZodParsedType:O,getParsedType:Wt,ZodType:F,ZodString:bt,ZodNumber:Ut,ZodBigInt:Vt,ZodBoolean:ye,ZodDate:Xt,ZodSymbol:qe,ZodUndefined:ve,ZodNull:we,ZodAny:Qt,ZodUnknown:qt,ZodNever:Ot,ZodVoid:He,ZodArray:_t,ZodObject:Q,ZodUnion:Te,ZodDiscriminatedUnion:Je,ZodIntersection:xe,ZodTuple:At,ZodRecord:Me,ZodMap:Ke,ZodSet:Ht,ZodFunction:ee,ZodLazy:be,ZodLiteral:_e,ZodEnum:zt,ZodNativeEnum:Ee,ZodPromise:re,ZodEffects:Et,ZodTransformer:Et,ZodOptional:Nt,ZodNullable:Yt,ZodDefault:Ie,ZodCatch:Qe,ZodNaN:tr,BRAND:Ro,ZodBranded:ri,ZodPipeline:Se,ZodReadonly:er,custom:ni,Schema:F,ZodSchema:F,late:Co,get ZodFirstPartyTypeKind(){return D},coerce:{string:r=>bt.create({...r,coerce:!0}),number:r=>Ut.create({...r,coerce:!0}),boolean:r=>ye.create({...r,coerce:!0}),bigint:r=>Vt.create({...r,coerce:!0}),date:r=>Xt.create({...r,coerce:!0})},any:Bo,array:Uo,bigint:Oo,boolean:oi,date:No,discriminatedUnion:$o,effect:ai,enum:ea,function:Ko,instanceof:Po,intersection:Xo,lazy:Qo,literal:ta,map:Yo,nan:ko,nativeEnum:ra,never:Fo,null:jo,nullable:sa,number:si,object:Vo,oboolean:()=>oi().optional(),onumber:()=>si().optional(),optional:ia,ostring:()=>ii().optional(),pipeline:aa,preprocess:oa,promise:na,record:Ho,set:Jo,strictObject:zo,string:ii,symbol:Lo,transformer:ai,tuple:qo,undefined:Do,union:Zo,unknown:Go,void:Wo,NEVER:j,ZodIssueCode:R,quotelessJson:go,ZodError:Mt});const rr=/^https?:\/\/library.stanford.edu\/iiif\/image-api\/1.1\/compliance.html#level(?<level>[012])$/,ci=m.string().regex(rr),ca=ci,nr="http://library.stanford.edu/iiif/image-api/1.1/context.json",hi="http://iiif.io/api/image/1/context.json",li=m.literal(nr),ui=m.object({"@context":li,"@id":m.string().url(),profile:ci.optional(),width:m.number().int(),height:m.number().int(),scale_factors:m.number().array().optional(),tile_width:m.number().optional(),tile_height:m.number().optional()}),di=m.object({width:m.number().int(),height:m.number().int()}),fi=m.object({width:m.number().int(),height:m.number().int().optional(),scaleFactors:m.array(m.number().int())}),ir=/^https?:\/\/iiif.io\/api\/image\/2.*level(?<level>[012])(.json)?$/,pi=m.string().regex(ir),ha=m.object({formats:m.string().array().optional(),maxArea:m.number().int().optional(),maxHeight:m.number().int().optional(),maxWidth:m.number().int().optional(),qualities:m.string().array().optional(),supports:m.string().array().optional()}),sr=pi.or(m.array(m.union([pi,ha,m.any()]))),or="http://iiif.io/api/image/2/context.json",gi=m.literal(or).or(m.literal("https://iiif.io/api/image/2/context.json")),Kr=m.object({"@id":m.string().url(),"@type":m.literal("iiif:Image").optional(),"@context":gi,protocol:m.literal("http://iiif.io/api/image"),width:m.number().int(),height:m.number().int(),profile:sr,sizes:di.array().optional(),tiles:fi.array().optional()}),la=["level0","level1","level2"],Qr=m.object({id:m.string().url(),type:m.literal("ImageService3"),protocol:m.literal("http://iiif.io/api/image"),profile:m.enum(la),width:m.number().int(),height:m.number().int(),maxWidth:m.number().int().optional(),maxHeight:m.number().int().optional(),maxArea:m.number().int().optional(),sizes:di.array().optional(),tiles:fi.array().optional(),extraFeatures:m.string().array().optional()}),ua=m.object({"@id":m.string().url(),profile:ca.or(sr),width:m.number().int().optional(),height:m.number().int().optional(),"@context":li.or(m.literal("http://iiif.io/api/image/1/context.json")).or(gi).optional()}),da=["level0","level1","level2"],fa=["ImageService1","ImageService2","ImageService3"],pa=m.object({id:m.string().url(),type:m.literal("ImageService2"),profile:sr}).or(m.object({"@id":m.string().url(),"@type":m.literal("ImageService2"),profile:sr})),ga=m.object({id:m.string().url(),type:m.enum(fa),profile:m.enum(da)}),ma=m.union([pa,ga]),mi=ua.or(ma),yi=m.string().or(m.number()).or(m.boolean()),vi=yi.or(yi.array()),wi=m.object({"@language":m.string().optional(),"@value":vi}),Jt=vi.or(wi).or(wi.array()),Ti=m.object({label:Jt.optional(),value:Jt.optional()}).array(),ya=m.object({width:m.number().int().optional(),height:m.number().int().optional(),service:mi}),va=m.object({resource:ya}),xi=m.object({"@id":m.string().url(),"@type":m.literal("sc:Canvas"),width:m.number().int(),height:m.number().int(),images:va.array().length(1),label:Jt.optional(),metadata:Ti.optional()}),wa=m.object({canvases:xi.array().nonempty()}),Mi=m.object({"@id":m.string().url(),"@type":m.literal("sc:Manifest"),sequences:wa.array().length(1),label:Jt.optional(),description:Jt.optional(),metadata:Ti.optional()}),bi=m.lazy(()=>m.object({"@id":m.string().url(),"@type":m.literal("sc:Manifest"),label:Jt.optional()})),tn=m.lazy(()=>m.object({"@id":m.string().url(),"@type":m.literal("sc:Collection"),label:Jt.optional(),manifests:bi.array().optional(),collections:tn.array().optional(),members:bi.or(tn).array().optional()})),Ta=m.string().or(m.number()).or(m.boolean()),Kt=m.record(m.string(),Ta.array()),_i=m.object({label:Kt.optional(),value:Kt.optional()}).array(),Ei=m.object({type:m.literal("Image"),width:m.number().int().optional(),height:m.number().int().optional(),service:mi.array()}),xa=m.object({type:m.literal("Annotation"),body:Ei.or(Ei.array().length(1))}),Ma=m.object({type:m.literal("AnnotationPage"),items:xa.array().length(1)}),Ii=m.object({id:m.string().url(),type:m.literal("Canvas"),width:m.number().int(),height:m.number().int(),items:Ma.array().length(1),label:Kt.optional(),metadata:_i.optional()}),Si=m.object({id:m.string().url(),type:m.literal("Manifest"),items:Ii.array().nonempty(),label:Kt.optional(),description:Kt.optional(),metadata:_i.optional()}),ba=m.lazy(()=>m.object({id:m.string().url(),type:m.literal("Manifest"),label:Kt.optional()})),Ai=m.lazy(()=>m.object({id:m.string().url(),type:m.literal("Collection"),label:Kt.optional(),items:ba.or(Ai).array()})),Ri=ui.or(Kr).or(Qr);xi.or(Ii);const _a=Mi.or(Si);tn.or(Ai),Mi.or(Kr),Si.or(Qr),_a.or(Ri);function Ci({width:r,height:t},e,n,i){const s=n*e.originalWidth,a=i*e.originalHeight,o=n*e.originalWidth+e.width*e.scaleFactor>r?r-n*e.originalWidth:e.width*e.scaleFactor,c=i*e.originalHeight+e.height*e.scaleFactor>t?t-i*e.originalHeight:e.height*e.scaleFactor;let h=e.width,l=e.height;return s+e.width*e.scaleFactor>r&&(h=Math.floor((r-s+e.scaleFactor-1)/e.scaleFactor)),a+e.height*e.scaleFactor>t&&(l=Math.floor((t-a+e.scaleFactor-1)/e.scaleFactor)),{region:{x:s,y:a,width:o,height:c},size:{width:h,height:l}}}function Ea({width:r,height:t},e=768){const n=Math.max(r,t)/e,i=Math.ceil(Math.log(n)/Math.log(2));return{scaleFactors:Array.from({length:i},(s,a)=>2**a),width:e}}function Ia({width:r,height:t},e,n){const i=e.height||e.width,s=e.width*n,a=i*n;return{scaleFactor:n,width:e.width,height:i,originalWidth:s,originalHeight:a,columns:Math.ceil(r/s),rows:Math.ceil(t/a)}}function Sa(r,t){return t.map(e=>e.scaleFactors.map(n=>Ia(r,e,n))).flat()}function Aa(r){return!!r.some(t=>t.width&&t.scaleFactors&&t.scaleFactors.length)}function Ra(r,t,e){if(!t||!Aa(t))if(e)t=[Ea(r)];else throw new Error("Image does not support tiles or custom regions and sizes.");return Sa(r,t)}function Ca(r,t,e="cover"){if(e==="cover"||e==="contain"){const n=t.width/r.width,i=t.height/r.height,s=e==="cover"?Math.max(n,i):Math.min(n,i),a=r.width*s,o=r.height*s;return{width:a,height:o}}else throw new Error('Mode must be either "cover" or "contain"')}const Pa=.8,ka=1.5;function Pi(r,t,e="cover",{sizes:n,tileZoomLevels:i,supportsAnyRegionAndSize:s,maxWidth:a,maxHeight:o,maxArea:c}){let{width:h,height:l}=Ca(r,t,e);if(a&&h>a&&(l=l/h*a,h=a),o&&l>o&&(h=h/l*o,l=o),c&&h*l>c){const g=l/h,y=Math.floor(Math.sqrt(c/g))*g;h=Math.floor(y)/g,l=h*g}const u=r.width/r.height;if(h=Math.floor(h),l=Math.round(h/u),n){let g;for(const v of n){const y=v.width/h;if(y>=Pa&&y<=ka){g=v;break}}if(g)return{size:g}}if(s)return{size:{width:Math.round(h),height:Math.round(l)}};if(i){const g=r.width/h,v=i.map(({scaleFactor:S},f)=>({index:f,scaleFactor:S,diff:Math.abs(S-g)})).sort((S,f)=>S.diff-f.diff),y=i[v[0].index],E=Math.ceil(r.width/(y.scaleFactor*i[0].width)),I=Math.ceil(r.height/(y.scaleFactor*i[0].height)),w=[];for(let S=0;S<I;S++){const f=[];for(let p=0;p<E;p++){const x=Ci(r,y,p,S);f.push(x)}w.push(f)}return w}throw new Error("Unable to create thumbnail")}const ki=["regionByPx","sizeByWh"];function Oa(r){const t=r.match(rr);if(t&&t.groups)return parseInt(t.groups.level)}function Oi(r){const t=r.match(ir);if(t&&t.groups)return parseInt(t.groups.level)}function Na(r){return{maxWidth:r?.maxWidth,maxHeight:r?.maxHeight,maxArea:r?.maxArea,supportsAnyRegionAndSize:ki.every(t=>r?.supports&&r?.supports?.includes(t))}}function La(r){if("type"in r&&r.type==="ImageService3")return 3;if("type"in r&&r.type==="ImageService2"||"@type"in r&&r["@type"]==="ImageService2"||"@context"in r&&r["@context"]===or)return 2;if("@context"in r&&(r["@context"]===nr||r["@context"]===hi))return 1;if("profile"in r){let t;return Array.isArray(r.profile)?t=r.profile[0]:t=r.profile,t.match(rr)?1:t.match(ir)?2:3}else throw new Error("Unsupported IIIF Image Service")}function en(r){if("type"in r){const t=r.profile;let e=!1;return t==="level0"||typeof t=="string"&&t.endsWith("level0.json")?"extraFeatures"in r&&(e=ki.every(n=>r.extraFeatures&&r.extraFeatures.includes(n))):e=!0,{maxWidth:"maxWidth"in r?r.maxWidth:void 0,maxHeight:"maxHeight"in r?r.maxHeight:void 0,maxArea:"maxArea"in r?r.maxArea:void 0,supportsAnyRegionAndSize:e}}else if(Array.isArray(r.profile)){let t=!1,e=Number.NEGATIVE_INFINITY,n=Number.NEGATIVE_INFINITY,i=Number.NEGATIVE_INFINITY;return r.profile.forEach(s=>{if(typeof s=="string"){const a=Oi(s);a&&(t=t||a>=1)}else{const{maxWidth:a,maxHeight:o,maxArea:c,supportsAnyRegionAndSize:h}=Na(s);a!==void 0&&(n=Math.max(a,n)),o!==void 0&&(e=Math.max(o,e)),c!==void 0&&(i=Math.max(c,i)),t=t||h}}),{maxWidth:n>=0?n:void 0,maxHeight:e>=0?e:void 0,maxArea:i>=0?i:void 0,supportsAnyRegionAndSize:t}}else if("profile"in r&&r.profile){const t=Oa(r.profile),e=Oi(r.profile);return t?{supportsAnyRegionAndSize:t>=1}:e?{supportsAnyRegionAndSize:e>=1}:{supportsAnyRegionAndSize:!1}}else throw new Error("Invalid Image")}const Da="image";class ja{constructor(t,e){if(this.embedded=!0,this.type=Da,e){const n=t;let i,s;if(Array.isArray(n.service)?n.service.forEach(a=>{try{const o=La(a);(!s||o>s)&&(s=o,i=a)}catch{}}):i=n.service,!i)throw new Error("Unsupported IIIF Image Service");if("@id"in i)this.uri=i["@id"];else if("id"in i)this.uri=i.id;else throw new Error("Unsupported IIIF Image Service");if("type"in i&&i.type==="ImageService3")this.majorVersion=3;else if("type"in i&&i.type==="ImageService2"||"@type"in i&&i["@type"]==="ImageService2"||"@context"in i&&i["@context"]===or)this.majorVersion=2;else if("@context"in i&&(i["@context"]===nr||i["@context"]===hi))this.majorVersion=1;else if("profile"in i){let a;Array.isArray(i.profile)?a=i.profile[0]:a=i.profile,a.match(rr)?this.majorVersion=1:a.match(ir)?this.majorVersion=2:this.majorVersion=3}else throw new Error("Unsupported IIIF Image Service");if("profile"in i){const a=en(i);this.supportsAnyRegionAndSize=a.supportsAnyRegionAndSize,this.maxWidth=a.maxWidth,this.maxHeight=a.maxHeight,this.maxArea=a.maxArea}else this.supportsAnyRegionAndSize=!1}else{if("@id"in t)this.uri=t["@id"];else if("id"in t)this.uri=t.id;else throw new Error("Unsupported IIIF Image");if("type"in t&&t.type==="ImageService3")this.majorVersion=3;else if("@type"in t&&t["@type"]==="iiif:Image"||"@context"in t&&t["@context"]===or)this.majorVersion=2;else if("@context"in t&&t["@context"]===nr)this.majorVersion=1;else throw new Error("Unsupported IIIF Image");if("profile"in t){const n=en(t);this.supportsAnyRegionAndSize=n.supportsAnyRegionAndSize,this.maxWidth=n.maxWidth,this.maxHeight=n.maxHeight,this.maxArea=n.maxArea}else this.supportsAnyRegionAndSize=!1}if(t.width!==void 0)this.width=t.width;else if(e)this.width=e.width;else throw new Error("Width not present on either Canvas or Image Resource");if(t.height!==void 0)this.height=t.height;else if(e)this.height=e.height;else throw new Error("Height not present on either Canvas or Image Resource")}getImageUrl(t){const{region:e,size:n}=t;let i,s,a,o,c;e?(c=`${e.x},${e.y},${e.width},${e.height}`,a=e.height,o=e.width):(c="full",a=this.height,o=this.width);let h;if(n){i=Math.round(n.width),s=Math.round(n.height);const g=String(i);let v=String(s);const y=o/a,I=s*y/y;s===Math.round(I)&&(v=""),h=`${g},${v}`}else i=this.width,s=this.height,h=this.majorVersion===2?"full":"max";const l=i*s;if(this.maxWidth!==void 0&&i>this.maxWidth)throw new Error(`Width of requested image is too large: ${i} > ${this.maxWidth}`);if(this.maxHeight!==void 0&&s>this.maxHeight)throw new Error(`Height of requested image is too large: ${s} > ${this.maxHeight}`);if(this.maxArea!==void 0&&l>this.maxArea)throw new Error(`Area of requested image is too large: ${l} > ${this.maxArea}`);const u=this.majorVersion===1?"native":"default";return`${this.uri}/${c}/${h}/0/${u}.jpg`}getThumbnail(t,e="cover"){return Pi({width:this.width,height:this.height},t,e,{supportsAnyRegionAndSize:this.supportsAnyRegionAndSize,maxWidth:this.maxWidth,maxHeight:this.maxHeight,maxArea:this.maxArea})}}let Ba=class lo extends ja{constructor(t){super(t),this.embedded=!1;const e=en(t);let n;"tiles"in t&&(n=t.tiles),this.tileZoomLevels=Ra({width:this.width,height:this.height},n,e.supportsAnyRegionAndSize),"sizes"in t&&(this.sizes=t.sizes)}static parse(t,e=null){let n;return e===1?n=ui.parse(t):e===2?n=Kr.parse(t):e===3?n=Qr.parse(t):n=Ri.parse(t),new lo(n)}getIiifTile(t,e,n){return Ci({width:this.width,height:this.height},t,e,n)}getThumbnail(t,e="cover"){return Pi({width:this.width,height:this.height},t,e,{supportsAnyRegionAndSize:this.supportsAnyRegionAndSize,sizes:this.sizes,tileZoomLevels:this.tileZoomLevels,maxWidth:this.maxWidth,maxHeight:this.maxHeight,maxArea:this.maxArea})}};const Ni=m.record(m.string(),m.string().array());m.object({label:Ni.optional(),value:Ni.optional()});var gt=63710088e-1,Li={centimeters:gt*100,centimetres:gt*100,degrees:gt/111325,feet:gt*3.28084,inches:gt*39.37,kilometers:gt/1e3,kilometres:gt/1e3,meters:gt,metres:gt,miles:gt/1609.344,millimeters:gt*1e3,millimetres:gt*1e3,nauticalmiles:gt/1852,radians:1,yards:gt*1.0936};function Ga(r,t,e){e===void 0&&(e={});var n={type:"Feature"};return(e.id===0||e.id)&&(n.id=e.id),e.bbox&&(n.bbox=e.bbox),n.properties=t||{},n.geometry=r,n}function Fa(r,t,e){if(e===void 0&&(e={}),!r)throw new Error("coordinates is required");if(!Array.isArray(r))throw new Error("coordinates must be an Array");if(r.length<2)throw new Error("coordinates must be at least 2 numbers long");if(!Di(r[0])||!Di(r[1]))throw new Error("coordinates must contain numbers");var n={type:"Point",coordinates:r};return Ga(n,t,e)}function Wa(r,t){t===void 0&&(t="kilometers");var e=Li[t];if(!e)throw new Error(t+" units is invalid");return r*e}function Ua(r,t){t===void 0&&(t="kilometers");var e=Li[t];if(!e)throw new Error(t+" units is invalid");return r/e}function rn(r){var t=r%(2*Math.PI);return t*180/Math.PI}function It(r){var t=r%360;return t*Math.PI/180}function Di(r){return!isNaN(r)&&r!==null&&!Array.isArray(r)}function ne(r){if(!r)throw new Error("coord is required");if(!Array.isArray(r)){if(r.type==="Feature"&&r.geometry!==null&&r.geometry.type==="Point")return r.geometry.coordinates;if(r.type==="Point")return r.coordinates}if(Array.isArray(r)&&r.length>=2&&!Array.isArray(r[0])&&!Array.isArray(r[1]))return r;throw new Error("coord must be GeoJSON Point or an Array of numbers")}function Va(r){return r.type==="Feature"?r.geometry:r}function ji(r,t,e){if(e===void 0&&(e={}),e.final===!0)return za(r,t);var n=ne(r),i=ne(t),s=It(n[0]),a=It(i[0]),o=It(n[1]),c=It(i[1]),h=Math.sin(a-s)*Math.cos(c),l=Math.cos(o)*Math.sin(c)-Math.sin(o)*Math.cos(c)*Math.cos(a-s);return rn(Math.atan2(h,l))}function za(r,t){var e=ji(t,r);return e=(e+180)%360,e}function Za(r,t,e,n){n===void 0&&(n={});var i=ne(r),s=It(i[0]),a=It(i[1]),o=It(e),c=Ua(t,n.units),h=Math.asin(Math.sin(a)*Math.cos(c)+Math.cos(a)*Math.sin(c)*Math.cos(o)),l=s+Math.atan2(Math.sin(o)*Math.sin(c)*Math.cos(a),Math.cos(c)-Math.sin(a)*Math.sin(h)),u=rn(l),g=rn(h);return Fa([u,g],n.properties)}function nn(r,t,e){e===void 0&&(e={});var n=ne(r),i=ne(t),s=It(i[1]-n[1]),a=It(i[0]-n[0]),o=It(n[1]),c=It(i[1]),h=Math.pow(Math.sin(s/2),2)+Math.pow(Math.sin(a/2),2)*Math.cos(o)*Math.cos(c);return Wa(2*Math.atan2(Math.sqrt(h),Math.sqrt(1-h)),e.units)}function ar(r,t){var e=nn(r,t),n=ji(r,t),i=Za(r,e/2,n);return i}async function Bi(r,t={}){let e;if(t.cache&&(e=await t.cache.match(r)),e||(e=await fetch(r,{signal:t.abortSignal}),t.cache&&t.cache.put(r,e.clone())),!e.ok)throw new Error(e.statusText);return e}async function $a(r,t={}){return await(await Bi(r,t)).json()}async function Xa(r,t={}){return await $a(`${r}/info.json`,t)}function qa(r,t){return new Promise((e,n)=>{const i=new Image;let s=!1;i.addEventListener("load",()=>e(i)),i.addEventListener("error",async()=>{if(s)n(new DOMException("Loading image aborted by user","AbortError"));else try{throw await Bi(r,{abortSignal:t}),new Error("Image failed to load by setting Image src but downloaded successfully using fetch")}catch(a){n(a)}}),i.crossOrigin="anonymous",i.src=r,t&&t.addEventListener("abort",()=>{s=!0,i.src=""})})}function Gi(r,t=!1){switch(r.type){case"Polygon":return r.coordinates?{...r,coordinates:Fi(r.coordinates,t)}:r;case"MultiPolygon":return r.coordinates?{...r,coordinates:r.coordinates.map(e=>Fi(e,t))}:r;case"GeometryCollection":return{...r,geometries:r.geometries.map(e=>Gi(e,t))};default:return r}}function Fi(r,t){if(r.length===0)return r;const e=[];for(let n=0;n<r.length;n++)e.push(Ha(r[n],n===0?t:!t));return e}function Ha(r,t){let e=0,n=0;for(let i=0,s=r.length,a=s-1;i<s;a=i++){const o=(r[i][0]-r[a][0])*(r[a][1]+r[i][1]),c=e+o;n+=Math.abs(e)>=Math.abs(o)?e-c+o:o-c+e,e=c}return e+n>=0!=!!t?r.slice().reverse():r}function mt(r){return Array.isArray(r)&&r.length===2&&typeof r[0]=="number"&&typeof r[1]=="number"}function Rt(r){return Array.isArray(r)&&r.every(mt)}function Ya(r){return Array.isArray(r)&&r.every(mt)}function Ct(r){return Array.isArray(r)&&r.every(Ya)}function Wi(r){if(r=r.filter(function(t,e,n){return e===0||!on(t,n[e-1])}),r.length<2)throw new Error("LineString should contain at least 2 points");return r}function sn(r){if(r=r.filter(function(t,e,n){return e===0||!on(t,n[e-1])}),Ka(r)&&r.splice(-1),r.length<3)throw new Error("Ring should contain at least 3 points");return r}function Ja(r){return r.map(t=>sn(t))}function cr(r){return{type:"Point",coordinates:r}}function hr(r){return{type:"LineString",coordinates:r}}function lr(r,t=!0){const e={type:"Polygon",coordinates:t?r.map(n=>[...n,n[0]]):r};return Gi(e)}function Ka(r){return Array.isArray(r)&&r.length>=2&&on(r[0],r[r.length-1])}function on(r,t){return r===t?!0:r==null||t==null?!1:r[0]==t[0]&&r[1]==t[1]}function ur(r,t){return[(t[0]-r[0])/2+r[0],(t[1]-r[1])/2+r[1]]}function Qa(r,t,e){return[r[0]*e+t[0]*(1-e),r[1]*e+t[1]*(1-e)]}function Lt(r,t){if(Rt(r)&&r.length==2)return Lt(r[0],r[1]);if(mt(r)&&mt(t))return Math.sqrt((t[0]-r[0])**2+(t[1]-r[1])**2);throw new Error("Input type not supported")}function tc(r){return r*(Math.PI/180)}function Dt(r){return typeof r=="object"&&r!==null&&r.type==="Point"&&mt(r.coordinates)}function jt(r){return typeof r=="object"&&r!==null&&r.type==="LineString"&&Rt(r.coordinates)}function Bt(r){return typeof r=="object"&&r!==null&&r.type==="Polygon"&&Array.isArray(r.coordinates)&&Ct(r.coordinates)}function ec(r){const t=typeof r=="object"&&r!==null,n=t&&"type"in r&&typeof r.type=="string"&&(r.type==="Point"||r.type==="LineString"||r.type==="Polygon"),i=t&&"coordinates"in r&&Array.isArray(r.coordinates);return n&&i}function Ae(r){return r.coordinates}function Re(r){return r.coordinates}function Ce(r,t=!1){let e=r.coordinates;return e=Ja(e),t?e.map(n=>[...n,n[0]]):e}function rc(r){if(Dt(r))return Ae(r);if(jt(r))return Re(r);if(Bt(r))return Ce(r);throw new Error("Geometry type not supported")}function Ui(r){let t=Number.POSITIVE_INFINITY,e=Number.NEGATIVE_INFINITY;for(const n of r)t===void 0?n>=n&&(t=e=n):(t>n&&(t=n),e<n&&(e=n));return[t,e]}function st(r){if(mt(r)&&(r=[r]),Ct(r)&&(r=r.flat()),ec(r))return st(rc(r));const t=[],e=[];for(const o of r)t.push(o[0]),e.push(o[1]);const[n,i]=Ui(t),[s,a]=Ui(e);return[n,s,i,a]}function Vi(r,t){return[Math.min(r[0],t[0]),Math.min(r[1],t[1]),Math.max(r[2],t[2]),Math.max(r[3],t[3])]}function nc(r,t){const e=r[2]>=t[0]&&t[2]>=r[0],n=r[3]>=t[1]&&t[3]>=r[1];return e&&n}function Pe(r){return[[r[0],r[1]],[r[2],r[1]],[r[2],r[3]],[r[0],r[3]]]}function ic(r){return[Pe(r)]}function zi(r){return[[r[0],r[1]],[r[2],r[3]]]}function sc(r){return Lt(zi(r))}function oc(r){return Lt(zi(st(r)))}function an(r){return[(r[0]+r[2])/2,(r[1]+r[3])/2]}function dr(r){return[r[2]-r[0],r[3]-r[1]]}function Zi(r,t){const e=r[0]/t[0],n=r[1]/t[1];return Math.min(e,n)}function cn(r,t){return Zi(dr(r),dr(t))}function ac(r){const t=parseInt(r.replace(/^#/,""),16),e=t>>16&255,n=t>>8&255,i=t&255;return[e,n,i]}function $i(r){return ac(r).map(t=>t/255)}function cc(r,t){return!r||!t||r.size!==t.size?!1:[...r].every(e=>t.has(e))}function Xi(r,t){if(r!==void 0&&t!==void 0)return Math.max(r,t);if(r!==void 0)return r;if(t!==void 0)return t}function hc(r){let t;try{t=new URL(r)}catch{return!1}return t.protocol==="http:"||t.protocol==="https:"}function lc([r,t]){const n=6378137*tc(r),i=n/r,s=180/Math.PI*Math.log(Math.tan(Math.PI/4+t*(Math.PI/180)/2))*i;return[n,s]}function qi([r,t]){const n=Math.PI*6378137,i=r/n*180;let s=t/n*180;return s=180/Math.PI*(2*Math.atan(Math.exp(s*Math.PI/180))-Math.PI/2),[i,s]}var uc=Object.defineProperty,dc=(r,t,e)=>t in r?uc(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e,fc=(r,t,e)=>(dc(r,typeof t!="symbol"?t+"":t,e),e),hn=(r,t,e)=>{if(!t.has(r))throw TypeError("Cannot "+e)},Pt=(r,t,e)=>(hn(r,t,"read from private field"),e?e.call(r):t.get(r)),ke=(r,t,e)=>{if(t.has(r))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(r):t.set(r,e)},ln=(r,t,e,n)=>(hn(r,t,"write to private field"),n?n.call(r,e):t.set(r,e),e),ie=(r,t,e)=>(hn(r,t,"access private method"),e);function Hi(r){if(r.__esModule)return r;var t=r.default;if(typeof t=="function"){var e=function n(){return this instanceof n?Reflect.construct(t,arguments,this.constructor):t.apply(this,arguments)};e.prototype=t.prototype}else e={};return Object.defineProperty(e,"__esModule",{value:!0}),Object.keys(r).forEach(function(n){var i=Object.getOwnPropertyDescriptor(r,n);Object.defineProperty(e,n,i.get?i:{enumerable:!0,get:function(){return r[n]}})}),e}var Z={};const pc=Object.prototype.toString;function Oe(r){const t=pc.call(r);return t.endsWith("Array]")&&!t.includes("Big")}const gc=Object.freeze(Object.defineProperty({__proto__:null,isAnyArray:Oe},Symbol.toStringTag,{value:"Module"})),mc=Hi(gc);function yc(r){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!Oe(r))throw new TypeError("input must be an array");if(r.length===0)throw new TypeError("input must not be empty");var e=t.fromIndex,n=e===void 0?0:e,i=t.toIndex,s=i===void 0?r.length:i;if(n<0||n>=r.length||!Number.isInteger(n))throw new Error("fromIndex must be a positive integer smaller than length");if(s<=n||s>r.length||!Number.isInteger(s))throw new Error("toIndex must be an integer greater than fromIndex and at most equal to length");for(var a=r[n],o=n+1;o<s;o++)r[o]>a&&(a=r[o]);return a}function vc(r){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!Oe(r))throw new TypeError("input must be an array");if(r.length===0)throw new TypeError("input must not be empty");var e=t.fromIndex,n=e===void 0?0:e,i=t.toIndex,s=i===void 0?r.length:i;if(n<0||n>=r.length||!Number.isInteger(n))throw new Error("fromIndex must be a positive integer smaller than length");if(s<=n||s>r.length||!Number.isInteger(s))throw new Error("toIndex must be an integer greater than fromIndex and at most equal to length");for(var a=r[n],o=n+1;o<s;o++)r[o]<a&&(a=r[o]);return a}function wc(r){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(Oe(r)){if(r.length===0)throw new TypeError("input must not be empty")}else throw new TypeError("input must be an array");var e;if(t.output!==void 0){if(!Oe(t.output))throw new TypeError("output option must be an array if specified");e=t.output}else e=new Array(r.length);var n=vc(r),i=yc(r);if(n===i)throw new RangeError("minimum and maximum input values are equal. Cannot rescale a constant array");var s=t.min,a=s===void 0?t.autoMinMax?n:0:s,o=t.max,c=o===void 0?t.autoMinMax?i:1:o;if(a>=c)throw new RangeError("min option must be smaller than max option");for(var h=(c-a)/(i-n),l=0;l<r.length;l++)e[l]=(r[l]-n)*h+a;return e}const Tc=Object.freeze(Object.defineProperty({__proto__:null,default:wc},Symbol.toStringTag,{value:"Module"})),xc=Hi(Tc);Object.defineProperty(Z,"__esModule",{value:!0});var yt=mc,Yi=xc;const fr=" ".repeat(2),Ji=" ".repeat(4);function Mc(){return Ki(this)}function Ki(r,t={}){const{maxRows:e=15,maxColumns:n=10,maxNumSize:i=8,padMinus:s="auto"}=t;return`${r.constructor.name} {
${fr}[
${Ji}${bc(r,e,n,i,s)}
${fr}]
${fr}rows: ${r.rows}
${fr}columns: ${r.columns}
}`}function bc(r,t,e,n,i){const{rows:s,columns:a}=r,o=Math.min(s,t),c=Math.min(a,e),h=[];if(i==="auto"){i=!1;t:for(let l=0;l<o;l++)for(let u=0;u<c;u++)if(r.get(l,u)<0){i=!0;break t}}for(let l=0;l<o;l++){let u=[];for(let g=0;g<c;g++)u.push(_c(r.get(l,g),n,i));h.push(`${u.join(" ")}`)}return c!==a&&(h[h.length-1]+=` ... ${a-e} more columns`),o!==s&&h.push(`... ${s-t} more rows`),h.join(`
${Ji}`)}function _c(r,t,e){return(r>=0&&e?` ${Qi(r,t-1)}`:Qi(r,t)).padEnd(t)}function Qi(r,t){let e=r.toString();if(e.length<=t)return e;let n=r.toFixed(t);if(n.length>t&&(n=r.toFixed(Math.max(0,t-(n.length-t)))),n.length<=t&&!n.startsWith("0.000")&&!n.startsWith("-0.000"))return n;let i=r.toExponential(t);return i.length>t&&(i=r.toExponential(Math.max(0,t-(i.length-t)))),i.slice(0)}function Ec(r,t){r.prototype.add=function(e){return typeof e=="number"?this.addS(e):this.addM(e)},r.prototype.addS=function(e){for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)+e);return this},r.prototype.addM=function(e){if(e=t.checkMatrix(e),this.rows!==e.rows||this.columns!==e.columns)throw new RangeError("Matrices dimensions must be equal");for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)+e.get(n,i));return this},r.add=function(e,n){return new t(e).add(n)},r.prototype.sub=function(e){return typeof e=="number"?this.subS(e):this.subM(e)},r.prototype.subS=function(e){for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)-e);return this},r.prototype.subM=function(e){if(e=t.checkMatrix(e),this.rows!==e.rows||this.columns!==e.columns)throw new RangeError("Matrices dimensions must be equal");for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)-e.get(n,i));return this},r.sub=function(e,n){return new t(e).sub(n)},r.prototype.subtract=r.prototype.sub,r.prototype.subtractS=r.prototype.subS,r.prototype.subtractM=r.prototype.subM,r.subtract=r.sub,r.prototype.mul=function(e){return typeof e=="number"?this.mulS(e):this.mulM(e)},r.prototype.mulS=function(e){for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)*e);return this},r.prototype.mulM=function(e){if(e=t.checkMatrix(e),this.rows!==e.rows||this.columns!==e.columns)throw new RangeError("Matrices dimensions must be equal");for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)*e.get(n,i));return this},r.mul=function(e,n){return new t(e).mul(n)},r.prototype.multiply=r.prototype.mul,r.prototype.multiplyS=r.prototype.mulS,r.prototype.multiplyM=r.prototype.mulM,r.multiply=r.mul,r.prototype.div=function(e){return typeof e=="number"?this.divS(e):this.divM(e)},r.prototype.divS=function(e){for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)/e);return this},r.prototype.divM=function(e){if(e=t.checkMatrix(e),this.rows!==e.rows||this.columns!==e.columns)throw new RangeError("Matrices dimensions must be equal");for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)/e.get(n,i));return this},r.div=function(e,n){return new t(e).div(n)},r.prototype.divide=r.prototype.div,r.prototype.divideS=r.prototype.divS,r.prototype.divideM=r.prototype.divM,r.divide=r.div,r.prototype.mod=function(e){return typeof e=="number"?this.modS(e):this.modM(e)},r.prototype.modS=function(e){for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)%e);return this},r.prototype.modM=function(e){if(e=t.checkMatrix(e),this.rows!==e.rows||this.columns!==e.columns)throw new RangeError("Matrices dimensions must be equal");for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)%e.get(n,i));return this},r.mod=function(e,n){return new t(e).mod(n)},r.prototype.modulus=r.prototype.mod,r.prototype.modulusS=r.prototype.modS,r.prototype.modulusM=r.prototype.modM,r.modulus=r.mod,r.prototype.and=function(e){return typeof e=="number"?this.andS(e):this.andM(e)},r.prototype.andS=function(e){for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)&e);return this},r.prototype.andM=function(e){if(e=t.checkMatrix(e),this.rows!==e.rows||this.columns!==e.columns)throw new RangeError("Matrices dimensions must be equal");for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)&e.get(n,i));return this},r.and=function(e,n){return new t(e).and(n)},r.prototype.or=function(e){return typeof e=="number"?this.orS(e):this.orM(e)},r.prototype.orS=function(e){for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)|e);return this},r.prototype.orM=function(e){if(e=t.checkMatrix(e),this.rows!==e.rows||this.columns!==e.columns)throw new RangeError("Matrices dimensions must be equal");for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)|e.get(n,i));return this},r.or=function(e,n){return new t(e).or(n)},r.prototype.xor=function(e){return typeof e=="number"?this.xorS(e):this.xorM(e)},r.prototype.xorS=function(e){for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)^e);return this},r.prototype.xorM=function(e){if(e=t.checkMatrix(e),this.rows!==e.rows||this.columns!==e.columns)throw new RangeError("Matrices dimensions must be equal");for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)^e.get(n,i));return this},r.xor=function(e,n){return new t(e).xor(n)},r.prototype.leftShift=function(e){return typeof e=="number"?this.leftShiftS(e):this.leftShiftM(e)},r.prototype.leftShiftS=function(e){for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)<<e);return this},r.prototype.leftShiftM=function(e){if(e=t.checkMatrix(e),this.rows!==e.rows||this.columns!==e.columns)throw new RangeError("Matrices dimensions must be equal");for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)<<e.get(n,i));return this},r.leftShift=function(e,n){return new t(e).leftShift(n)},r.prototype.signPropagatingRightShift=function(e){return typeof e=="number"?this.signPropagatingRightShiftS(e):this.signPropagatingRightShiftM(e)},r.prototype.signPropagatingRightShiftS=function(e){for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)>>e);return this},r.prototype.signPropagatingRightShiftM=function(e){if(e=t.checkMatrix(e),this.rows!==e.rows||this.columns!==e.columns)throw new RangeError("Matrices dimensions must be equal");for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)>>e.get(n,i));return this},r.signPropagatingRightShift=function(e,n){return new t(e).signPropagatingRightShift(n)},r.prototype.rightShift=function(e){return typeof e=="number"?this.rightShiftS(e):this.rightShiftM(e)},r.prototype.rightShiftS=function(e){for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)>>>e);return this},r.prototype.rightShiftM=function(e){if(e=t.checkMatrix(e),this.rows!==e.rows||this.columns!==e.columns)throw new RangeError("Matrices dimensions must be equal");for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,this.get(n,i)>>>e.get(n,i));return this},r.rightShift=function(e,n){return new t(e).rightShift(n)},r.prototype.zeroFillRightShift=r.prototype.rightShift,r.prototype.zeroFillRightShiftS=r.prototype.rightShiftS,r.prototype.zeroFillRightShiftM=r.prototype.rightShiftM,r.zeroFillRightShift=r.rightShift,r.prototype.not=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,~this.get(e,n));return this},r.not=function(e){return new t(e).not()},r.prototype.abs=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.abs(this.get(e,n)));return this},r.abs=function(e){return new t(e).abs()},r.prototype.acos=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.acos(this.get(e,n)));return this},r.acos=function(e){return new t(e).acos()},r.prototype.acosh=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.acosh(this.get(e,n)));return this},r.acosh=function(e){return new t(e).acosh()},r.prototype.asin=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.asin(this.get(e,n)));return this},r.asin=function(e){return new t(e).asin()},r.prototype.asinh=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.asinh(this.get(e,n)));return this},r.asinh=function(e){return new t(e).asinh()},r.prototype.atan=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.atan(this.get(e,n)));return this},r.atan=function(e){return new t(e).atan()},r.prototype.atanh=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.atanh(this.get(e,n)));return this},r.atanh=function(e){return new t(e).atanh()},r.prototype.cbrt=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.cbrt(this.get(e,n)));return this},r.cbrt=function(e){return new t(e).cbrt()},r.prototype.ceil=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.ceil(this.get(e,n)));return this},r.ceil=function(e){return new t(e).ceil()},r.prototype.clz32=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.clz32(this.get(e,n)));return this},r.clz32=function(e){return new t(e).clz32()},r.prototype.cos=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.cos(this.get(e,n)));return this},r.cos=function(e){return new t(e).cos()},r.prototype.cosh=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.cosh(this.get(e,n)));return this},r.cosh=function(e){return new t(e).cosh()},r.prototype.exp=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.exp(this.get(e,n)));return this},r.exp=function(e){return new t(e).exp()},r.prototype.expm1=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.expm1(this.get(e,n)));return this},r.expm1=function(e){return new t(e).expm1()},r.prototype.floor=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.floor(this.get(e,n)));return this},r.floor=function(e){return new t(e).floor()},r.prototype.fround=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.fround(this.get(e,n)));return this},r.fround=function(e){return new t(e).fround()},r.prototype.log=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.log(this.get(e,n)));return this},r.log=function(e){return new t(e).log()},r.prototype.log1p=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.log1p(this.get(e,n)));return this},r.log1p=function(e){return new t(e).log1p()},r.prototype.log10=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.log10(this.get(e,n)));return this},r.log10=function(e){return new t(e).log10()},r.prototype.log2=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.log2(this.get(e,n)));return this},r.log2=function(e){return new t(e).log2()},r.prototype.round=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.round(this.get(e,n)));return this},r.round=function(e){return new t(e).round()},r.prototype.sign=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.sign(this.get(e,n)));return this},r.sign=function(e){return new t(e).sign()},r.prototype.sin=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.sin(this.get(e,n)));return this},r.sin=function(e){return new t(e).sin()},r.prototype.sinh=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.sinh(this.get(e,n)));return this},r.sinh=function(e){return new t(e).sinh()},r.prototype.sqrt=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.sqrt(this.get(e,n)));return this},r.sqrt=function(e){return new t(e).sqrt()},r.prototype.tan=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.tan(this.get(e,n)));return this},r.tan=function(e){return new t(e).tan()},r.prototype.tanh=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.tanh(this.get(e,n)));return this},r.tanh=function(e){return new t(e).tanh()},r.prototype.trunc=function(){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,Math.trunc(this.get(e,n)));return this},r.trunc=function(e){return new t(e).trunc()},r.pow=function(e,n){return new t(e).pow(n)},r.prototype.pow=function(e){return typeof e=="number"?this.powS(e):this.powM(e)},r.prototype.powS=function(e){for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,Math.pow(this.get(n,i),e));return this},r.prototype.powM=function(e){if(e=t.checkMatrix(e),this.rows!==e.rows||this.columns!==e.columns)throw new RangeError("Matrices dimensions must be equal");for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.set(n,i,Math.pow(this.get(n,i),e.get(n,i)));return this}}function wt(r,t,e){let n=e?r.rows:r.rows-1;if(t<0||t>n)throw new RangeError("Row index out of range")}function Tt(r,t,e){let n=e?r.columns:r.columns-1;if(t<0||t>n)throw new RangeError("Column index out of range")}function se(r,t){if(t.to1DArray&&(t=t.to1DArray()),t.length!==r.columns)throw new RangeError("vector size must be the same as the number of columns");return t}function oe(r,t){if(t.to1DArray&&(t=t.to1DArray()),t.length!==r.rows)throw new RangeError("vector size must be the same as the number of rows");return t}function un(r,t){if(!yt.isAnyArray(t))throw new TypeError("row indices must be an array");for(let e=0;e<t.length;e++)if(t[e]<0||t[e]>=r.rows)throw new RangeError("row indices are out of range")}function dn(r,t){if(!yt.isAnyArray(t))throw new TypeError("column indices must be an array");for(let e=0;e<t.length;e++)if(t[e]<0||t[e]>=r.columns)throw new RangeError("column indices are out of range")}function fn(r,t,e,n,i){if(arguments.length!==5)throw new RangeError("expected 4 arguments");if(gr("startRow",t),gr("endRow",e),gr("startColumn",n),gr("endColumn",i),t>e||n>i||t<0||t>=r.rows||e<0||e>=r.rows||n<0||n>=r.columns||i<0||i>=r.columns)throw new RangeError("Submatrix indices are out of range")}function pr(r,t=0){let e=[];for(let n=0;n<r;n++)e.push(t);return e}function gr(r,t){if(typeof t!="number")throw new TypeError(`${r} must be a number`)}function ae(r){if(r.isEmpty())throw new Error("Empty matrix has no elements to index")}function Ic(r){let t=pr(r.rows);for(let e=0;e<r.rows;++e)for(let n=0;n<r.columns;++n)t[e]+=r.get(e,n);return t}function Sc(r){let t=pr(r.columns);for(let e=0;e<r.rows;++e)for(let n=0;n<r.columns;++n)t[n]+=r.get(e,n);return t}function Ac(r){let t=0;for(let e=0;e<r.rows;e++)for(let n=0;n<r.columns;n++)t+=r.get(e,n);return t}function Rc(r){let t=pr(r.rows,1);for(let e=0;e<r.rows;++e)for(let n=0;n<r.columns;++n)t[e]*=r.get(e,n);return t}function Cc(r){let t=pr(r.columns,1);for(let e=0;e<r.rows;++e)for(let n=0;n<r.columns;++n)t[n]*=r.get(e,n);return t}function Pc(r){let t=1;for(let e=0;e<r.rows;e++)for(let n=0;n<r.columns;n++)t*=r.get(e,n);return t}function kc(r,t,e){const n=r.rows,i=r.columns,s=[];for(let a=0;a<n;a++){let o=0,c=0,h=0;for(let l=0;l<i;l++)h=r.get(a,l)-e[a],o+=h,c+=h*h;t?s.push((c-o*o/i)/(i-1)):s.push((c-o*o/i)/i)}return s}function Oc(r,t,e){const n=r.rows,i=r.columns,s=[];for(let a=0;a<i;a++){let o=0,c=0,h=0;for(let l=0;l<n;l++)h=r.get(l,a)-e[a],o+=h,c+=h*h;t?s.push((c-o*o/n)/(n-1)):s.push((c-o*o/n)/n)}return s}function Nc(r,t,e){const n=r.rows,i=r.columns,s=n*i;let a=0,o=0,c=0;for(let h=0;h<n;h++)for(let l=0;l<i;l++)c=r.get(h,l)-e,a+=c,o+=c*c;return t?(o-a*a/s)/(s-1):(o-a*a/s)/s}function Lc(r,t){for(let e=0;e<r.rows;e++)for(let n=0;n<r.columns;n++)r.set(e,n,r.get(e,n)-t[e])}function Dc(r,t){for(let e=0;e<r.rows;e++)for(let n=0;n<r.columns;n++)r.set(e,n,r.get(e,n)-t[n])}function jc(r,t){for(let e=0;e<r.rows;e++)for(let n=0;n<r.columns;n++)r.set(e,n,r.get(e,n)-t)}function Bc(r){const t=[];for(let e=0;e<r.rows;e++){let n=0;for(let i=0;i<r.columns;i++)n+=Math.pow(r.get(e,i),2)/(r.columns-1);t.push(Math.sqrt(n))}return t}function Gc(r,t){for(let e=0;e<r.rows;e++)for(let n=0;n<r.columns;n++)r.set(e,n,r.get(e,n)/t[e])}function Fc(r){const t=[];for(let e=0;e<r.columns;e++){let n=0;for(let i=0;i<r.rows;i++)n+=Math.pow(r.get(i,e),2)/(r.rows-1);t.push(Math.sqrt(n))}return t}function Wc(r,t){for(let e=0;e<r.rows;e++)for(let n=0;n<r.columns;n++)r.set(e,n,r.get(e,n)/t[n])}function Uc(r){const t=r.size-1;let e=0;for(let n=0;n<r.columns;n++)for(let i=0;i<r.rows;i++)e+=Math.pow(r.get(i,n),2)/t;return Math.sqrt(e)}function Vc(r,t){for(let e=0;e<r.rows;e++)for(let n=0;n<r.columns;n++)r.set(e,n,r.get(e,n)/t)}class G{static from1DArray(t,e,n){if(t*e!==n.length)throw new RangeError("data length does not match given dimensions");let i=new P(t,e);for(let s=0;s<t;s++)for(let a=0;a<e;a++)i.set(s,a,n[s*e+a]);return i}static rowVector(t){let e=new P(1,t.length);for(let n=0;n<t.length;n++)e.set(0,n,t[n]);return e}static columnVector(t){let e=new P(t.length,1);for(let n=0;n<t.length;n++)e.set(n,0,t[n]);return e}static zeros(t,e){return new P(t,e)}static ones(t,e){return new P(t,e).fill(1)}static rand(t,e,n={}){if(typeof n!="object")throw new TypeError("options must be an object");const{random:i=Math.random}=n;let s=new P(t,e);for(let a=0;a<t;a++)for(let o=0;o<e;o++)s.set(a,o,i());return s}static randInt(t,e,n={}){if(typeof n!="object")throw new TypeError("options must be an object");const{min:i=0,max:s=1e3,random:a=Math.random}=n;if(!Number.isInteger(i))throw new TypeError("min must be an integer");if(!Number.isInteger(s))throw new TypeError("max must be an integer");if(i>=s)throw new RangeError("min must be smaller than max");let o=s-i,c=new P(t,e);for(let h=0;h<t;h++)for(let l=0;l<e;l++){let u=i+Math.round(a()*o);c.set(h,l,u)}return c}static eye(t,e,n){e===void 0&&(e=t),n===void 0&&(n=1);let i=Math.min(t,e),s=this.zeros(t,e);for(let a=0;a<i;a++)s.set(a,a,n);return s}static diag(t,e,n){let i=t.length;e===void 0&&(e=i),n===void 0&&(n=e);let s=Math.min(i,e,n),a=this.zeros(e,n);for(let o=0;o<s;o++)a.set(o,o,t[o]);return a}static min(t,e){t=this.checkMatrix(t),e=this.checkMatrix(e);let n=t.rows,i=t.columns,s=new P(n,i);for(let a=0;a<n;a++)for(let o=0;o<i;o++)s.set(a,o,Math.min(t.get(a,o),e.get(a,o)));return s}static max(t,e){t=this.checkMatrix(t),e=this.checkMatrix(e);let n=t.rows,i=t.columns,s=new this(n,i);for(let a=0;a<n;a++)for(let o=0;o<i;o++)s.set(a,o,Math.max(t.get(a,o),e.get(a,o)));return s}static checkMatrix(t){return G.isMatrix(t)?t:new P(t)}static isMatrix(t){return t!=null&&t.klass==="Matrix"}get size(){return this.rows*this.columns}apply(t){if(typeof t!="function")throw new TypeError("callback must be a function");for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)t.call(this,e,n);return this}to1DArray(){let t=[];for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)t.push(this.get(e,n));return t}to2DArray(){let t=[];for(let e=0;e<this.rows;e++){t.push([]);for(let n=0;n<this.columns;n++)t[e].push(this.get(e,n))}return t}toJSON(){return this.to2DArray()}isRowVector(){return this.rows===1}isColumnVector(){return this.columns===1}isVector(){return this.rows===1||this.columns===1}isSquare(){return this.rows===this.columns}isEmpty(){return this.rows===0||this.columns===0}isSymmetric(){if(this.isSquare()){for(let t=0;t<this.rows;t++)for(let e=0;e<=t;e++)if(this.get(t,e)!==this.get(e,t))return!1;return!0}return!1}isDistance(){if(!this.isSymmetric())return!1;for(let t=0;t<this.rows;t++)if(this.get(t,t)!==0)return!1;return!0}isEchelonForm(){let t=0,e=0,n=-1,i=!0,s=!1;for(;t<this.rows&&i;){for(e=0,s=!1;e<this.columns&&s===!1;)this.get(t,e)===0?e++:this.get(t,e)===1&&e>n?(s=!0,n=e):(i=!1,s=!0);t++}return i}isReducedEchelonForm(){let t=0,e=0,n=-1,i=!0,s=!1;for(;t<this.rows&&i;){for(e=0,s=!1;e<this.columns&&s===!1;)this.get(t,e)===0?e++:this.get(t,e)===1&&e>n?(s=!0,n=e):(i=!1,s=!0);for(let a=e+1;a<this.rows;a++)this.get(t,a)!==0&&(i=!1);t++}return i}echelonForm(){let t=this.clone(),e=0,n=0;for(;e<t.rows&&n<t.columns;){let i=e;for(let s=e;s<t.rows;s++)t.get(s,n)>t.get(i,n)&&(i=s);if(t.get(i,n)===0)n++;else{t.swapRows(e,i);let s=t.get(e,n);for(let a=n;a<t.columns;a++)t.set(e,a,t.get(e,a)/s);for(let a=e+1;a<t.rows;a++){let o=t.get(a,n)/t.get(e,n);t.set(a,n,0);for(let c=n+1;c<t.columns;c++)t.set(a,c,t.get(a,c)-t.get(e,c)*o)}e++,n++}}return t}reducedEchelonForm(){let t=this.echelonForm(),e=t.columns,n=t.rows,i=n-1;for(;i>=0;)if(t.maxRow(i)===0)i--;else{let s=0,a=!1;for(;s<n&&a===!1;)t.get(i,s)===1?a=!0:s++;for(let o=0;o<i;o++){let c=t.get(o,s);for(let h=s;h<e;h++){let l=t.get(o,h)-c*t.get(i,h);t.set(o,h,l)}}i--}return t}set(){throw new Error("set method is unimplemented")}get(){throw new Error("get method is unimplemented")}repeat(t={}){if(typeof t!="object")throw new TypeError("options must be an object");const{rows:e=1,columns:n=1}=t;if(!Number.isInteger(e)||e<=0)throw new TypeError("rows must be a positive integer");if(!Number.isInteger(n)||n<=0)throw new TypeError("columns must be a positive integer");let i=new P(this.rows*e,this.columns*n);for(let s=0;s<e;s++)for(let a=0;a<n;a++)i.setSubMatrix(this,this.rows*s,this.columns*a);return i}fill(t){for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,t);return this}neg(){return this.mulS(-1)}getRow(t){wt(this,t);let e=[];for(let n=0;n<this.columns;n++)e.push(this.get(t,n));return e}getRowVector(t){return P.rowVector(this.getRow(t))}setRow(t,e){wt(this,t),e=se(this,e);for(let n=0;n<this.columns;n++)this.set(t,n,e[n]);return this}swapRows(t,e){wt(this,t),wt(this,e);for(let n=0;n<this.columns;n++){let i=this.get(t,n);this.set(t,n,this.get(e,n)),this.set(e,n,i)}return this}getColumn(t){Tt(this,t);let e=[];for(let n=0;n<this.rows;n++)e.push(this.get(n,t));return e}getColumnVector(t){return P.columnVector(this.getColumn(t))}setColumn(t,e){Tt(this,t),e=oe(this,e);for(let n=0;n<this.rows;n++)this.set(n,t,e[n]);return this}swapColumns(t,e){Tt(this,t),Tt(this,e);for(let n=0;n<this.rows;n++){let i=this.get(n,t);this.set(n,t,this.get(n,e)),this.set(n,e,i)}return this}addRowVector(t){t=se(this,t);for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,this.get(e,n)+t[n]);return this}subRowVector(t){t=se(this,t);for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,this.get(e,n)-t[n]);return this}mulRowVector(t){t=se(this,t);for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,this.get(e,n)*t[n]);return this}divRowVector(t){t=se(this,t);for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,this.get(e,n)/t[n]);return this}addColumnVector(t){t=oe(this,t);for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,this.get(e,n)+t[e]);return this}subColumnVector(t){t=oe(this,t);for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,this.get(e,n)-t[e]);return this}mulColumnVector(t){t=oe(this,t);for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,this.get(e,n)*t[e]);return this}divColumnVector(t){t=oe(this,t);for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)this.set(e,n,this.get(e,n)/t[e]);return this}mulRow(t,e){wt(this,t);for(let n=0;n<this.columns;n++)this.set(t,n,this.get(t,n)*e);return this}mulColumn(t,e){Tt(this,t);for(let n=0;n<this.rows;n++)this.set(n,t,this.get(n,t)*e);return this}max(t){if(this.isEmpty())return NaN;switch(t){case"row":{const e=new Array(this.rows).fill(Number.NEGATIVE_INFINITY);for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.get(n,i)>e[n]&&(e[n]=this.get(n,i));return e}case"column":{const e=new Array(this.columns).fill(Number.NEGATIVE_INFINITY);for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.get(n,i)>e[i]&&(e[i]=this.get(n,i));return e}case void 0:{let e=this.get(0,0);for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.get(n,i)>e&&(e=this.get(n,i));return e}default:throw new Error(`invalid option: ${t}`)}}maxIndex(){ae(this);let t=this.get(0,0),e=[0,0];for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.get(n,i)>t&&(t=this.get(n,i),e[0]=n,e[1]=i);return e}min(t){if(this.isEmpty())return NaN;switch(t){case"row":{const e=new Array(this.rows).fill(Number.POSITIVE_INFINITY);for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.get(n,i)<e[n]&&(e[n]=this.get(n,i));return e}case"column":{const e=new Array(this.columns).fill(Number.POSITIVE_INFINITY);for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.get(n,i)<e[i]&&(e[i]=this.get(n,i));return e}case void 0:{let e=this.get(0,0);for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.get(n,i)<e&&(e=this.get(n,i));return e}default:throw new Error(`invalid option: ${t}`)}}minIndex(){ae(this);let t=this.get(0,0),e=[0,0];for(let n=0;n<this.rows;n++)for(let i=0;i<this.columns;i++)this.get(n,i)<t&&(t=this.get(n,i),e[0]=n,e[1]=i);return e}maxRow(t){if(wt(this,t),this.isEmpty())return NaN;let e=this.get(t,0);for(let n=1;n<this.columns;n++)this.get(t,n)>e&&(e=this.get(t,n));return e}maxRowIndex(t){wt(this,t),ae(this);let e=this.get(t,0),n=[t,0];for(let i=1;i<this.columns;i++)this.get(t,i)>e&&(e=this.get(t,i),n[1]=i);return n}minRow(t){if(wt(this,t),this.isEmpty())return NaN;let e=this.get(t,0);for(let n=1;n<this.columns;n++)this.get(t,n)<e&&(e=this.get(t,n));return e}minRowIndex(t){wt(this,t),ae(this);let e=this.get(t,0),n=[t,0];for(let i=1;i<this.columns;i++)this.get(t,i)<e&&(e=this.get(t,i),n[1]=i);return n}maxColumn(t){if(Tt(this,t),this.isEmpty())return NaN;let e=this.get(0,t);for(let n=1;n<this.rows;n++)this.get(n,t)>e&&(e=this.get(n,t));return e}maxColumnIndex(t){Tt(this,t),ae(this);let e=this.get(0,t),n=[0,t];for(let i=1;i<this.rows;i++)this.get(i,t)>e&&(e=this.get(i,t),n[0]=i);return n}minColumn(t){if(Tt(this,t),this.isEmpty())return NaN;let e=this.get(0,t);for(let n=1;n<this.rows;n++)this.get(n,t)<e&&(e=this.get(n,t));return e}minColumnIndex(t){Tt(this,t),ae(this);let e=this.get(0,t),n=[0,t];for(let i=1;i<this.rows;i++)this.get(i,t)<e&&(e=this.get(i,t),n[0]=i);return n}diag(){let t=Math.min(this.rows,this.columns),e=[];for(let n=0;n<t;n++)e.push(this.get(n,n));return e}norm(t="frobenius"){switch(t){case"max":return this.max();case"frobenius":return Math.sqrt(this.dot(this));default:throw new RangeError(`unknown norm type: ${t}`)}}cumulativeSum(){let t=0;for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)t+=this.get(e,n),this.set(e,n,t);return this}dot(t){G.isMatrix(t)&&(t=t.to1DArray());let e=this.to1DArray();if(e.length!==t.length)throw new RangeError("vectors do not have the same size");let n=0;for(let i=0;i<e.length;i++)n+=e[i]*t[i];return n}mmul(t){t=P.checkMatrix(t);let e=this.rows,n=this.columns,i=t.columns,s=new P(e,i),a=new Float64Array(n);for(let o=0;o<i;o++){for(let c=0;c<n;c++)a[c]=t.get(c,o);for(let c=0;c<e;c++){let h=0;for(let l=0;l<n;l++)h+=this.get(c,l)*a[l];s.set(c,o,h)}}return s}strassen2x2(t){t=P.checkMatrix(t);let e=new P(2,2);const n=this.get(0,0),i=t.get(0,0),s=this.get(0,1),a=t.get(0,1),o=this.get(1,0),c=t.get(1,0),h=this.get(1,1),l=t.get(1,1),u=(n+h)*(i+l),g=(o+h)*i,v=n*(a-l),y=h*(c-i),E=(n+s)*l,I=(o-n)*(i+a),w=(s-h)*(c+l),S=u+y-E+w,f=v+E,p=g+y,x=u-g+v+I;return e.set(0,0,S),e.set(0,1,f),e.set(1,0,p),e.set(1,1,x),e}strassen3x3(t){t=P.checkMatrix(t);let e=new P(3,3);const n=this.get(0,0),i=this.get(0,1),s=this.get(0,2),a=this.get(1,0),o=this.get(1,1),c=this.get(1,2),h=this.get(2,0),l=this.get(2,1),u=this.get(2,2),g=t.get(0,0),v=t.get(0,1),y=t.get(0,2),E=t.get(1,0),I=t.get(1,1),w=t.get(1,2),S=t.get(2,0),f=t.get(2,1),p=t.get(2,2),x=(n+i+s-a-o-l-u)*I,A=(n-a)*(-v+I),k=o*(-g+v+E-I-w-S+p),_=(-n+a+o)*(g-v+I),d=(a+o)*(-g+v),T=n*g,b=(-n+h+l)*(g-y+w),M=(-n+h)*(y-w),z=(h+l)*(-g+y),q=(n+i+s-o-c-h-l)*w,X=l*(-g+y+E-I-w-S+f),V=(-s+l+u)*(I+S-f),rt=(s-u)*(I-f),ot=s*S,dt=(l+u)*(-S+f),K=(-s+o+c)*(w+S-p),xt=(s-c)*(w-p),W=(o+c)*(-S+p),et=i*E,ft=c*f,ht=a*y,it=h*v,Zd=u*p,$d=T+ot+et,Xd=x+_+d+T+V+ot+dt,qd=T+b+z+q+ot+K+W,Hd=A+k+_+T+ot+K+xt,Yd=A+_+d+T+ft,Jd=ot+K+xt+W+ht,Kd=T+b+M+X+V+rt+ot,Qd=V+rt+ot+dt+it,tf=T+b+M+z+Zd;return e.set(0,0,$d),e.set(0,1,Xd),e.set(0,2,qd),e.set(1,0,Hd),e.set(1,1,Yd),e.set(1,2,Jd),e.set(2,0,Kd),e.set(2,1,Qd),e.set(2,2,tf),e}mmulStrassen(t){t=P.checkMatrix(t);let e=this.clone(),n=e.rows,i=e.columns,s=t.rows,a=t.columns;i!==s&&console.warn(`Multiplying ${n} x ${i} and ${s} x ${a} matrix: dimensions do not match.`);function o(u,g,v){let y=u.rows,E=u.columns;if(y===g&&E===v)return u;{let I=G.zeros(g,v);return I=I.setSubMatrix(u,0,0),I}}let c=Math.max(n,s),h=Math.max(i,a);e=o(e,c,h),t=o(t,c,h);function l(u,g,v,y){if(v<=512||y<=512)return u.mmul(g);v%2===1&&y%2===1?(u=o(u,v+1,y+1),g=o(g,v+1,y+1)):v%2===1?(u=o(u,v+1,y),g=o(g,v+1,y)):y%2===1&&(u=o(u,v,y+1),g=o(g,v,y+1));let E=parseInt(u.rows/2,10),I=parseInt(u.columns/2,10),w=u.subMatrix(0,E-1,0,I-1),S=g.subMatrix(0,E-1,0,I-1),f=u.subMatrix(0,E-1,I,u.columns-1),p=g.subMatrix(0,E-1,I,g.columns-1),x=u.subMatrix(E,u.rows-1,0,I-1),A=g.subMatrix(E,g.rows-1,0,I-1),k=u.subMatrix(E,u.rows-1,I,u.columns-1),_=g.subMatrix(E,g.rows-1,I,g.columns-1),d=l(G.add(w,k),G.add(S,_),E,I),T=l(G.add(x,k),S,E,I),b=l(w,G.sub(p,_),E,I),M=l(k,G.sub(A,S),E,I),z=l(G.add(w,f),_,E,I),q=l(G.sub(x,w),G.add(S,p),E,I),X=l(G.sub(f,k),G.add(A,_),E,I),V=G.add(d,M);V.sub(z),V.add(X);let rt=G.add(b,z),ot=G.add(T,M),dt=G.sub(d,T);dt.add(b),dt.add(q);let K=G.zeros(2*V.rows,2*V.columns);return K=K.setSubMatrix(V,0,0),K=K.setSubMatrix(rt,V.rows,0),K=K.setSubMatrix(ot,0,V.columns),K=K.setSubMatrix(dt,V.rows,V.columns),K.subMatrix(0,v-1,0,y-1)}return l(e,t,c,h)}scaleRows(t={}){if(typeof t!="object")throw new TypeError("options must be an object");const{min:e=0,max:n=1}=t;if(!Number.isFinite(e))throw new TypeError("min must be a number");if(!Number.isFinite(n))throw new TypeError("max must be a number");if(e>=n)throw new RangeError("min must be smaller than max");let i=new P(this.rows,this.columns);for(let s=0;s<this.rows;s++){const a=this.getRow(s);a.length>0&&Yi(a,{min:e,max:n,output:a}),i.setRow(s,a)}return i}scaleColumns(t={}){if(typeof t!="object")throw new TypeError("options must be an object");const{min:e=0,max:n=1}=t;if(!Number.isFinite(e))throw new TypeError("min must be a number");if(!Number.isFinite(n))throw new TypeError("max must be a number");if(e>=n)throw new RangeError("min must be smaller than max");let i=new P(this.rows,this.columns);for(let s=0;s<this.columns;s++){const a=this.getColumn(s);a.length&&Yi(a,{min:e,max:n,output:a}),i.setColumn(s,a)}return i}flipRows(){const t=Math.ceil(this.columns/2);for(let e=0;e<this.rows;e++)for(let n=0;n<t;n++){let i=this.get(e,n),s=this.get(e,this.columns-1-n);this.set(e,n,s),this.set(e,this.columns-1-n,i)}return this}flipColumns(){const t=Math.ceil(this.rows/2);for(let e=0;e<this.columns;e++)for(let n=0;n<t;n++){let i=this.get(n,e),s=this.get(this.rows-1-n,e);this.set(n,e,s),this.set(this.rows-1-n,e,i)}return this}kroneckerProduct(t){t=P.checkMatrix(t);let e=this.rows,n=this.columns,i=t.rows,s=t.columns,a=new P(e*i,n*s);for(let o=0;o<e;o++)for(let c=0;c<n;c++)for(let h=0;h<i;h++)for(let l=0;l<s;l++)a.set(i*o+h,s*c+l,this.get(o,c)*t.get(h,l));return a}kroneckerSum(t){if(t=P.checkMatrix(t),!this.isSquare()||!t.isSquare())throw new Error("Kronecker Sum needs two Square Matrices");let e=this.rows,n=t.rows,i=this.kroneckerProduct(P.eye(n,n)),s=P.eye(e,e).kroneckerProduct(t);return i.add(s)}transpose(){let t=new P(this.columns,this.rows);for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)t.set(n,e,this.get(e,n));return t}sortRows(t=ts){for(let e=0;e<this.rows;e++)this.setRow(e,this.getRow(e).sort(t));return this}sortColumns(t=ts){for(let e=0;e<this.columns;e++)this.setColumn(e,this.getColumn(e).sort(t));return this}subMatrix(t,e,n,i){fn(this,t,e,n,i);let s=new P(e-t+1,i-n+1);for(let a=t;a<=e;a++)for(let o=n;o<=i;o++)s.set(a-t,o-n,this.get(a,o));return s}subMatrixRow(t,e,n){if(e===void 0&&(e=0),n===void 0&&(n=this.columns-1),e>n||e<0||e>=this.columns||n<0||n>=this.columns)throw new RangeError("Argument out of range");let i=new P(t.length,n-e+1);for(let s=0;s<t.length;s++)for(let a=e;a<=n;a++){if(t[s]<0||t[s]>=this.rows)throw new RangeError(`Row index out of range: ${t[s]}`);i.set(s,a-e,this.get(t[s],a))}return i}subMatrixColumn(t,e,n){if(e===void 0&&(e=0),n===void 0&&(n=this.rows-1),e>n||e<0||e>=this.rows||n<0||n>=this.rows)throw new RangeError("Argument out of range");let i=new P(n-e+1,t.length);for(let s=0;s<t.length;s++)for(let a=e;a<=n;a++){if(t[s]<0||t[s]>=this.columns)throw new RangeError(`Column index out of range: ${t[s]}`);i.set(a-e,s,this.get(a,t[s]))}return i}setSubMatrix(t,e,n){if(t=P.checkMatrix(t),t.isEmpty())return this;let i=e+t.rows-1,s=n+t.columns-1;fn(this,e,i,n,s);for(let a=0;a<t.rows;a++)for(let o=0;o<t.columns;o++)this.set(e+a,n+o,t.get(a,o));return this}selection(t,e){un(this,t),dn(this,e);let n=new P(t.length,e.length);for(let i=0;i<t.length;i++){let s=t[i];for(let a=0;a<e.length;a++){let o=e[a];n.set(i,a,this.get(s,o))}}return n}trace(){let t=Math.min(this.rows,this.columns),e=0;for(let n=0;n<t;n++)e+=this.get(n,n);return e}clone(){return this.constructor.copy(this,new P(this.rows,this.columns))}static copy(t,e){for(const[n,i,s]of t.entries())e.set(n,i,s);return e}sum(t){switch(t){case"row":return Ic(this);case"column":return Sc(this);case void 0:return Ac(this);default:throw new Error(`invalid option: ${t}`)}}product(t){switch(t){case"row":return Rc(this);case"column":return Cc(this);case void 0:return Pc(this);default:throw new Error(`invalid option: ${t}`)}}mean(t){const e=this.sum(t);switch(t){case"row":{for(let n=0;n<this.rows;n++)e[n]/=this.columns;return e}case"column":{for(let n=0;n<this.columns;n++)e[n]/=this.rows;return e}case void 0:return e/this.size;default:throw new Error(`invalid option: ${t}`)}}variance(t,e={}){if(typeof t=="object"&&(e=t,t=void 0),typeof e!="object")throw new TypeError("options must be an object");const{unbiased:n=!0,mean:i=this.mean(t)}=e;if(typeof n!="boolean")throw new TypeError("unbiased must be a boolean");switch(t){case"row":{if(!yt.isAnyArray(i))throw new TypeError("mean must be an array");return kc(this,n,i)}case"column":{if(!yt.isAnyArray(i))throw new TypeError("mean must be an array");return Oc(this,n,i)}case void 0:{if(typeof i!="number")throw new TypeError("mean must be a number");return Nc(this,n,i)}default:throw new Error(`invalid option: ${t}`)}}standardDeviation(t,e){typeof t=="object"&&(e=t,t=void 0);const n=this.variance(t,e);if(t===void 0)return Math.sqrt(n);for(let i=0;i<n.length;i++)n[i]=Math.sqrt(n[i]);return n}center(t,e={}){if(typeof t=="object"&&(e=t,t=void 0),typeof e!="object")throw new TypeError("options must be an object");const{center:n=this.mean(t)}=e;switch(t){case"row":{if(!yt.isAnyArray(n))throw new TypeError("center must be an array");return Lc(this,n),this}case"column":{if(!yt.isAnyArray(n))throw new TypeError("center must be an array");return Dc(this,n),this}case void 0:{if(typeof n!="number")throw new TypeError("center must be a number");return jc(this,n),this}default:throw new Error(`invalid option: ${t}`)}}scale(t,e={}){if(typeof t=="object"&&(e=t,t=void 0),typeof e!="object")throw new TypeError("options must be an object");let n=e.scale;switch(t){case"row":{if(n===void 0)n=Bc(this);else if(!yt.isAnyArray(n))throw new TypeError("scale must be an array");return Gc(this,n),this}case"column":{if(n===void 0)n=Fc(this);else if(!yt.isAnyArray(n))throw new TypeError("scale must be an array");return Wc(this,n),this}case void 0:{if(n===void 0)n=Uc(this);else if(typeof n!="number")throw new TypeError("scale must be a number");return Vc(this,n),this}default:throw new Error(`invalid option: ${t}`)}}toString(t){return Ki(this,t)}[Symbol.iterator](){return this.entries()}*entries(){for(let t=0;t<this.rows;t++)for(let e=0;e<this.columns;e++)yield[t,e,this.get(t,e)]}*values(){for(let t=0;t<this.rows;t++)for(let e=0;e<this.columns;e++)yield this.get(t,e)}}G.prototype.klass="Matrix",typeof Symbol<"u"&&(G.prototype[Symbol.for("nodejs.util.inspect.custom")]=Mc);function ts(r,t){return r-t}function zc(r){return r.every(t=>typeof t=="number")}G.random=G.rand,G.randomInt=G.randInt,G.diagonal=G.diag,G.prototype.diagonal=G.prototype.diag,G.identity=G.eye,G.prototype.negate=G.prototype.neg,G.prototype.tensorProduct=G.prototype.kroneckerProduct;var mr,pn,yr;let P=(yr=class extends G{constructor(r,t){if(super(),ke(this,mr),fc(this,"data"),yr.isMatrix(r))ie(this,mr,pn).call(this,r.rows,r.columns),yr.copy(r,this);else if(Number.isInteger(r)&&r>=0)ie(this,mr,pn).call(this,r,t);else if(yt.isAnyArray(r)){const e=r;if(r=e.length,t=r?e[0].length:0,typeof t!="number")throw new TypeError("Data must be a 2D array with at least one element");this.data=[];for(let n=0;n<r;n++){if(e[n].length!==t)throw new RangeError("Inconsistent array dimensions");if(!zc(e[n]))throw new TypeError("Input data contains non-numeric values");this.data.push(Float64Array.from(e[n]))}this.rows=r,this.columns=t}else throw new TypeError("First argument must be a positive number or an array")}set(r,t,e){return this.data[r][t]=e,this}get(r,t){return this.data[r][t]}removeRow(r){return wt(this,r),this.data.splice(r,1),this.rows-=1,this}addRow(r,t){return t===void 0&&(t=r,r=this.rows),wt(this,r,!0),t=Float64Array.from(se(this,t)),this.data.splice(r,0,t),this.rows+=1,this}removeColumn(r){Tt(this,r);for(let t=0;t<this.rows;t++){const e=new Float64Array(this.columns-1);for(let n=0;n<r;n++)e[n]=this.data[t][n];for(let n=r+1;n<this.columns;n++)e[n-1]=this.data[t][n];this.data[t]=e}return this.columns-=1,this}addColumn(r,t){typeof t>"u"&&(t=r,r=this.columns),Tt(this,r,!0),t=oe(this,t);for(let e=0;e<this.rows;e++){const n=new Float64Array(this.columns+1);let i=0;for(;i<r;i++)n[i]=this.data[e][i];for(n[i++]=t[e];i<this.columns+1;i++)n[i]=this.data[e][i-1];this.data[e]=n}return this.columns+=1,this}},mr=new WeakSet,pn=function(r,t){if(this.data=[],Number.isInteger(t)&&t>=0)for(let e=0;e<r;e++)this.data.push(new Float64Array(t));else throw new TypeError("nColumns must be a positive integer");this.rows=r,this.columns=t},yr);Ec(G,P);var ut;const Zc=class Yn extends G{constructor(t){if(super(),ke(this,ut,void 0),P.isMatrix(t)){if(!t.isSymmetric())throw new TypeError("not symmetric data");ln(this,ut,P.copy(t,new P(t.rows,t.rows)))}else if(Number.isInteger(t)&&t>=0)ln(this,ut,new P(t,t));else if(ln(this,ut,new P(t)),!this.isSymmetric())throw new TypeError("not symmetric data")}get size(){return Pt(this,ut).size}get rows(){return Pt(this,ut).rows}get columns(){return Pt(this,ut).columns}get diagonalSize(){return this.rows}static isSymmetricMatrix(t){return P.isMatrix(t)&&t.klassType==="SymmetricMatrix"}static zeros(t){return new this(t)}static ones(t){return new this(t).fill(1)}clone(){const t=new Yn(this.diagonalSize);for(const[e,n,i]of this.upperRightEntries())t.set(e,n,i);return t}toMatrix(){return new P(this)}get(t,e){return Pt(this,ut).get(t,e)}set(t,e,n){return Pt(this,ut).set(t,e,n),Pt(this,ut).set(e,t,n),this}removeCross(t){return Pt(this,ut).removeRow(t),Pt(this,ut).removeColumn(t),this}addCross(t,e){e===void 0&&(e=t,t=this.diagonalSize);const n=e.slice();return n.splice(t,1),Pt(this,ut).addRow(t,n),Pt(this,ut).addColumn(t,e),this}applyMask(t){if(t.length!==this.diagonalSize)throw new RangeError("Mask size do not match with matrix size");const e=[];for(const[n,i]of t.entries())i||e.push(n);e.reverse();for(const n of e)this.removeCross(n);return this}toCompact(){const{diagonalSize:t}=this,e=new Array(t*(t+1)/2);for(let n=0,i=0,s=0;s<e.length;s++)e[s]=this.get(i,n),++n>=t&&(n=++i);return e}static fromCompact(t){const e=t.length,n=(Math.sqrt(8*e+1)-1)/2;if(!Number.isInteger(n))throw new TypeError(`This array is not a compact representation of a Symmetric Matrix, ${JSON.stringify(t)}`);const i=new Yn(n);for(let s=0,a=0,o=0;o<e;o++)i.set(s,a,t[o]),++s>=n&&(s=++a);return i}*upperRightEntries(){for(let t=0,e=0;t<this.diagonalSize;void 0){const n=this.get(t,e);yield[t,e,n],++e>=this.diagonalSize&&(e=++t)}}*upperRightValues(){for(let t=0,e=0;t<this.diagonalSize;void 0)yield this.get(t,e),++e>=this.diagonalSize&&(e=++t)}};ut=new WeakMap;let Ne=Zc;Ne.prototype.klassType="SymmetricMatrix";class vr extends Ne{static isDistanceMatrix(t){return Ne.isSymmetricMatrix(t)&&t.klassSubType==="DistanceMatrix"}constructor(t){if(super(t),!this.isDistance())throw new TypeError("Provided arguments do no produce a distance matrix")}set(t,e,n){return t===e&&(n=0),super.set(t,e,n)}addCross(t,e){return e===void 0&&(e=t,t=this.diagonalSize),e=e.slice(),e[t]=0,super.addCross(t,e)}toSymmetricMatrix(){return new Ne(this)}clone(){const t=new vr(this.diagonalSize);for(const[e,n,i]of this.upperRightEntries())e!==n&&t.set(e,n,i);return t}toCompact(){const{diagonalSize:t}=this,e=(t-1)*t/2,n=new Array(e);for(let i=1,s=0,a=0;a<n.length;a++)n[a]=this.get(s,i),++i>=t&&(i=++s+1);return n}static fromCompact(t){const e=t.length,n=(Math.sqrt(8*e+1)+1)/2;if(!Number.isInteger(n))throw new TypeError(`This array is not a compact representation of a DistanceMatrix, ${JSON.stringify(t)}`);const i=new this(n);for(let s=1,a=0,o=0;o<e;o++)i.set(s,a,t[o]),++s>=n&&(s=++a+1);return i}}vr.prototype.klassSubType="DistanceMatrix";class Gt extends G{constructor(t,e,n){super(),this.matrix=t,this.rows=e,this.columns=n}}class $c extends Gt{constructor(t,e){Tt(t,e),super(t,t.rows,1),this.column=e}set(t,e,n){return this.matrix.set(t,this.column,n),this}get(t){return this.matrix.get(t,this.column)}}class Xc extends Gt{constructor(t,e){dn(t,e),super(t,t.rows,e.length),this.columnIndices=e}set(t,e,n){return this.matrix.set(t,this.columnIndices[e],n),this}get(t,e){return this.matrix.get(t,this.columnIndices[e])}}class qc extends Gt{constructor(t){super(t,t.rows,t.columns)}set(t,e,n){return this.matrix.set(t,this.columns-e-1,n),this}get(t,e){return this.matrix.get(t,this.columns-e-1)}}class Hc extends Gt{constructor(t){super(t,t.rows,t.columns)}set(t,e,n){return this.matrix.set(this.rows-t-1,e,n),this}get(t,e){return this.matrix.get(this.rows-t-1,e)}}class Yc extends Gt{constructor(t,e){wt(t,e),super(t,1,t.columns),this.row=e}set(t,e,n){return this.matrix.set(this.row,e,n),this}get(t,e){return this.matrix.get(this.row,e)}}class Jc extends Gt{constructor(t,e){un(t,e),super(t,e.length,t.columns),this.rowIndices=e}set(t,e,n){return this.matrix.set(this.rowIndices[t],e,n),this}get(t,e){return this.matrix.get(this.rowIndices[t],e)}}class wr extends Gt{constructor(t,e,n){un(t,e),dn(t,n),super(t,e.length,n.length),this.rowIndices=e,this.columnIndices=n}set(t,e,n){return this.matrix.set(this.rowIndices[t],this.columnIndices[e],n),this}get(t,e){return this.matrix.get(this.rowIndices[t],this.columnIndices[e])}}class Kc extends Gt{constructor(t,e,n,i,s){fn(t,e,n,i,s),super(t,n-e+1,s-i+1),this.startRow=e,this.startColumn=i}set(t,e,n){return this.matrix.set(this.startRow+t,this.startColumn+e,n),this}get(t,e){return this.matrix.get(this.startRow+t,this.startColumn+e)}}class Qc extends Gt{constructor(t){super(t,t.columns,t.rows)}set(t,e,n){return this.matrix.set(e,t,n),this}get(t,e){return this.matrix.get(e,t)}}class es extends G{constructor(t,e={}){const{rows:n=1}=e;if(t.length%n!==0)throw new Error("the data length is not divisible by the number of rows");super(),this.rows=n,this.columns=t.length/n,this.data=t}set(t,e,n){let i=this._calculateIndex(t,e);return this.data[i]=n,this}get(t,e){let n=this._calculateIndex(t,e);return this.data[n]}_calculateIndex(t,e){return t*this.columns+e}}class vt extends G{constructor(t){super(),this.data=t,this.rows=t.length,this.columns=t[0].length}set(t,e,n){return this.data[t][e]=n,this}get(t,e){return this.data[t][e]}}function th(r,t){if(yt.isAnyArray(r))return r[0]&&yt.isAnyArray(r[0])?new vt(r):new es(r,t);throw new Error("the argument is not an array")}class Tr{constructor(t){t=vt.checkMatrix(t);let e=t.clone(),n=e.rows,i=e.columns,s=new Float64Array(n),a=1,o,c,h,l,u,g,v,y,E;for(o=0;o<n;o++)s[o]=o;for(y=new Float64Array(n),c=0;c<i;c++){for(o=0;o<n;o++)y[o]=e.get(o,c);for(o=0;o<n;o++){for(E=Math.min(o,c),u=0,h=0;h<E;h++)u+=e.get(o,h)*y[h];y[o]-=u,e.set(o,c,y[o])}for(l=c,o=c+1;o<n;o++)Math.abs(y[o])>Math.abs(y[l])&&(l=o);if(l!==c){for(h=0;h<i;h++)g=e.get(l,h),e.set(l,h,e.get(c,h)),e.set(c,h,g);v=s[l],s[l]=s[c],s[c]=v,a=-a}if(c<n&&e.get(c,c)!==0)for(o=c+1;o<n;o++)e.set(o,c,e.get(o,c)/e.get(c,c))}this.LU=e,this.pivotVector=s,this.pivotSign=a}isSingular(){let t=this.LU,e=t.columns;for(let n=0;n<e;n++)if(t.get(n,n)===0)return!0;return!1}solve(t){t=P.checkMatrix(t);let e=this.LU;if(e.rows!==t.rows)throw new Error("Invalid matrix dimensions");if(this.isSingular())throw new Error("LU matrix is singular");let n=t.columns,i=t.subMatrixRow(this.pivotVector,0,n-1),s=e.columns,a,o,c;for(c=0;c<s;c++)for(a=c+1;a<s;a++)for(o=0;o<n;o++)i.set(a,o,i.get(a,o)-i.get(c,o)*e.get(a,c));for(c=s-1;c>=0;c--){for(o=0;o<n;o++)i.set(c,o,i.get(c,o)/e.get(c,c));for(a=0;a<c;a++)for(o=0;o<n;o++)i.set(a,o,i.get(a,o)-i.get(c,o)*e.get(a,c))}return i}get determinant(){let t=this.LU;if(!t.isSquare())throw new Error("Matrix must be square");let e=this.pivotSign,n=t.columns;for(let i=0;i<n;i++)e*=t.get(i,i);return e}get lowerTriangularMatrix(){let t=this.LU,e=t.rows,n=t.columns,i=new P(e,n);for(let s=0;s<e;s++)for(let a=0;a<n;a++)s>a?i.set(s,a,t.get(s,a)):s===a?i.set(s,a,1):i.set(s,a,0);return i}get upperTriangularMatrix(){let t=this.LU,e=t.rows,n=t.columns,i=new P(e,n);for(let s=0;s<e;s++)for(let a=0;a<n;a++)s<=a?i.set(s,a,t.get(s,a)):i.set(s,a,0);return i}get pivotPermutationVector(){return Array.from(this.pivotVector)}}function Ft(r,t){let e=0;return Math.abs(r)>Math.abs(t)?(e=t/r,Math.abs(r)*Math.sqrt(1+e*e)):t!==0?(e=r/t,Math.abs(t)*Math.sqrt(1+e*e)):0}class gn{constructor(t){t=vt.checkMatrix(t);let e=t.clone(),n=t.rows,i=t.columns,s=new Float64Array(i),a,o,c,h;for(c=0;c<i;c++){let l=0;for(a=c;a<n;a++)l=Ft(l,e.get(a,c));if(l!==0){for(e.get(c,c)<0&&(l=-l),a=c;a<n;a++)e.set(a,c,e.get(a,c)/l);for(e.set(c,c,e.get(c,c)+1),o=c+1;o<i;o++){for(h=0,a=c;a<n;a++)h+=e.get(a,c)*e.get(a,o);for(h=-h/e.get(c,c),a=c;a<n;a++)e.set(a,o,e.get(a,o)+h*e.get(a,c))}}s[c]=-l}this.QR=e,this.Rdiag=s}solve(t){t=P.checkMatrix(t);let e=this.QR,n=e.rows;if(t.rows!==n)throw new Error("Matrix row dimensions must agree");if(!this.isFullRank())throw new Error("Matrix is rank deficient");let i=t.columns,s=t.clone(),a=e.columns,o,c,h,l;for(h=0;h<a;h++)for(c=0;c<i;c++){for(l=0,o=h;o<n;o++)l+=e.get(o,h)*s.get(o,c);for(l=-l/e.get(h,h),o=h;o<n;o++)s.set(o,c,s.get(o,c)+l*e.get(o,h))}for(h=a-1;h>=0;h--){for(c=0;c<i;c++)s.set(h,c,s.get(h,c)/this.Rdiag[h]);for(o=0;o<h;o++)for(c=0;c<i;c++)s.set(o,c,s.get(o,c)-s.get(h,c)*e.get(o,h))}return s.subMatrix(0,a-1,0,i-1)}isFullRank(){let t=this.QR.columns;for(let e=0;e<t;e++)if(this.Rdiag[e]===0)return!1;return!0}get upperTriangularMatrix(){let t=this.QR,e=t.columns,n=new P(e,e),i,s;for(i=0;i<e;i++)for(s=0;s<e;s++)i<s?n.set(i,s,t.get(i,s)):i===s?n.set(i,s,this.Rdiag[i]):n.set(i,s,0);return n}get orthogonalMatrix(){let t=this.QR,e=t.rows,n=t.columns,i=new P(e,n),s,a,o,c;for(o=n-1;o>=0;o--){for(s=0;s<e;s++)i.set(s,o,0);for(i.set(o,o,1),a=o;a<n;a++)if(t.get(o,o)!==0){for(c=0,s=o;s<e;s++)c+=t.get(s,o)*i.get(s,a);for(c=-c/t.get(o,o),s=o;s<e;s++)i.set(s,a,i.get(s,a)+c*t.get(s,o))}}return i}}let ce=class{constructor(r,t={}){if(r=vt.checkMatrix(r),r.isEmpty())throw new Error("Matrix must be non-empty");let e=r.rows,n=r.columns;const{computeLeftSingularVectors:i=!0,computeRightSingularVectors:s=!0,autoTranspose:a=!1}=t;let o=!!i,c=!!s,h=!1,l;if(e<n)if(!a)l=r.clone(),console.warn("Computing SVD on a matrix with more columns than rows. Consider enabling autoTranspose");else{l=r.transpose(),e=l.rows,n=l.columns,h=!0;let d=o;o=c,c=d}else l=r.clone();let u=Math.min(e,n),g=Math.min(e+1,n),v=new Float64Array(g),y=new P(e,u),E=new P(n,n),I=new Float64Array(n),w=new Float64Array(e),S=new Float64Array(g);for(let d=0;d<g;d++)S[d]=d;let f=Math.min(e-1,n),p=Math.max(0,Math.min(n-2,e)),x=Math.max(f,p);for(let d=0;d<x;d++){if(d<f){v[d]=0;for(let T=d;T<e;T++)v[d]=Ft(v[d],l.get(T,d));if(v[d]!==0){l.get(d,d)<0&&(v[d]=-v[d]);for(let T=d;T<e;T++)l.set(T,d,l.get(T,d)/v[d]);l.set(d,d,l.get(d,d)+1)}v[d]=-v[d]}for(let T=d+1;T<n;T++){if(d<f&&v[d]!==0){let b=0;for(let M=d;M<e;M++)b+=l.get(M,d)*l.get(M,T);b=-b/l.get(d,d);for(let M=d;M<e;M++)l.set(M,T,l.get(M,T)+b*l.get(M,d))}I[T]=l.get(d,T)}if(o&&d<f)for(let T=d;T<e;T++)y.set(T,d,l.get(T,d));if(d<p){I[d]=0;for(let T=d+1;T<n;T++)I[d]=Ft(I[d],I[T]);if(I[d]!==0){I[d+1]<0&&(I[d]=0-I[d]);for(let T=d+1;T<n;T++)I[T]/=I[d];I[d+1]+=1}if(I[d]=-I[d],d+1<e&&I[d]!==0){for(let T=d+1;T<e;T++)w[T]=0;for(let T=d+1;T<e;T++)for(let b=d+1;b<n;b++)w[T]+=I[b]*l.get(T,b);for(let T=d+1;T<n;T++){let b=-I[T]/I[d+1];for(let M=d+1;M<e;M++)l.set(M,T,l.get(M,T)+b*w[M])}}if(c)for(let T=d+1;T<n;T++)E.set(T,d,I[T])}}let A=Math.min(n,e+1);if(f<n&&(v[f]=l.get(f,f)),e<A&&(v[A-1]=0),p+1<A&&(I[p]=l.get(p,A-1)),I[A-1]=0,o){for(let d=f;d<u;d++){for(let T=0;T<e;T++)y.set(T,d,0);y.set(d,d,1)}for(let d=f-1;d>=0;d--)if(v[d]!==0){for(let T=d+1;T<u;T++){let b=0;for(let M=d;M<e;M++)b+=y.get(M,d)*y.get(M,T);b=-b/y.get(d,d);for(let M=d;M<e;M++)y.set(M,T,y.get(M,T)+b*y.get(M,d))}for(let T=d;T<e;T++)y.set(T,d,-y.get(T,d));y.set(d,d,1+y.get(d,d));for(let T=0;T<d-1;T++)y.set(T,d,0)}else{for(let T=0;T<e;T++)y.set(T,d,0);y.set(d,d,1)}}if(c)for(let d=n-1;d>=0;d--){if(d<p&&I[d]!==0)for(let T=d+1;T<n;T++){let b=0;for(let M=d+1;M<n;M++)b+=E.get(M,d)*E.get(M,T);b=-b/E.get(d+1,d);for(let M=d+1;M<n;M++)E.set(M,T,E.get(M,T)+b*E.get(M,d))}for(let T=0;T<n;T++)E.set(T,d,0);E.set(d,d,1)}let k=A-1,_=Number.EPSILON;for(;A>0;){let d,T;for(d=A-2;d>=-1&&d!==-1;d--){const b=Number.MIN_VALUE+_*Math.abs(v[d]+Math.abs(v[d+1]));if(Math.abs(I[d])<=b||Number.isNaN(I[d])){I[d]=0;break}}if(d===A-2)T=4;else{let b;for(b=A-1;b>=d&&b!==d;b--){let M=(b!==A?Math.abs(I[b]):0)+(b!==d+1?Math.abs(I[b-1]):0);if(Math.abs(v[b])<=_*M){v[b]=0;break}}b===d?T=3:b===A-1?T=1:(T=2,d=b)}switch(d++,T){case 1:{let b=I[A-2];I[A-2]=0;for(let M=A-2;M>=d;M--){let z=Ft(v[M],b),q=v[M]/z,X=b/z;if(v[M]=z,M!==d&&(b=-X*I[M-1],I[M-1]=q*I[M-1]),c)for(let V=0;V<n;V++)z=q*E.get(V,M)+X*E.get(V,A-1),E.set(V,A-1,-X*E.get(V,M)+q*E.get(V,A-1)),E.set(V,M,z)}break}case 2:{let b=I[d-1];I[d-1]=0;for(let M=d;M<A;M++){let z=Ft(v[M],b),q=v[M]/z,X=b/z;if(v[M]=z,b=-X*I[M],I[M]=q*I[M],o)for(let V=0;V<e;V++)z=q*y.get(V,M)+X*y.get(V,d-1),y.set(V,d-1,-X*y.get(V,M)+q*y.get(V,d-1)),y.set(V,M,z)}break}case 3:{const b=Math.max(Math.abs(v[A-1]),Math.abs(v[A-2]),Math.abs(I[A-2]),Math.abs(v[d]),Math.abs(I[d])),M=v[A-1]/b,z=v[A-2]/b,q=I[A-2]/b,X=v[d]/b,V=I[d]/b,rt=((z+M)*(z-M)+q*q)/2,ot=M*q*(M*q);let dt=0;(rt!==0||ot!==0)&&(rt<0?dt=0-Math.sqrt(rt*rt+ot):dt=Math.sqrt(rt*rt+ot),dt=ot/(rt+dt));let K=(X+M)*(X-M)+dt,xt=X*V;for(let W=d;W<A-1;W++){let et=Ft(K,xt);et===0&&(et=Number.MIN_VALUE);let ft=K/et,ht=xt/et;if(W!==d&&(I[W-1]=et),K=ft*v[W]+ht*I[W],I[W]=ft*I[W]-ht*v[W],xt=ht*v[W+1],v[W+1]=ft*v[W+1],c)for(let it=0;it<n;it++)et=ft*E.get(it,W)+ht*E.get(it,W+1),E.set(it,W+1,-ht*E.get(it,W)+ft*E.get(it,W+1)),E.set(it,W,et);if(et=Ft(K,xt),et===0&&(et=Number.MIN_VALUE),ft=K/et,ht=xt/et,v[W]=et,K=ft*I[W]+ht*v[W+1],v[W+1]=-ht*I[W]+ft*v[W+1],xt=ht*I[W+1],I[W+1]=ft*I[W+1],o&&W<e-1)for(let it=0;it<e;it++)et=ft*y.get(it,W)+ht*y.get(it,W+1),y.set(it,W+1,-ht*y.get(it,W)+ft*y.get(it,W+1)),y.set(it,W,et)}I[A-2]=K;break}case 4:{if(v[d]<=0&&(v[d]=v[d]<0?-v[d]:0,c))for(let b=0;b<=k;b++)E.set(b,d,-E.get(b,d));for(;d<k&&!(v[d]>=v[d+1]);){let b=v[d];if(v[d]=v[d+1],v[d+1]=b,c&&d<n-1)for(let M=0;M<n;M++)b=E.get(M,d+1),E.set(M,d+1,E.get(M,d)),E.set(M,d,b);if(o&&d<e-1)for(let M=0;M<e;M++)b=y.get(M,d+1),y.set(M,d+1,y.get(M,d)),y.set(M,d,b);d++}A--;break}}}if(h){let d=E;E=y,y=d}this.m=e,this.n=n,this.s=v,this.U=y,this.V=E}solve(r){let t=r,e=this.threshold,n=this.s.length,i=P.zeros(n,n);for(let u=0;u<n;u++)Math.abs(this.s[u])<=e?i.set(u,u,0):i.set(u,u,1/this.s[u]);let s=this.U,a=this.rightSingularVectors,o=a.mmul(i),c=a.rows,h=s.rows,l=P.zeros(c,h);for(let u=0;u<c;u++)for(let g=0;g<h;g++){let v=0;for(let y=0;y<n;y++)v+=o.get(u,y)*s.get(g,y);l.set(u,g,v)}return l.mmul(t)}solveForDiagonal(r){return this.solve(P.diag(r))}inverse(){let r=this.V,t=this.threshold,e=r.rows,n=r.columns,i=new P(e,this.s.length);for(let h=0;h<e;h++)for(let l=0;l<n;l++)Math.abs(this.s[l])>t&&i.set(h,l,r.get(h,l)/this.s[l]);let s=this.U,a=s.rows,o=s.columns,c=new P(e,a);for(let h=0;h<e;h++)for(let l=0;l<a;l++){let u=0;for(let g=0;g<o;g++)u+=i.get(h,g)*s.get(l,g);c.set(h,l,u)}return c}get condition(){return this.s[0]/this.s[Math.min(this.m,this.n)-1]}get norm2(){return this.s[0]}get rank(){let r=Math.max(this.m,this.n)*this.s[0]*Number.EPSILON,t=0,e=this.s;for(let n=0,i=e.length;n<i;n++)e[n]>r&&t++;return t}get diagonal(){return Array.from(this.s)}get threshold(){return Number.EPSILON/2*Math.max(this.m,this.n)*this.s[0]}get leftSingularVectors(){return this.U}get rightSingularVectors(){return this.V}get diagonalMatrix(){return P.diag(this.s)}};function eh(r,t=!1){return r=vt.checkMatrix(r),t?new ce(r).inverse():rs(r,P.eye(r.rows))}function rs(r,t,e=!1){return r=vt.checkMatrix(r),t=vt.checkMatrix(t),e?new ce(r).solve(t):r.isSquare()?new Tr(r).solve(t):new gn(r).solve(t)}function xr(r){if(r=P.checkMatrix(r),r.isSquare()){if(r.columns===0)return 1;let t,e,n,i;if(r.columns===2)return t=r.get(0,0),e=r.get(0,1),n=r.get(1,0),i=r.get(1,1),t*i-e*n;if(r.columns===3){let s,a,o;return s=new wr(r,[1,2],[1,2]),a=new wr(r,[1,2],[0,2]),o=new wr(r,[1,2],[0,1]),t=r.get(0,0),e=r.get(0,1),n=r.get(0,2),t*xr(s)-e*xr(a)+n*xr(o)}else return new Tr(r).determinant}else throw Error("determinant can only be calculated for a square matrix")}function rh(r,t){let e=[];for(let n=0;n<r;n++)n!==t&&e.push(n);return e}function nh(r,t,e,n=1e-9,i=1e-9){if(r>i)return new Array(t.rows+1).fill(0);{let s=t.addRow(e,[0]);for(let a=0;a<s.rows;a++)Math.abs(s.get(a,0))<n&&s.set(a,0,0);return s.to1DArray()}}function ih(r,t={}){const{thresholdValue:e=1e-9,thresholdError:n=1e-9}=t;r=P.checkMatrix(r);let i=r.rows,s=new P(i,i);for(let a=0;a<i;a++){let o=P.columnVector(r.getRow(a)),c=r.subMatrixRow(rh(i,a)).transpose(),h=new ce(c).solve(o),l=P.sub(o,c.mmul(h)).abs().max();s.setRow(a,nh(l,h,a,e,n))}return s}function sh(r,t=Number.EPSILON){if(r=P.checkMatrix(r),r.isEmpty())return r.transpose();let e=new ce(r,{autoTranspose:!0}),n=e.leftSingularVectors,i=e.rightSingularVectors,s=e.diagonal;for(let a=0;a<s.length;a++)Math.abs(s[a])>t?s[a]=1/s[a]:s[a]=0;return i.mmul(P.diag(s).mmul(n.transpose()))}function oh(r,t=r,e={}){r=new P(r);let n=!1;if(typeof t=="object"&&!P.isMatrix(t)&&!yt.isAnyArray(t)?(e=t,t=r,n=!0):t=new P(t),r.rows!==t.rows)throw new TypeError("Both matrices must have the same number of rows");const{center:i=!0}=e;i&&(r=r.center("column"),n||(t=t.center("column")));const s=r.transpose().mmul(t);for(let a=0;a<s.rows;a++)for(let o=0;o<s.columns;o++)s.set(a,o,s.get(a,o)*(1/(r.rows-1)));return s}function ah(r,t=r,e={}){r=new P(r);let n=!1;if(typeof t=="object"&&!P.isMatrix(t)&&!yt.isAnyArray(t)?(e=t,t=r,n=!0):t=new P(t),r.rows!==t.rows)throw new TypeError("Both matrices must have the same number of rows");const{center:i=!0,scale:s=!0}=e;i&&(r.center("column"),n||t.center("column")),s&&(r.scale("column"),n||t.scale("column"));const a=r.standardDeviation("column",{unbiased:!0}),o=n?a:t.standardDeviation("column",{unbiased:!0}),c=r.transpose().mmul(t);for(let h=0;h<c.rows;h++)for(let l=0;l<c.columns;l++)c.set(h,l,c.get(h,l)*(1/(a[h]*o[l]))*(1/(r.rows-1)));return c}class ns{constructor(t,e={}){const{assumeSymmetric:n=!1}=e;if(t=vt.checkMatrix(t),!t.isSquare())throw new Error("Matrix is not a square matrix");if(t.isEmpty())throw new Error("Matrix must be non-empty");let i=t.columns,s=new P(i,i),a=new Float64Array(i),o=new Float64Array(i),c=t,h,l,u=!1;if(n?u=!0:u=t.isSymmetric(),u){for(h=0;h<i;h++)for(l=0;l<i;l++)s.set(h,l,c.get(h,l));ch(i,o,a,s),hh(i,o,a,s)}else{let g=new P(i,i),v=new Float64Array(i);for(l=0;l<i;l++)for(h=0;h<i;h++)g.set(h,l,c.get(h,l));lh(i,g,v,s),uh(i,o,a,s,g)}this.n=i,this.e=o,this.d=a,this.V=s}get realEigenvalues(){return Array.from(this.d)}get imaginaryEigenvalues(){return Array.from(this.e)}get eigenvectorMatrix(){return this.V}get diagonalMatrix(){let t=this.n,e=this.e,n=this.d,i=new P(t,t),s,a;for(s=0;s<t;s++){for(a=0;a<t;a++)i.set(s,a,0);i.set(s,s,n[s]),e[s]>0?i.set(s,s+1,e[s]):e[s]<0&&i.set(s,s-1,e[s])}return i}}function ch(r,t,e,n){let i,s,a,o,c,h,l,u;for(c=0;c<r;c++)e[c]=n.get(r-1,c);for(o=r-1;o>0;o--){for(u=0,a=0,h=0;h<o;h++)u=u+Math.abs(e[h]);if(u===0)for(t[o]=e[o-1],c=0;c<o;c++)e[c]=n.get(o-1,c),n.set(o,c,0),n.set(c,o,0);else{for(h=0;h<o;h++)e[h]/=u,a+=e[h]*e[h];for(i=e[o-1],s=Math.sqrt(a),i>0&&(s=-s),t[o]=u*s,a=a-i*s,e[o-1]=i-s,c=0;c<o;c++)t[c]=0;for(c=0;c<o;c++){for(i=e[c],n.set(c,o,i),s=t[c]+n.get(c,c)*i,h=c+1;h<=o-1;h++)s+=n.get(h,c)*e[h],t[h]+=n.get(h,c)*i;t[c]=s}for(i=0,c=0;c<o;c++)t[c]/=a,i+=t[c]*e[c];for(l=i/(a+a),c=0;c<o;c++)t[c]-=l*e[c];for(c=0;c<o;c++){for(i=e[c],s=t[c],h=c;h<=o-1;h++)n.set(h,c,n.get(h,c)-(i*t[h]+s*e[h]));e[c]=n.get(o-1,c),n.set(o,c,0)}}e[o]=a}for(o=0;o<r-1;o++){if(n.set(r-1,o,n.get(o,o)),n.set(o,o,1),a=e[o+1],a!==0){for(h=0;h<=o;h++)e[h]=n.get(h,o+1)/a;for(c=0;c<=o;c++){for(s=0,h=0;h<=o;h++)s+=n.get(h,o+1)*n.get(h,c);for(h=0;h<=o;h++)n.set(h,c,n.get(h,c)-s*e[h])}}for(h=0;h<=o;h++)n.set(h,o+1,0)}for(c=0;c<r;c++)e[c]=n.get(r-1,c),n.set(r-1,c,0);n.set(r-1,r-1,1),t[0]=0}function hh(r,t,e,n){let i,s,a,o,c,h,l,u,g,v,y,E,I,w,S,f;for(a=1;a<r;a++)t[a-1]=t[a];t[r-1]=0;let p=0,x=0,A=Number.EPSILON;for(h=0;h<r;h++){for(x=Math.max(x,Math.abs(e[h])+Math.abs(t[h])),l=h;l<r&&!(Math.abs(t[l])<=A*x);)l++;if(l>h)do{for(i=e[h],u=(e[h+1]-i)/(2*t[h]),g=Ft(u,1),u<0&&(g=-g),e[h]=t[h]/(u+g),e[h+1]=t[h]*(u+g),v=e[h+1],s=i-e[h],a=h+2;a<r;a++)e[a]-=s;for(p=p+s,u=e[l],y=1,E=y,I=y,w=t[h+1],S=0,f=0,a=l-1;a>=h;a--)for(I=E,E=y,f=S,i=y*t[a],s=y*u,g=Ft(u,t[a]),t[a+1]=S*g,S=t[a]/g,y=u/g,u=y*e[a]-S*i,e[a+1]=s+S*(y*i+S*e[a]),c=0;c<r;c++)s=n.get(c,a+1),n.set(c,a+1,S*n.get(c,a)+y*s),n.set(c,a,y*n.get(c,a)-S*s);u=-S*f*I*w*t[h]/v,t[h]=S*u,e[h]=y*u}while(Math.abs(t[h])>A*x);e[h]=e[h]+p,t[h]=0}for(a=0;a<r-1;a++){for(c=a,u=e[a],o=a+1;o<r;o++)e[o]<u&&(c=o,u=e[o]);if(c!==a)for(e[c]=e[a],e[a]=u,o=0;o<r;o++)u=n.get(o,a),n.set(o,a,n.get(o,c)),n.set(o,c,u)}}function lh(r,t,e,n){let i=0,s=r-1,a,o,c,h,l,u,g;for(u=i+1;u<=s-1;u++){for(g=0,h=u;h<=s;h++)g=g+Math.abs(t.get(h,u-1));if(g!==0){for(c=0,h=s;h>=u;h--)e[h]=t.get(h,u-1)/g,c+=e[h]*e[h];for(o=Math.sqrt(c),e[u]>0&&(o=-o),c=c-e[u]*o,e[u]=e[u]-o,l=u;l<r;l++){for(a=0,h=s;h>=u;h--)a+=e[h]*t.get(h,l);for(a=a/c,h=u;h<=s;h++)t.set(h,l,t.get(h,l)-a*e[h])}for(h=0;h<=s;h++){for(a=0,l=s;l>=u;l--)a+=e[l]*t.get(h,l);for(a=a/c,l=u;l<=s;l++)t.set(h,l,t.get(h,l)-a*e[l])}e[u]=g*e[u],t.set(u,u-1,g*o)}}for(h=0;h<r;h++)for(l=0;l<r;l++)n.set(h,l,h===l?1:0);for(u=s-1;u>=i+1;u--)if(t.get(u,u-1)!==0){for(h=u+1;h<=s;h++)e[h]=t.get(h,u-1);for(l=u;l<=s;l++){for(o=0,h=u;h<=s;h++)o+=e[h]*n.get(h,l);for(o=o/e[u]/t.get(u,u-1),h=u;h<=s;h++)n.set(h,l,n.get(h,l)+o*e[h])}}}function uh(r,t,e,n,i){let s=r-1,a=0,o=r-1,c=Number.EPSILON,h=0,l=0,u=0,g=0,v=0,y=0,E=0,I=0,w,S,f,p,x,A,k,_,d,T,b,M,z,q,X;for(w=0;w<r;w++)for((w<a||w>o)&&(e[w]=i.get(w,w),t[w]=0),S=Math.max(w-1,0);S<r;S++)l=l+Math.abs(i.get(w,S));for(;s>=a;){for(p=s;p>a&&(y=Math.abs(i.get(p-1,p-1))+Math.abs(i.get(p,p)),y===0&&(y=l),!(Math.abs(i.get(p,p-1))<c*y));)p--;if(p===s)i.set(s,s,i.get(s,s)+h),e[s]=i.get(s,s),t[s]=0,s--,I=0;else if(p===s-1){if(k=i.get(s,s-1)*i.get(s-1,s),u=(i.get(s-1,s-1)-i.get(s,s))/2,g=u*u+k,E=Math.sqrt(Math.abs(g)),i.set(s,s,i.get(s,s)+h),i.set(s-1,s-1,i.get(s-1,s-1)+h),_=i.get(s,s),g>=0){for(E=u>=0?u+E:u-E,e[s-1]=_+E,e[s]=e[s-1],E!==0&&(e[s]=_-k/E),t[s-1]=0,t[s]=0,_=i.get(s,s-1),y=Math.abs(_)+Math.abs(E),u=_/y,g=E/y,v=Math.sqrt(u*u+g*g),u=u/v,g=g/v,S=s-1;S<r;S++)E=i.get(s-1,S),i.set(s-1,S,g*E+u*i.get(s,S)),i.set(s,S,g*i.get(s,S)-u*E);for(w=0;w<=s;w++)E=i.get(w,s-1),i.set(w,s-1,g*E+u*i.get(w,s)),i.set(w,s,g*i.get(w,s)-u*E);for(w=a;w<=o;w++)E=n.get(w,s-1),n.set(w,s-1,g*E+u*n.get(w,s)),n.set(w,s,g*n.get(w,s)-u*E)}else e[s-1]=_+u,e[s]=_+u,t[s-1]=E,t[s]=-E;s=s-2,I=0}else{if(_=i.get(s,s),d=0,k=0,p<s&&(d=i.get(s-1,s-1),k=i.get(s,s-1)*i.get(s-1,s)),I===10){for(h+=_,w=a;w<=s;w++)i.set(w,w,i.get(w,w)-_);y=Math.abs(i.get(s,s-1))+Math.abs(i.get(s-1,s-2)),_=d=.75*y,k=-.4375*y*y}if(I===30&&(y=(d-_)/2,y=y*y+k,y>0)){for(y=Math.sqrt(y),d<_&&(y=-y),y=_-k/((d-_)/2+y),w=a;w<=s;w++)i.set(w,w,i.get(w,w)-y);h+=y,_=d=k=.964}for(I=I+1,x=s-2;x>=p&&(E=i.get(x,x),v=_-E,y=d-E,u=(v*y-k)/i.get(x+1,x)+i.get(x,x+1),g=i.get(x+1,x+1)-E-v-y,v=i.get(x+2,x+1),y=Math.abs(u)+Math.abs(g)+Math.abs(v),u=u/y,g=g/y,v=v/y,!(x===p||Math.abs(i.get(x,x-1))*(Math.abs(g)+Math.abs(v))<c*(Math.abs(u)*(Math.abs(i.get(x-1,x-1))+Math.abs(E)+Math.abs(i.get(x+1,x+1))))));)x--;for(w=x+2;w<=s;w++)i.set(w,w-2,0),w>x+2&&i.set(w,w-3,0);for(f=x;f<=s-1&&(q=f!==s-1,f!==x&&(u=i.get(f,f-1),g=i.get(f+1,f-1),v=q?i.get(f+2,f-1):0,_=Math.abs(u)+Math.abs(g)+Math.abs(v),_!==0&&(u=u/_,g=g/_,v=v/_)),_!==0);f++)if(y=Math.sqrt(u*u+g*g+v*v),u<0&&(y=-y),y!==0){for(f!==x?i.set(f,f-1,-y*_):p!==x&&i.set(f,f-1,-i.get(f,f-1)),u=u+y,_=u/y,d=g/y,E=v/y,g=g/u,v=v/u,S=f;S<r;S++)u=i.get(f,S)+g*i.get(f+1,S),q&&(u=u+v*i.get(f+2,S),i.set(f+2,S,i.get(f+2,S)-u*E)),i.set(f,S,i.get(f,S)-u*_),i.set(f+1,S,i.get(f+1,S)-u*d);for(w=0;w<=Math.min(s,f+3);w++)u=_*i.get(w,f)+d*i.get(w,f+1),q&&(u=u+E*i.get(w,f+2),i.set(w,f+2,i.get(w,f+2)-u*v)),i.set(w,f,i.get(w,f)-u),i.set(w,f+1,i.get(w,f+1)-u*g);for(w=a;w<=o;w++)u=_*n.get(w,f)+d*n.get(w,f+1),q&&(u=u+E*n.get(w,f+2),n.set(w,f+2,n.get(w,f+2)-u*v)),n.set(w,f,n.get(w,f)-u),n.set(w,f+1,n.get(w,f+1)-u*g)}}}if(l!==0){for(s=r-1;s>=0;s--)if(u=e[s],g=t[s],g===0)for(p=s,i.set(s,s,1),w=s-1;w>=0;w--){for(k=i.get(w,w)-u,v=0,S=p;S<=s;S++)v=v+i.get(w,S)*i.get(S,s);if(t[w]<0)E=k,y=v;else if(p=w,t[w]===0?i.set(w,s,k!==0?-v/k:-v/(c*l)):(_=i.get(w,w+1),d=i.get(w+1,w),g=(e[w]-u)*(e[w]-u)+t[w]*t[w],A=(_*y-E*v)/g,i.set(w,s,A),i.set(w+1,s,Math.abs(_)>Math.abs(E)?(-v-k*A)/_:(-y-d*A)/E)),A=Math.abs(i.get(w,s)),c*A*A>1)for(S=w;S<=s;S++)i.set(S,s,i.get(S,s)/A)}else if(g<0)for(p=s-1,Math.abs(i.get(s,s-1))>Math.abs(i.get(s-1,s))?(i.set(s-1,s-1,g/i.get(s,s-1)),i.set(s-1,s,-(i.get(s,s)-u)/i.get(s,s-1))):(X=Mr(0,-i.get(s-1,s),i.get(s-1,s-1)-u,g),i.set(s-1,s-1,X[0]),i.set(s-1,s,X[1])),i.set(s,s-1,0),i.set(s,s,1),w=s-2;w>=0;w--){for(T=0,b=0,S=p;S<=s;S++)T=T+i.get(w,S)*i.get(S,s-1),b=b+i.get(w,S)*i.get(S,s);if(k=i.get(w,w)-u,t[w]<0)E=k,v=T,y=b;else if(p=w,t[w]===0?(X=Mr(-T,-b,k,g),i.set(w,s-1,X[0]),i.set(w,s,X[1])):(_=i.get(w,w+1),d=i.get(w+1,w),M=(e[w]-u)*(e[w]-u)+t[w]*t[w]-g*g,z=(e[w]-u)*2*g,M===0&&z===0&&(M=c*l*(Math.abs(k)+Math.abs(g)+Math.abs(_)+Math.abs(d)+Math.abs(E))),X=Mr(_*v-E*T+g*b,_*y-E*b-g*T,M,z),i.set(w,s-1,X[0]),i.set(w,s,X[1]),Math.abs(_)>Math.abs(E)+Math.abs(g)?(i.set(w+1,s-1,(-T-k*i.get(w,s-1)+g*i.get(w,s))/_),i.set(w+1,s,(-b-k*i.get(w,s)-g*i.get(w,s-1))/_)):(X=Mr(-v-d*i.get(w,s-1),-y-d*i.get(w,s),E,g),i.set(w+1,s-1,X[0]),i.set(w+1,s,X[1]))),A=Math.max(Math.abs(i.get(w,s-1)),Math.abs(i.get(w,s))),c*A*A>1)for(S=w;S<=s;S++)i.set(S,s-1,i.get(S,s-1)/A),i.set(S,s,i.get(S,s)/A)}for(w=0;w<r;w++)if(w<a||w>o)for(S=w;S<r;S++)n.set(w,S,i.get(w,S));for(S=r-1;S>=a;S--)for(w=a;w<=o;w++){for(E=0,f=a;f<=Math.min(S,o);f++)E=E+n.get(w,f)*i.get(f,S);n.set(w,S,E)}}}function Mr(r,t,e,n){let i,s;return Math.abs(e)>Math.abs(n)?(i=n/e,s=e+i*n,[(r+i*t)/s,(t-i*r)/s]):(i=e/n,s=n+i*e,[(i*r+t)/s,(i*t-r)/s])}class is{constructor(t){if(t=vt.checkMatrix(t),!t.isSymmetric())throw new Error("Matrix is not symmetric");let e=t,n=e.rows,i=new P(n,n),s=!0,a,o,c;for(o=0;o<n;o++){let h=0;for(c=0;c<o;c++){let l=0;for(a=0;a<c;a++)l+=i.get(c,a)*i.get(o,a);l=(e.get(o,c)-l)/i.get(c,c),i.set(o,c,l),h=h+l*l}for(h=e.get(o,o)-h,s&=h>0,i.set(o,o,Math.sqrt(Math.max(h,0))),c=o+1;c<n;c++)i.set(o,c,0)}this.L=i,this.positiveDefinite=!!s}isPositiveDefinite(){return this.positiveDefinite}solve(t){t=vt.checkMatrix(t);let e=this.L,n=e.rows;if(t.rows!==n)throw new Error("Matrix dimensions do not match");if(this.isPositiveDefinite()===!1)throw new Error("Matrix is not positive definite");let i=t.columns,s=t.clone(),a,o,c;for(c=0;c<n;c++)for(o=0;o<i;o++){for(a=0;a<c;a++)s.set(c,o,s.get(c,o)-s.get(a,o)*e.get(c,a));s.set(c,o,s.get(c,o)/e.get(c,c))}for(c=n-1;c>=0;c--)for(o=0;o<i;o++){for(a=c+1;a<n;a++)s.set(c,o,s.get(c,o)-s.get(a,o)*e.get(a,c));s.set(c,o,s.get(c,o)/e.get(c,c))}return s}get lowerTriangularMatrix(){return this.L}}class ss{constructor(t,e={}){t=vt.checkMatrix(t);let{Y:n}=e;const{scaleScores:i=!1,maxIterations:s=1e3,terminationCriteria:a=1e-10}=e;let o;if(n){if(yt.isAnyArray(n)&&typeof n[0]=="number"?n=P.columnVector(n):n=vt.checkMatrix(n),n.rows!==t.rows)throw new Error("Y should have the same number of rows as X");o=n.getColumnVector(0)}else o=t.getColumnVector(0);let c=1,h,l,u,g;for(let v=0;v<s&&c>a;v++)u=t.transpose().mmul(o).div(o.transpose().mmul(o).get(0,0)),u=u.div(u.norm()),h=t.mmul(u).div(u.transpose().mmul(u).get(0,0)),v>0&&(c=h.clone().sub(g).pow(2).sum()),g=h.clone(),n?(l=n.transpose().mmul(h).div(h.transpose().mmul(h).get(0,0)),l=l.div(l.norm()),o=n.mmul(l).div(l.transpose().mmul(l).get(0,0))):o=h;if(n){let v=t.transpose().mmul(h).div(h.transpose().mmul(h).get(0,0));v=v.div(v.norm());let y=t.clone().sub(h.clone().mmul(v.transpose())),E=o.transpose().mmul(h).div(h.transpose().mmul(h).get(0,0)),I=n.clone().sub(h.clone().mulS(E.get(0,0)).mmul(l.transpose()));this.t=h,this.p=v.transpose(),this.w=u.transpose(),this.q=l,this.u=o,this.s=h.transpose().mmul(h),this.xResidual=y,this.yResidual=I,this.betas=E}else this.w=u.transpose(),this.s=h.transpose().mmul(h).sqrt(),i?this.t=h.clone().div(this.s.get(0,0)):this.t=h,this.xResidual=t.sub(h.mmul(u.transpose()))}}Z.AbstractMatrix=G,Z.CHO=is,Z.CholeskyDecomposition=is,Z.DistanceMatrix=vr,Z.EVD=ns,Z.EigenvalueDecomposition=ns,Z.LU=Tr,Z.LuDecomposition=Tr;var dh=Z.Matrix=P;Z.MatrixColumnSelectionView=Xc,Z.MatrixColumnView=$c,Z.MatrixFlipColumnView=qc,Z.MatrixFlipRowView=Hc,Z.MatrixRowSelectionView=Jc,Z.MatrixRowView=Yc,Z.MatrixSelectionView=wr,Z.MatrixSubView=Kc,Z.MatrixTransposeView=Qc,Z.NIPALS=ss,Z.Nipals=ss,Z.QR=gn,Z.QrDecomposition=gn,Z.SVD=ce;var fh=Z.SingularValueDecomposition=ce;Z.SymmetricMatrix=Ne,Z.WrapperMatrix1D=es,Z.WrapperMatrix2D=vt,Z.correlation=ah,Z.covariance=oh;var os=Z.default=P;Z.determinant=xr;var ph=Z.inverse=eh;Z.linearDependencies=ih;var gh=Z.pseudoInverse=sh;Z.solve=rs,Z.wrap=th;const ct=dh,mh=fh;os.Matrix&&os.Matrix;const yh=ph,as=gh;class vh{constructor(t,e){if(this.sourcePoints=t,this.destinationPoints=e,this.pointCount=this.sourcePoints.length,this.pointCount<2)throw new Error("Not enough control points. A helmert transformation requires a minimum of 2 points, but "+this.pointCount+" are given.");const n=ct.columnVector(e.flat()),i=ct.zeros(2*this.pointCount,4);for(let a=0;a<this.pointCount;a++)i.set(2*a,0,1),i.set(2*a,1,0),i.set(2*a,2,t[a][0]),i.set(2*a,3,-t[a][1]),i.set(2*a+1,0,0),i.set(2*a+1,1,1),i.set(2*a+1,2,t[a][1]),i.set(2*a+1,3,t[a][0]);const s=as(i);this.helmertParametersMatrix=s.mmul(n)}interpolate(t){if(!this.helmertParametersMatrix)throw new Error("Helmert parameters not computed");return[this.helmertParametersMatrix.get(0,0)+this.helmertParametersMatrix.get(2,0)*t[0]-this.helmertParametersMatrix.get(3,0)*t[1],this.helmertParametersMatrix.get(1,0)+this.helmertParametersMatrix.get(3,0)*t[0]+this.helmertParametersMatrix.get(2,0)*t[1]]}}class mn{constructor(t,e,n){if(this.sourcePoints=t,this.destinationPoints=e,this.pointCount=this.sourcePoints.length,this.order=n||1,this.nCoefs=(this.order+1)*(this.order+2)/2,this.pointCount<this.nCoefs)throw new Error("Not enough control points. A polynomial transformation of order "+this.order+" requires a minimum of "+this.nCoefs+" points, but "+this.pointCount+" are given.");if(this.order<1||this.order>3)throw new Error("Only polynomial transformations of order 1, 2 or 3 are supported");const i=[ct.columnVector(e.map(o=>o[0])),ct.columnVector(e.map(o=>o[1]))],s=ct.zeros(this.pointCount,this.nCoefs);for(let o=0;o<this.pointCount;o++)switch(this.order){case 1:s.set(o,0,1),s.set(o,1,t[o][0]),s.set(o,2,t[o][1]);break;case 2:s.set(o,0,1),s.set(o,1,t[o][0]),s.set(o,2,t[o][1]),s.set(o,3,t[o][0]**2),s.set(o,4,t[o][1]**2),s.set(o,5,t[o][0]*t[o][1]);break;case 3:s.set(o,0,1),s.set(o,1,t[o][0]),s.set(o,2,t[o][1]),s.set(o,3,t[o][0]**2),s.set(o,4,t[o][1]**2),s.set(o,5,t[o][0]*t[o][1]),s.set(o,6,t[o][0]**3),s.set(o,7,t[o][1]**3),s.set(o,8,t[o][0]**2*t[o][1]),s.set(o,9,t[o][0]*t[o][1]**2);break}const a=as(s);this.polynomialParametersMatrices=[a.mmul(i[0]),a.mmul(i[1])]}interpolate(t){if(!this.polynomialParametersMatrices)throw new Error("Polynomial parameters not computed");const e=[0,0];for(let n=0;n<2;n++)switch(this.order){case 1:e[n]+=this.polynomialParametersMatrices[n].get(0,0)+this.polynomialParametersMatrices[n].get(1,0)*t[0]+this.polynomialParametersMatrices[n].get(2,0)*t[1];break;case 2:e[n]+=this.polynomialParametersMatrices[n].get(0,0)+this.polynomialParametersMatrices[n].get(1,0)*t[0]+this.polynomialParametersMatrices[n].get(2,0)*t[1]+this.polynomialParametersMatrices[n].get(3,0)*t[0]**2+this.polynomialParametersMatrices[n].get(4,0)*t[1]**2+this.polynomialParametersMatrices[n].get(5,0)*t[0]*t[1];break;case 3:e[n]+=this.polynomialParametersMatrices[n].get(0,0)+this.polynomialParametersMatrices[n].get(1,0)*t[0]+this.polynomialParametersMatrices[n].get(2,0)*t[1]+this.polynomialParametersMatrices[n].get(3,0)*t[0]**2+this.polynomialParametersMatrices[n].get(4,0)*t[1]**2+this.polynomialParametersMatrices[n].get(5,0)*t[0]*t[1]+this.polynomialParametersMatrices[n].get(6,0)*t[0]**3+this.polynomialParametersMatrices[n].get(7,0)*t[1]**3+this.polynomialParametersMatrices[n].get(8,0)*t[0]**2*t[1]+this.polynomialParametersMatrices[n].get(9,0)*t[0]*t[1]**2;break}return e}}class wh{constructor(t,e){if(this.sourcePoints=t,this.destinationPoints=e,this.pointCount=this.sourcePoints.length,this.pointCount<4)throw new Error("Not enough control points. A projective transformation requires a minimum of 4 points, but "+this.pointCount+" are given.");const n=ct.zeros(2*this.pointCount,9);for(let s=0;s<this.pointCount;s++)n.set(2*s,0,-t[s][0]),n.set(2*s,1,-t[s][1]),n.set(2*s,2,-1),n.set(2*s,3,0),n.set(2*s,4,0),n.set(2*s,5,0),n.set(2*s,6,e[s][0]*t[s][0]),n.set(2*s,7,e[s][0]*t[s][1]),n.set(2*s,8,e[s][0]),n.set(2*s+1,0,0),n.set(2*s+1,1,0),n.set(2*s+1,2,0),n.set(2*s+1,3,-t[s][0]),n.set(2*s+1,4,-t[s][1]),n.set(2*s+1,5,-1),n.set(2*s+1,6,e[s][1]*t[s][0]),n.set(2*s+1,7,e[s][1]*t[s][1]),n.set(2*s+1,8,e[s][1]);const i=new mh(n);this.projectiveParametersMatrix=ct.from1DArray(3,3,i.rightSingularVectors.getColumn(8)).transpose()}interpolate(t){if(!this.projectiveParametersMatrix)throw new Error("projective parameters not computed");const e=this.projectiveParametersMatrix.get(0,2)*t[0]+this.projectiveParametersMatrix.get(1,2)*t[1]+this.projectiveParametersMatrix.get(2,2);return[(this.projectiveParametersMatrix.get(0,0)*t[0]+this.projectiveParametersMatrix.get(1,0)*t[1]+this.projectiveParametersMatrix.get(2,0))/e,(this.projectiveParametersMatrix.get(0,1)*t[0]+this.projectiveParametersMatrix.get(1,1)*t[1]+this.projectiveParametersMatrix.get(2,1))/e]}}function Th(r,t){if(r=ct.checkMatrix(r),t=ct.checkMatrix(t),r.rows!=t.rows||r.columns!=t.columns)throw new Error("Matrices have different dimensions");const e=ct.zeros(r.rows,r.columns);for(let n=0;n<r.rows;n++)for(let i=0;i<r.columns;i++)e.set(n,i,r.get(n,i)*t.get(n,i));return e}class xh{constructor(t,e,n,i,s){if(this.sourcePoints=t,this.destinationPoints=e,this.kernelFunction=n,this.normFunction=i,this.pointCount=this.sourcePoints.length,this.pointCount<3)throw new Error(`Not enough control points. A thin plate spline transformation (with affine component) requires a minimum of 3 points, but ${this.pointCount} are given.`);const a=[ct.columnVector([...e,[0,0],[0,0],[0,0]].map(u=>u[0])),ct.columnVector([...e,[0,0],[0,0],[0,0]].map(u=>u[1]))],o=ct.zeros(this.pointCount,this.pointCount);for(let u=0;u<this.pointCount;u++)for(let g=0;g<this.pointCount;g++)o.set(u,g,i(t[u],t[g]));s===void 0&&(s=o.sum()/(Math.pow(this.pointCount,2)-this.pointCount)),this.epsilon=s;for(let u=0;u<this.pointCount;u++)for(let g=0;g<this.pointCount;g++)o.set(u,g,n(o.get(u,g),s));const c=ct.zeros(this.pointCount,3),h=ct.zeros(this.pointCount+3,this.pointCount+3);for(let u=0;u<this.pointCount;u++)c.set(u,0,1),c.set(u,1,t[u][0]),c.set(u,2,t[u][1]);for(let u=0;u<this.pointCount+3;u++)for(let g=0;g<this.pointCount+3;g++)u<this.pointCount&&g<this.pointCount?h.set(u,g,o.get(u,g)):u>=this.pointCount&&g<this.pointCount?h.set(u,g,c.transpose().get(u-this.pointCount,g)):u<this.pointCount&&g>=this.pointCount&&h.set(u,g,c.get(u,g-this.pointCount));const l=yh(h);this.weightsMatrices=[l.mmul(a[0]),l.mmul(a[1])]}interpolate(t){if(!this.weightsMatrices)throw new Error("Weights not computed");const e=ct.zeros(this.pointCount,1);for(let i=0;i<this.pointCount;i++)e.set(i,0,this.kernelFunction(this.normFunction(t,this.sourcePoints[i]),this.epsilon));const n=[0,0];for(let i=0;i<2;i++){n[i]=Th(e,this.weightsMatrices[i].selection([...Array(this.pointCount).keys()],[0])).sum();const s=this.weightsMatrices[i].get(this.pointCount,0),a=this.weightsMatrices[i].get(this.pointCount+1,0),o=this.weightsMatrices[i].get(this.pointCount+2,0);n[i]+=s+a*t[0]+o*t[1]}return n}}function Mh(r){return r===0?0:Math.pow(r,2)*Math.log(r)}function bh(r,t){const e=[t[0]-r[0],t[1]-r[1]];return Math.sqrt(e[0]**2+e[1]**2)}function br(r){const t={close:!1,maxOffsetRatio:0,maxDepth:0,destinationIsGeographic:!1,sourceIsGeographic:!1};return r&&r.maxDepth!==void 0&&(t.maxDepth=r.maxDepth),r&&r.maxOffsetRatio!==void 0&&(t.maxOffsetRatio=r.maxOffsetRatio),r&&r.destinationIsGeographic!==void 0&&(t.destinationIsGeographic=r.destinationIsGeographic),r&&r.sourceIsGeographic!==void 0&&(t.sourceIsGeographic=r.sourceIsGeographic),t}function _r(r,t,e){const n=br(e);t=Wi(t);const i=t.map(o=>({source:o,destination:r.transformForward(o)})),s=Ar(i,!1),a=cs(r,s,n);return Rr(a,!0).map(o=>o.destination)}function Er(r,t,e){const n=br(e);t=Wi(t);const i=t.map(o=>({source:r.transformBackward(o),destination:o})),s=Ar(i,!1),a=hs(r,s,n);return Rr(a,!0).map(o=>o.source)}function _h(r,t,e){const n=br(e);t=sn(t);const i=t.map(o=>({source:o,destination:r.transformForward(o)})),s=Ar(i,!0),a=cs(r,s,n);return Rr(a,!1).map(o=>o.destination)}function Eh(r,t,e){const n=br(e);t=sn(t);const i=t.map(o=>({source:r.transformBackward(o),destination:o})),s=Ar(i,!0),a=hs(r,s,n);return Rr(a,!1).map(o=>o.source)}function Ir(r,t,e){return t.map(n=>_h(r,n,e))}function Sr(r,t,e){return t.map(n=>Eh(r,n,e))}function Ar(r,t=!1){const e=r.length-(t?0:1),n=[];for(let i=0;i<e;i++)n.push({from:r[i],to:r[(i+1)%r.length]});return n}function Rr(r,t=!1){const e=r.map(n=>n.from);return t&&e.push(r[r.length-1].to),e}function cs(r,t,e){return e.maxDepth<=0||e.maxOffsetRatio<=0?t:t.map(n=>yn(r,n,e,0)).flat(1)}function hs(r,t,e){return e.maxDepth<=0||e.maxOffsetRatio<=0?t:t.map(n=>vn(r,n,e,0)).flat(1)}function yn(r,t,e,n){const i=(e.sourceIsGeographic?(l,u)=>ar(l,u).geometry.coordinates:ur)(t.from.source,t.to.source),s=(e.destinationIsGeographic?(l,u)=>ar(l,u).geometry.coordinates:ur)(t.from.destination,t.to.destination),a=r.transformForward(i),o=e.destinationIsGeographic?nn:Lt,c=o(t.from.destination,t.to.destination),h=o(s,a);if(n<e.maxDepth&&e.maxOffsetRatio&&h/c>e.maxOffsetRatio&&c>0){const l={source:i,destination:a};return[yn(r,{from:t.from,to:l},e,n+1),yn(r,{from:l,to:t.to},e,n+1)].flat(1)}else return t}function vn(r,t,e,n){const i=(e.destinationIsGeographic?(l,u)=>ar(l,u).geometry.coordinates:ur)(t.from.destination,t.to.destination),s=(e.sourceIsGeographic?(l,u)=>ar(l,u).geometry.coordinates:ur)(t.from.source,t.to.source),a=r.transformBackward(i),o=e.sourceIsGeographic?nn:Lt,c=o(t.from.source,t.to.source),h=o(s,a);if(n<e.maxDepth&&e.maxOffsetRatio&&h/c>e.maxOffsetRatio&&c>0){const l={source:a,destination:i};return[vn(r,{from:t.from,to:l},e,n+1),vn(r,{from:l,to:t.to},e,n+1)].flat(1)}else return t}var wn,ls,Tn,us,Cr,xn;class ds{constructor(t,e="polynomial"){if(ke(this,wn),ke(this,Tn),ke(this,Cr),t.length==0)throw new Error("No control points.");this.gcps=t.map(n=>{if("resource"in n&&"geo"in n)return{source:n.resource,destination:n.geo};if("source"in n&&"destination"in n)return n;throw new Error("Unsupported GCP type")}),this.sourcePoints=this.gcps.map(n=>n.source),this.destinationPoints=this.gcps.map(n=>n.destination),this.type=e}transformForward(t,e){if(mt(t))return this.forwardTransformation||(this.forwardTransformation=ie(this,wn,ls).call(this)),this.forwardTransformation.interpolate(t);if(Dt(t))return this.transformForward(Ae(t));if(Rt(t))return _r(this,t,e);if(jt(t))return e&&!("sourceIsGeographic"in e)&&(e.sourceIsGeographic=!0),_r(this,Re(t),e);if(Ct(t))return Ir(this,t,e);if(Bt(t))return e&&!("sourceIsGeographic"in e)&&(e.sourceIsGeographic=!0),Ir(this,Ce(t),e);throw new Error("Input type not supported")}transformForwardAsGeojson(t,e){if(mt(t))return cr(this.transformForward(t));if(Dt(t))return cr(this.transformForward(Ae(t)));if(Rt(t))return e&&!("destinationIsGeographic"in e)&&(e.destinationIsGeographic=!0),hr(_r(this,t,e));if(jt(t))return e&&!("sourceIsGeographic"in e)&&(e.sourceIsGeographic=!0),e&&!("destinationIsGeographic"in e)&&(e.destinationIsGeographic=!0),hr(_r(this,Re(t),e));if(Ct(t))return e&&!("destinationIsGeographic"in e)&&(e.destinationIsGeographic=!0),lr(Ir(this,t,e));if(Bt(t))return e&&!("sourceIsGeographic"in e)&&(e.sourceIsGeographic=!0),e&&!("destinationIsGeographic"in e)&&(e.destinationIsGeographic=!0),lr(Ir(this,Ce(t),e));throw new Error("Input type not supported")}transformBackward(t,e){if(mt(t))return this.backwardTransformation||(this.backwardTransformation=ie(this,Tn,us).call(this)),this.backwardTransformation.interpolate(t);if(Dt(t))return this.transformBackward(Ae(t));if(Rt(t))return Er(this,t,e);if(jt(t))return e&&!("destinationIsGeographic"in e)&&(e.destinationIsGeographic=!0),Er(this,Re(t),e);if(Ct(t))return Sr(this,t,e);if(Bt(t))return e&&!("destinationIsGeographic"in e)&&(e.destinationIsGeographic=!0),Sr(this,Ce(t),e);throw new Error("Input type not supported")}transformBackwardAsGeojson(t,e){if(mt(t))return cr(this.transformBackward(t));if(Dt(t))return cr(this.transformBackward(Ae(t)));if(Rt(t))return e&&!("sourceIsGeographic"in e)&&(e.sourceIsGeographic=!0),hr(Er(this,t,e));if(jt(t))return e&&!("sourceIsGeographic"in e)&&(e.sourceIsGeographic=!0),e&&!("destinationIsGeographic"in e)&&(e.destinationIsGeographic=!0),hr(Er(this,Re(t),e));if(Ct(t))return e&&!("sourceIsGeographic"in e)&&(e.sourceIsGeographic=!0),lr(Sr(this,t,e));if(Bt(t))return e&&!("sourceIsGeographic"in e)&&(e.sourceIsGeographic=!0),e&&!("destinationIsGeographic"in e)&&(e.destinationIsGeographic=!0),lr(Sr(this,Ce(t),e));throw new Error("Input type not supported")}transformToGeo(t,e){if(mt(t))return this.transformForward(t,e);if(Dt(t))return this.transformForward(t,e);if(Rt(t))return this.transformForward(t,e);if(jt(t))return this.transformForward(t,e);if(Ct(t))return this.transformForward(t,e);if(Bt(t))return this.transformForward(t,e);throw new Error("Input type not supported")}transformToGeoAsGeojson(t,e){if(mt(t))return this.transformForwardAsGeojson(t,e);if(Dt(t))return this.transformForwardAsGeojson(t,e);if(Rt(t))return this.transformForwardAsGeojson(t,e);if(jt(t))return this.transformForwardAsGeojson(t,e);if(Ct(t))return this.transformForwardAsGeojson(t,e);if(Bt(t))return this.transformForwardAsGeojson(t,e);throw new Error("Input type not supported")}transformToResource(t,e){if(mt(t))return this.transformBackward(t,e);if(Dt(t))return this.transformBackward(t,e);if(Rt(t))return this.transformBackward(t,e);if(jt(t))return this.transformBackward(t,e);if(Ct(t))return this.transformBackward(t,e);if(Bt(t))return this.transformBackward(t,e);throw new Error("Input type not supported")}transformToResourceAsGeojson(t,e){if(mt(t))return this.transformBackwardAsGeojson(t,e);if(Dt(t))return this.transformBackwardAsGeojson(t,e);if(Rt(t))return this.transformBackwardAsGeojson(t,e);if(jt(t))return this.transformBackwardAsGeojson(t,e);if(Ct(t))return this.transformBackwardAsGeojson(t,e);if(Bt(t))return this.transformBackwardAsGeojson(t,e);throw new Error("Input type not supported")}transformSvgToGeojson(t,e){if(t.type==="circle")return this.transformForwardAsGeojson(t.coordinates);if(t.type==="line")return this.transformForwardAsGeojson(t.coordinates,e);if(t.type==="polyline")return this.transformForwardAsGeojson(t.coordinates,e);if(t.type==="rect")return this.transformForwardAsGeojson([t.coordinates],e);if(t.type==="polygon")return this.transformForwardAsGeojson([t.coordinates],e);throw new Error("Unsupported SVG geometry")}transformGeojsonToSvg(t,e){if(t.type==="Point")return{type:"circle",coordinates:this.transformBackward(t)};if(t.type==="LineString")return{type:"polyline",coordinates:this.transformBackward(t,e)};if(t.type==="Polygon")return{type:"polygon",coordinates:this.transformBackward(t,e)[0]};throw new Error("Unsupported GeoJSON geometry")}}wn=new WeakSet,ls=function(){return ie(this,Cr,xn).call(this,this.sourcePoints,this.destinationPoints)},Tn=new WeakSet,us=function(){return ie(this,Cr,xn).call(this,this.destinationPoints,this.sourcePoints)},Cr=new WeakSet,xn=function(r,t){if(this.type==="helmert")return new vh(r,t);if(this.type==="polynomial1"||this.type==="polynomial")return new mn(r,t);if(this.type==="polynomial2")return new mn(r,t,2);if(this.type==="polynomial3")return new mn(r,t,3);if(this.type==="projective")return new wh(r,t);if(this.type==="thinPlateSpline")return new xh(r,t,Mh,bh);throw new Error(`Unsupported transformation type: ${this.type}`)};function Ih(r){return Math.sqrt(Math.pow(r[1][0]-r[0][0],2)+Math.pow(r[1][1]-r[0][1],2))}function Sh(r){return Math.atan2(r[1][1]-r[0][1],r[1][0]-r[0][0])}function Ah(r,t,e){return[r[0]+Math.cos(e)*t,r[1]+Math.sin(e)*t]}function Rh(r,t){let e=r[0];const n=[e];for(;Ih([e,r[1]])>t;){const i=Ah(e,t,Sh(r));n.push(i),e=i}return n}function Ch(r,t){r=[...r,r[0]];let e=[];for(let n=0;n<r.length-1;n++)e=e.concat(Rh([r[n],r[n+1]],t));return e}function Ph(r,t){const e=[],n=st(r);for(let i=n[0]+t,s=0;i<=n[2];s++,i+=t)for(let a=n[1]+t,o=0;a<=n[3];o++,a+=t)e.push([i,a]);return e}var Mn={},kh={get exports(){return Mn},set exports(r){Mn=r}},fs=Oh,ps=+(Math.pow(2,27)+1);function Oh(r,t,e){var n=r*t,i=ps*r,s=i-r,a=i-s,o=r-a,c=ps*t,h=c-t,l=c-h,u=t-l,g=n-a*l,v=g-o*l,y=v-a*u,E=o*u-y;return e?(e[0]=E,e[1]=n,e):[E,n]}var Nh=Dh;function Lh(r,t){var e=r+t,n=e-r,i=e-n,s=t-n,a=r-i,o=a+s;return o?[o,e]:[e]}function Dh(r,t){var e=r.length|0,n=t.length|0;if(e===1&&n===1)return Lh(r[0],t[0]);var i=e+n,s=new Array(i),a=0,o=0,c=0,h=Math.abs,l=r[o],u=h(l),g=t[c],v=h(g),y,E;u<v?(E=l,o+=1,o<e&&(l=r[o],u=h(l))):(E=g,c+=1,c<n&&(g=t[c],v=h(g))),o<e&&u<v||c>=n?(y=l,o+=1,o<e&&(l=r[o],u=h(l))):(y=g,c+=1,c<n&&(g=t[c],v=h(g)));for(var I=y+E,w=I-y,S=E-w,f=S,p=I,x,A,k,_,d;o<e&&c<n;)u<v?(y=l,o+=1,o<e&&(l=r[o],u=h(l))):(y=g,c+=1,c<n&&(g=t[c],v=h(g))),E=f,I=y+E,w=I-y,S=E-w,S&&(s[a++]=S),x=p+I,A=x-p,k=x-A,_=I-A,d=p-k,f=d+_,p=x;for(;o<e;)y=l,E=f,I=y+E,w=I-y,S=E-w,S&&(s[a++]=S),x=p+I,A=x-p,k=x-A,_=I-A,d=p-k,f=d+_,p=x,o+=1,o<e&&(l=r[o]);for(;c<n;)y=g,E=f,I=y+E,w=I-y,S=E-w,S&&(s[a++]=S),x=p+I,A=x-p,k=x-A,_=I-A,d=p-k,f=d+_,p=x,c+=1,c<n&&(g=t[c]);return f&&(s[a++]=f),p&&(s[a++]=p),a||(s[a++]=0),s.length=a,s}var jh=Bh;function Bh(r,t,e){var n=r+t,i=n-r,s=n-i,a=t-i,o=r-s;return e?(e[0]=o+a,e[1]=n,e):[o+a,n]}var bn=fs,Gh=jh,Fh=Wh;function Wh(r,t){var e=r.length;if(e===1){var n=bn(r[0],t);return n[0]?n:[n[1]]}var i=new Array(2*e),s=[.1,.1],a=[.1,.1],o=0;bn(r[0],t,s),s[0]&&(i[o++]=s[0]);for(var c=1;c<e;++c){bn(r[c],t,a);var h=s[1];Gh(h,a[0],s),s[0]&&(i[o++]=s[0]);var l=a[1],u=s[1],g=l+u,v=g-l,y=u-v;s[1]=g,y&&(i[o++]=y)}return s[1]&&(i[o++]=s[1]),o===0&&(i[o++]=0),i.length=o,i}var Uh=zh;function Vh(r,t){var e=r+t,n=e-r,i=e-n,s=t-n,a=r-i,o=a+s;return o?[o,e]:[e]}function zh(r,t){var e=r.length|0,n=t.length|0;if(e===1&&n===1)return Vh(r[0],-t[0]);var i=e+n,s=new Array(i),a=0,o=0,c=0,h=Math.abs,l=r[o],u=h(l),g=-t[c],v=h(g),y,E;u<v?(E=l,o+=1,o<e&&(l=r[o],u=h(l))):(E=g,c+=1,c<n&&(g=-t[c],v=h(g))),o<e&&u<v||c>=n?(y=l,o+=1,o<e&&(l=r[o],u=h(l))):(y=g,c+=1,c<n&&(g=-t[c],v=h(g)));for(var I=y+E,w=I-y,S=E-w,f=S,p=I,x,A,k,_,d;o<e&&c<n;)u<v?(y=l,o+=1,o<e&&(l=r[o],u=h(l))):(y=g,c+=1,c<n&&(g=-t[c],v=h(g))),E=f,I=y+E,w=I-y,S=E-w,S&&(s[a++]=S),x=p+I,A=x-p,k=x-A,_=I-A,d=p-k,f=d+_,p=x;for(;o<e;)y=l,E=f,I=y+E,w=I-y,S=E-w,S&&(s[a++]=S),x=p+I,A=x-p,k=x-A,_=I-A,d=p-k,f=d+_,p=x,o+=1,o<e&&(l=r[o]);for(;c<n;)y=g,E=f,I=y+E,w=I-y,S=E-w,S&&(s[a++]=S),x=p+I,A=x-p,k=x-A,_=I-A,d=p-k,f=d+_,p=x,c+=1,c<n&&(g=-t[c]);return f&&(s[a++]=f),p&&(s[a++]=p),a||(s[a++]=0),s.length=a,s}(function(r){var t=fs,e=Nh,n=Fh,i=Uh,s=5,a=11102230246251565e-32,o=(3+16*a)*a,c=(7+56*a)*a;function h(f,p,x,A){return function(_,d,T){var b=f(f(p(d[1],T[0]),p(-T[1],d[0])),f(p(_[1],d[0]),p(-d[1],_[0]))),M=f(p(_[1],T[0]),p(-T[1],_[0])),z=A(b,M);return z[z.length-1]}}function l(f,p,x,A){return function(_,d,T,b){var M=f(f(x(f(p(T[1],b[0]),p(-b[1],T[0])),d[2]),f(x(f(p(d[1],b[0]),p(-b[1],d[0])),-T[2]),x(f(p(d[1],T[0]),p(-T[1],d[0])),b[2]))),f(x(f(p(d[1],b[0]),p(-b[1],d[0])),_[2]),f(x(f(p(_[1],b[0]),p(-b[1],_[0])),-d[2]),x(f(p(_[1],d[0]),p(-d[1],_[0])),b[2])))),z=f(f(x(f(p(T[1],b[0]),p(-b[1],T[0])),_[2]),f(x(f(p(_[1],b[0]),p(-b[1],_[0])),-T[2]),x(f(p(_[1],T[0]),p(-T[1],_[0])),b[2]))),f(x(f(p(d[1],T[0]),p(-T[1],d[0])),_[2]),f(x(f(p(_[1],T[0]),p(-T[1],_[0])),-d[2]),x(f(p(_[1],d[0]),p(-d[1],_[0])),T[2])))),q=A(M,z);return q[q.length-1]}}function u(f,p,x,A){return function(_,d,T,b,M){var z=f(f(f(x(f(x(f(p(b[1],M[0]),p(-M[1],b[0])),T[2]),f(x(f(p(T[1],M[0]),p(-M[1],T[0])),-b[2]),x(f(p(T[1],b[0]),p(-b[1],T[0])),M[2]))),d[3]),f(x(f(x(f(p(b[1],M[0]),p(-M[1],b[0])),d[2]),f(x(f(p(d[1],M[0]),p(-M[1],d[0])),-b[2]),x(f(p(d[1],b[0]),p(-b[1],d[0])),M[2]))),-T[3]),x(f(x(f(p(T[1],M[0]),p(-M[1],T[0])),d[2]),f(x(f(p(d[1],M[0]),p(-M[1],d[0])),-T[2]),x(f(p(d[1],T[0]),p(-T[1],d[0])),M[2]))),b[3]))),f(x(f(x(f(p(T[1],b[0]),p(-b[1],T[0])),d[2]),f(x(f(p(d[1],b[0]),p(-b[1],d[0])),-T[2]),x(f(p(d[1],T[0]),p(-T[1],d[0])),b[2]))),-M[3]),f(x(f(x(f(p(b[1],M[0]),p(-M[1],b[0])),d[2]),f(x(f(p(d[1],M[0]),p(-M[1],d[0])),-b[2]),x(f(p(d[1],b[0]),p(-b[1],d[0])),M[2]))),_[3]),x(f(x(f(p(b[1],M[0]),p(-M[1],b[0])),_[2]),f(x(f(p(_[1],M[0]),p(-M[1],_[0])),-b[2]),x(f(p(_[1],b[0]),p(-b[1],_[0])),M[2]))),-d[3])))),f(f(x(f(x(f(p(d[1],M[0]),p(-M[1],d[0])),_[2]),f(x(f(p(_[1],M[0]),p(-M[1],_[0])),-d[2]),x(f(p(_[1],d[0]),p(-d[1],_[0])),M[2]))),b[3]),f(x(f(x(f(p(d[1],b[0]),p(-b[1],d[0])),_[2]),f(x(f(p(_[1],b[0]),p(-b[1],_[0])),-d[2]),x(f(p(_[1],d[0]),p(-d[1],_[0])),b[2]))),-M[3]),x(f(x(f(p(T[1],b[0]),p(-b[1],T[0])),d[2]),f(x(f(p(d[1],b[0]),p(-b[1],d[0])),-T[2]),x(f(p(d[1],T[0]),p(-T[1],d[0])),b[2]))),_[3]))),f(x(f(x(f(p(T[1],b[0]),p(-b[1],T[0])),_[2]),f(x(f(p(_[1],b[0]),p(-b[1],_[0])),-T[2]),x(f(p(_[1],T[0]),p(-T[1],_[0])),b[2]))),-d[3]),f(x(f(x(f(p(d[1],b[0]),p(-b[1],d[0])),_[2]),f(x(f(p(_[1],b[0]),p(-b[1],_[0])),-d[2]),x(f(p(_[1],d[0]),p(-d[1],_[0])),b[2]))),T[3]),x(f(x(f(p(d[1],T[0]),p(-T[1],d[0])),_[2]),f(x(f(p(_[1],T[0]),p(-T[1],_[0])),-d[2]),x(f(p(_[1],d[0]),p(-d[1],_[0])),T[2]))),-b[3]))))),q=f(f(f(x(f(x(f(p(b[1],M[0]),p(-M[1],b[0])),T[2]),f(x(f(p(T[1],M[0]),p(-M[1],T[0])),-b[2]),x(f(p(T[1],b[0]),p(-b[1],T[0])),M[2]))),_[3]),x(f(x(f(p(b[1],M[0]),p(-M[1],b[0])),_[2]),f(x(f(p(_[1],M[0]),p(-M[1],_[0])),-b[2]),x(f(p(_[1],b[0]),p(-b[1],_[0])),M[2]))),-T[3])),f(x(f(x(f(p(T[1],M[0]),p(-M[1],T[0])),_[2]),f(x(f(p(_[1],M[0]),p(-M[1],_[0])),-T[2]),x(f(p(_[1],T[0]),p(-T[1],_[0])),M[2]))),b[3]),x(f(x(f(p(T[1],b[0]),p(-b[1],T[0])),_[2]),f(x(f(p(_[1],b[0]),p(-b[1],_[0])),-T[2]),x(f(p(_[1],T[0]),p(-T[1],_[0])),b[2]))),-M[3]))),f(f(x(f(x(f(p(T[1],M[0]),p(-M[1],T[0])),d[2]),f(x(f(p(d[1],M[0]),p(-M[1],d[0])),-T[2]),x(f(p(d[1],T[0]),p(-T[1],d[0])),M[2]))),_[3]),x(f(x(f(p(T[1],M[0]),p(-M[1],T[0])),_[2]),f(x(f(p(_[1],M[0]),p(-M[1],_[0])),-T[2]),x(f(p(_[1],T[0]),p(-T[1],_[0])),M[2]))),-d[3])),f(x(f(x(f(p(d[1],M[0]),p(-M[1],d[0])),_[2]),f(x(f(p(_[1],M[0]),p(-M[1],_[0])),-d[2]),x(f(p(_[1],d[0]),p(-d[1],_[0])),M[2]))),T[3]),x(f(x(f(p(d[1],T[0]),p(-T[1],d[0])),_[2]),f(x(f(p(_[1],T[0]),p(-T[1],_[0])),-d[2]),x(f(p(_[1],d[0]),p(-d[1],_[0])),T[2]))),-M[3])))),X=A(z,q);return X[X.length-1]}}function g(f){var p=f===3?h:f===4?l:u;return p(e,t,n,i)}var v=g(3),y=g(4),E=[function(){return 0},function(){return 0},function(p,x){return x[0]-p[0]},function(p,x,A){var k=(p[1]-A[1])*(x[0]-A[0]),_=(p[0]-A[0])*(x[1]-A[1]),d=k-_,T;if(k>0){if(_<=0)return d;T=k+_}else if(k<0){if(_>=0)return d;T=-(k+_)}else return d;var b=o*T;return d>=b||d<=-b?d:v(p,x,A)},function(p,x,A,k){var _=p[0]-k[0],d=x[0]-k[0],T=A[0]-k[0],b=p[1]-k[1],M=x[1]-k[1],z=A[1]-k[1],q=p[2]-k[2],X=x[2]-k[2],V=A[2]-k[2],rt=d*z,ot=T*M,dt=T*b,K=_*z,xt=_*M,W=d*b,et=q*(rt-ot)+X*(dt-K)+V*(xt-W),ft=(Math.abs(rt)+Math.abs(ot))*Math.abs(q)+(Math.abs(dt)+Math.abs(K))*Math.abs(X)+(Math.abs(xt)+Math.abs(W))*Math.abs(V),ht=c*ft;return et>ht||-et>ht?et:y(p,x,A,k)}];function I(f){var p=E[f.length];return p||(p=E[f.length]=g(f.length)),p.apply(void 0,f)}function w(f,p,x,A,k,_,d){return function(b,M,z,q,X){switch(arguments.length){case 0:case 1:return 0;case 2:return A(b,M);case 3:return k(b,M,z);case 4:return _(b,M,z,q);case 5:return d(b,M,z,q,X)}for(var V=new Array(arguments.length),rt=0;rt<arguments.length;++rt)V[rt]=arguments[rt];return f(V)}}function S(){for(;E.length<=s;)E.push(g(E.length));r.exports=w.apply(void 0,[I].concat(E));for(var f=0;f<=s;++f)r.exports[f]=E[f]}S()})(kh);var Zh=$h,Pr=Mn;function $h(r,t){for(var e=t[0],n=t[1],i=r.length,s=1,a=i,o=0,c=i-1;o<a;c=o++){var h=r[o],l=r[c],u=h[1],g=l[1];if(g<u){if(g<n&&n<u){var v=Pr(h,l,t);if(v===0)return 0;s^=0<v|0}else if(n===u){var y=r[(o+1)%i],E=y[1];if(u<E){var v=Pr(h,l,t);if(v===0)return 0;s^=0<v|0}}}else if(u<g){if(u<n&&n<g){var v=Pr(h,l,t);if(v===0)return 0;s^=v<0|0}else if(n===u){var y=r[(o+1)%i],E=y[1];if(E<u){var v=Pr(h,l,t);if(v===0)return 0;s^=v<0|0}}}else if(n===u){var I=Math.min(h[0],l[0]),w=Math.max(h[0],l[0]);if(o===0){for(;c>0;){var S=(c+i-1)%i,f=r[S];if(f[1]!==n)break;var p=f[0];I=Math.min(I,p),w=Math.max(w,p),c=S}if(c===0)return I<=e&&e<=w?0:1;a=c+1}for(var x=r[(c+i-1)%i][1];o+1<a;){var f=r[o+1];if(f[1]!==n)break;var p=f[0];I=Math.min(I,p),w=Math.max(w,p),o+=1}if(I<=e&&e<=w)return 0;var A=r[(o+1)%i][1];e<I&&x<n!=A<n&&(s^=1)}}return 2*s-1}var kr={};const Xh={version:"1.5.0"};function gs(r){return"("+r.x+";"+r.y+")"}function qh(r){var t=r.toString();return t==="[object Object]"?gs(r):t}function Hh(r,t){return r.y===t.y?r.x-t.x:r.y-t.y}function Yh(r,t){return r.x===t.x&&r.y===t.y}var _n={toString:qh,toStringBase:gs,compare:Hh,equals:Yh},Jh=_n,Or=function(r,t){this.name="PointError",this.points=t=t||[],this.message=r||"Invalid Points!";for(var e=0;e<t.length;e++)this.message+=" "+Jh.toString(t[e])};Or.prototype=new Error,Or.prototype.constructor=Or;var En=Or,Le=_n,J=function(r,t){this.x=+r||0,this.y=+t||0,this._p2t_edge_list=null};J.prototype.toString=function(){return Le.toStringBase(this)},J.prototype.toJSON=function(){return{x:this.x,y:this.y}},J.prototype.clone=function(){return new J(this.x,this.y)},J.prototype.set_zero=function(){return this.x=0,this.y=0,this},J.prototype.set=function(r,t){return this.x=+r||0,this.y=+t||0,this},J.prototype.negate=function(){return this.x=-this.x,this.y=-this.y,this},J.prototype.add=function(r){return this.x+=r.x,this.y+=r.y,this},J.prototype.sub=function(r){return this.x-=r.x,this.y-=r.y,this},J.prototype.mul=function(r){return this.x*=r,this.y*=r,this},J.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},J.prototype.normalize=function(){var r=this.length();return this.x/=r,this.y/=r,r},J.prototype.equals=function(r){return this.x===r.x&&this.y===r.y},J.negate=function(r){return new J(-r.x,-r.y)},J.add=function(r,t){return new J(r.x+t.x,r.y+t.y)},J.sub=function(r,t){return new J(r.x-t.x,r.y-t.y)},J.mul=function(r,t){return new J(r*t.x,r*t.y)},J.cross=function(r,t){return typeof r=="number"?typeof t=="number"?r*t:new J(-r*t.y,r*t.x):typeof t=="number"?new J(t*r.y,-t*r.x):r.x*t.y-r.y*t.x},J.toString=Le.toString,J.compare=Le.compare,J.cmp=Le.compare,J.equals=Le.equals,J.dot=function(r,t){return r.x*t.x+r.y*t.y};var ms=J,Kh=_n,$=function(r,t,e){this.points_=[r,t,e],this.neighbors_=[null,null,null],this.interior_=!1,this.constrained_edge=[!1,!1,!1],this.delaunay_edge=[!1,!1,!1]},In=Kh.toString;$.prototype.toString=function(){return"["+In(this.points_[0])+In(this.points_[1])+In(this.points_[2])+"]"},$.prototype.getPoint=function(r){return this.points_[r]},$.prototype.GetPoint=$.prototype.getPoint,$.prototype.getPoints=function(){return this.points_},$.prototype.getNeighbor=function(r){return this.neighbors_[r]},$.prototype.containsPoint=function(r){var t=this.points_;return r===t[0]||r===t[1]||r===t[2]},$.prototype.containsEdge=function(r){return this.containsPoint(r.p)&&this.containsPoint(r.q)},$.prototype.containsPoints=function(r,t){return this.containsPoint(r)&&this.containsPoint(t)},$.prototype.isInterior=function(){return this.interior_},$.prototype.setInterior=function(r){return this.interior_=r,this},$.prototype.markNeighborPointers=function(r,t,e){var n=this.points_;if(r===n[2]&&t===n[1]||r===n[1]&&t===n[2])this.neighbors_[0]=e;else if(r===n[0]&&t===n[2]||r===n[2]&&t===n[0])this.neighbors_[1]=e;else if(r===n[0]&&t===n[1]||r===n[1]&&t===n[0])this.neighbors_[2]=e;else throw new Error("poly2tri Invalid Triangle.markNeighborPointers() call")},$.prototype.markNeighbor=function(r){var t=this.points_;r.containsPoints(t[1],t[2])?(this.neighbors_[0]=r,r.markNeighborPointers(t[1],t[2],this)):r.containsPoints(t[0],t[2])?(this.neighbors_[1]=r,r.markNeighborPointers(t[0],t[2],this)):r.containsPoints(t[0],t[1])&&(this.neighbors_[2]=r,r.markNeighborPointers(t[0],t[1],this))},$.prototype.clearNeighbors=function(){this.neighbors_[0]=null,this.neighbors_[1]=null,this.neighbors_[2]=null},$.prototype.clearDelaunayEdges=function(){this.delaunay_edge[0]=!1,this.delaunay_edge[1]=!1,this.delaunay_edge[2]=!1},$.prototype.pointCW=function(r){var t=this.points_;return r===t[0]?t[2]:r===t[1]?t[0]:r===t[2]?t[1]:null},$.prototype.pointCCW=function(r){var t=this.points_;return r===t[0]?t[1]:r===t[1]?t[2]:r===t[2]?t[0]:null},$.prototype.neighborCW=function(r){return r===this.points_[0]?this.neighbors_[1]:r===this.points_[1]?this.neighbors_[2]:this.neighbors_[0]},$.prototype.neighborCCW=function(r){return r===this.points_[0]?this.neighbors_[2]:r===this.points_[1]?this.neighbors_[0]:this.neighbors_[1]},$.prototype.getConstrainedEdgeCW=function(r){return r===this.points_[0]?this.constrained_edge[1]:r===this.points_[1]?this.constrained_edge[2]:this.constrained_edge[0]},$.prototype.getConstrainedEdgeCCW=function(r){return r===this.points_[0]?this.constrained_edge[2]:r===this.points_[1]?this.constrained_edge[0]:this.constrained_edge[1]},$.prototype.getConstrainedEdgeAcross=function(r){return r===this.points_[0]?this.constrained_edge[0]:r===this.points_[1]?this.constrained_edge[1]:this.constrained_edge[2]},$.prototype.setConstrainedEdgeCW=function(r,t){r===this.points_[0]?this.constrained_edge[1]=t:r===this.points_[1]?this.constrained_edge[2]=t:this.constrained_edge[0]=t},$.prototype.setConstrainedEdgeCCW=function(r,t){r===this.points_[0]?this.constrained_edge[2]=t:r===this.points_[1]?this.constrained_edge[0]=t:this.constrained_edge[1]=t},$.prototype.getDelaunayEdgeCW=function(r){return r===this.points_[0]?this.delaunay_edge[1]:r===this.points_[1]?this.delaunay_edge[2]:this.delaunay_edge[0]},$.prototype.getDelaunayEdgeCCW=function(r){return r===this.points_[0]?this.delaunay_edge[2]:r===this.points_[1]?this.delaunay_edge[0]:this.delaunay_edge[1]},$.prototype.setDelaunayEdgeCW=function(r,t){r===this.points_[0]?this.delaunay_edge[1]=t:r===this.points_[1]?this.delaunay_edge[2]=t:this.delaunay_edge[0]=t},$.prototype.setDelaunayEdgeCCW=function(r,t){r===this.points_[0]?this.delaunay_edge[2]=t:r===this.points_[1]?this.delaunay_edge[0]=t:this.delaunay_edge[1]=t},$.prototype.neighborAcross=function(r){return r===this.points_[0]?this.neighbors_[0]:r===this.points_[1]?this.neighbors_[1]:this.neighbors_[2]},$.prototype.oppositePoint=function(r,t){var e=r.pointCW(t);return this.pointCW(e)},$.prototype.legalize=function(r,t){var e=this.points_;if(r===e[0])e[1]=e[0],e[0]=e[2],e[2]=t;else if(r===e[1])e[2]=e[1],e[1]=e[0],e[0]=t;else if(r===e[2])e[0]=e[2],e[2]=e[1],e[1]=t;else throw new Error("poly2tri Invalid Triangle.legalize() call")},$.prototype.index=function(r){var t=this.points_;if(r===t[0])return 0;if(r===t[1])return 1;if(r===t[2])return 2;throw new Error("poly2tri Invalid Triangle.index() call")},$.prototype.edgeIndex=function(r,t){var e=this.points_;if(r===e[0]){if(t===e[1])return 2;if(t===e[2])return 1}else if(r===e[1]){if(t===e[2])return 0;if(t===e[0])return 2}else if(r===e[2]){if(t===e[0])return 1;if(t===e[1])return 0}return-1},$.prototype.markConstrainedEdgeByIndex=function(r){this.constrained_edge[r]=!0},$.prototype.markConstrainedEdgeByEdge=function(r){this.markConstrainedEdgeByPoints(r.p,r.q)},$.prototype.markConstrainedEdgeByPoints=function(r,t){var e=this.points_;t===e[0]&&r===e[1]||t===e[1]&&r===e[0]?this.constrained_edge[2]=!0:t===e[0]&&r===e[2]||t===e[2]&&r===e[0]?this.constrained_edge[1]=!0:(t===e[1]&&r===e[2]||t===e[2]&&r===e[1])&&(this.constrained_edge[0]=!0)};var Sn=$,An={};function Qh(r,t){if(!r)throw new Error(t||"Assert Failed")}var tl=Qh,De={},el={get exports(){return De},set exports(r){De=r}},rl=function(r,t){this.point=r,this.triangle=t||null,this.next=null,this.prev=null,this.value=r.x},kt=function(r,t){this.head_=r,this.tail_=t,this.search_node_=r};kt.prototype.head=function(){return this.head_},kt.prototype.setHead=function(r){this.head_=r},kt.prototype.tail=function(){return this.tail_},kt.prototype.setTail=function(r){this.tail_=r},kt.prototype.search=function(){return this.search_node_},kt.prototype.setSearch=function(r){this.search_node_=r},kt.prototype.findSearchNode=function(){return this.search_node_},kt.prototype.locateNode=function(r){var t=this.search_node_;if(r<t.value){for(;t=t.prev;)if(r>=t.value)return this.search_node_=t,t}else for(;t=t.next;)if(r<t.value)return this.search_node_=t.prev,t.prev;return null},kt.prototype.locatePoint=function(r){var t=r.x,e=this.findSearchNode(t),n=e.point.x;if(t===n){if(r!==e.point)if(r===e.prev.point)e=e.prev;else if(r===e.next.point)e=e.next;else throw new Error("poly2tri Invalid AdvancingFront.locatePoint() call")}else if(t<n)for(;(e=e.prev)&&r!==e.point;);else for(;(e=e.next)&&r!==e.point;);return e&&(this.search_node_=e),e},el.exports=kt,De.Node=rl;var he={},je=1e-12;he.EPSILON=je;var Nr={CW:1,CCW:-1,COLLINEAR:0};he.Orientation=Nr;function nl(r,t,e){var n=(r.x-e.x)*(t.y-e.y),i=(r.y-e.y)*(t.x-e.x),s=n-i;return s>-je&&s<je?Nr.COLLINEAR:s>0?Nr.CCW:Nr.CW}he.orient2d=nl;function il(r,t,e,n){var i=(r.x-t.x)*(n.y-t.y)-(n.x-t.x)*(r.y-t.y);if(i>=-je)return!1;var s=(r.x-e.x)*(n.y-e.y)-(n.x-e.x)*(r.y-e.y);return!(s<=je)}he.inScanArea=il;function sl(r,t,e){var n=t.x-r.x,i=t.y-r.y,s=e.x-r.x,a=e.y-r.y;return n*s+i*a<0}he.isAngleObtuse=sl;var Rn=tl,Lr=En,ys=Sn,ol=De.Node,Be=he,al=Be.EPSILON,tt=Be.Orientation,nt=Be.orient2d,vs=Be.inScanArea,ws=Be.isAngleObtuse;function cl(r){r.initTriangulation(),r.createAdvancingFront(),hl(r),ll(r)}function hl(r){var t,e=r.pointCount();for(t=1;t<e;++t)for(var n=r.getPoint(t),i=ul(r,n),s=n._p2t_edge_list,a=0;s&&a<s.length;++a)dl(r,s[a],i)}function ll(r){for(var t=r.front().head().next.triangle,e=r.front().head().next.point;!t.getConstrainedEdgeCW(e);)t=t.neighborCCW(e);r.meshClean(t)}function ul(r,t){var e=r.locateNode(t),n=fl(r,t,e);return t.x<=e.point.x+al&&le(r,e),pl(r,n),n}function dl(r,t,e){r.edge_event.constrained_edge=t,r.edge_event.right=t.p.x>t.q.x,!Ts(e.triangle,t.p,t.q)&&(wl(r,t,e),Cn(r,t.p,t.q,e.triangle,t.q))}function Cn(r,t,e,n,i){if(!Ts(n,t,e)){var s=n.pointCCW(i),a=nt(e,s,t);if(a===tt.COLLINEAR)throw new Lr("poly2tri EdgeEvent: Collinear not supported!",[e,s,t]);var o=n.pointCW(i),c=nt(e,o,t);if(c===tt.COLLINEAR)throw new Lr("poly2tri EdgeEvent: Collinear not supported!",[e,o,t]);a===c?(a===tt.CW?n=n.neighborCCW(i):n=n.neighborCW(i),Cn(r,t,e,n,i)):On(r,t,e,n,i)}}function Ts(r,t,e){var n=r.edgeIndex(t,e);if(n!==-1){r.markConstrainedEdgeByIndex(n);var i=r.getNeighbor(n);return i&&i.markConstrainedEdgeByPoints(t,e),!0}return!1}function fl(r,t,e){var n=new ys(t,e.point,e.next.point);n.markNeighbor(e.triangle),r.addToMap(n);var i=new ol(t);return i.next=e.next,i.prev=e,e.next.prev=i,e.next=i,Zt(r,n)||r.mapTriangleToNodes(n),i}function le(r,t){var e=new ys(t.prev.point,t.point,t.next.point);e.markNeighbor(t.prev.triangle),e.markNeighbor(t.triangle),r.addToMap(e),t.prev.next=t.next,t.next.prev=t.prev,Zt(r,e)||r.mapTriangleToNodes(e)}function pl(r,t){for(var e=t.next;e.next&&!ws(e.point,e.next.point,e.prev.point);)le(r,e),e=e.next;for(e=t.prev;e.prev&&!ws(e.point,e.next.point,e.prev.point);)le(r,e),e=e.prev;t.next&&t.next.next&&gl(t)&&yl(r,t)}function gl(r){var t=r.point.x-r.next.next.point.x,e=r.point.y-r.next.next.point.y;return Rn(e>=0,"unordered y"),t>=0||Math.abs(t)<e}function Zt(r,t){for(var e=0;e<3;++e)if(!t.delaunay_edge[e]){var n=t.getNeighbor(e);if(n){var i=t.getPoint(e),s=n.oppositePoint(t,i),a=n.index(s);if(n.constrained_edge[a]||n.delaunay_edge[a]){t.constrained_edge[e]=n.constrained_edge[a];continue}var o=ml(i,t.pointCCW(i),t.pointCW(i),s);if(o){t.delaunay_edge[e]=!0,n.delaunay_edge[a]=!0,xs(t,i,n,s);var c=!Zt(r,t);return c&&r.mapTriangleToNodes(t),c=!Zt(r,n),c&&r.mapTriangleToNodes(n),t.delaunay_edge[e]=!1,n.delaunay_edge[a]=!1,!0}}}return!1}function ml(r,t,e,n){var i=r.x-n.x,s=r.y-n.y,a=t.x-n.x,o=t.y-n.y,c=i*o,h=a*s,l=c-h;if(l<=0)return!1;var u=e.x-n.x,g=e.y-n.y,v=u*s,y=i*g,E=v-y;if(E<=0)return!1;var I=a*g,w=u*o,S=i*i+s*s,f=a*a+o*o,p=u*u+g*g,x=S*(I-w)+f*E+p*l;return x>0}function xs(r,t,e,n){var i,s,a,o;i=r.neighborCCW(t),s=r.neighborCW(t),a=e.neighborCCW(n),o=e.neighborCW(n);var c,h,l,u;c=r.getConstrainedEdgeCCW(t),h=r.getConstrainedEdgeCW(t),l=e.getConstrainedEdgeCCW(n),u=e.getConstrainedEdgeCW(n);var g,v,y,E;g=r.getDelaunayEdgeCCW(t),v=r.getDelaunayEdgeCW(t),y=e.getDelaunayEdgeCCW(n),E=e.getDelaunayEdgeCW(n),r.legalize(t,n),e.legalize(n,t),e.setDelaunayEdgeCCW(t,g),r.setDelaunayEdgeCW(t,v),r.setDelaunayEdgeCCW(n,y),e.setDelaunayEdgeCW(n,E),e.setConstrainedEdgeCCW(t,c),r.setConstrainedEdgeCW(t,h),r.setConstrainedEdgeCCW(n,l),e.setConstrainedEdgeCW(n,u),r.clearNeighbors(),e.clearNeighbors(),i&&e.markNeighbor(i),s&&r.markNeighbor(s),a&&r.markNeighbor(a),o&&e.markNeighbor(o),r.markNeighbor(e)}function yl(r,t){for(nt(t.point,t.next.point,t.next.next.point)===tt.CCW?r.basin.left_node=t.next.next:r.basin.left_node=t.next,r.basin.bottom_node=r.basin.left_node;r.basin.bottom_node.next&&r.basin.bottom_node.point.y>=r.basin.bottom_node.next.point.y;)r.basin.bottom_node=r.basin.bottom_node.next;if(r.basin.bottom_node!==r.basin.left_node){for(r.basin.right_node=r.basin.bottom_node;r.basin.right_node.next&&r.basin.right_node.point.y<r.basin.right_node.next.point.y;)r.basin.right_node=r.basin.right_node.next;r.basin.right_node!==r.basin.bottom_node&&(r.basin.width=r.basin.right_node.point.x-r.basin.left_node.point.x,r.basin.left_highest=r.basin.left_node.point.y>r.basin.right_node.point.y,Ms(r,r.basin.bottom_node))}}function Ms(r,t){if(!vl(r,t)){le(r,t);var e;if(!(t.prev===r.basin.left_node&&t.next===r.basin.right_node)){if(t.prev===r.basin.left_node){if(e=nt(t.point,t.next.point,t.next.next.point),e===tt.CW)return;t=t.next}else if(t.next===r.basin.right_node){if(e=nt(t.point,t.prev.point,t.prev.prev.point),e===tt.CCW)return;t=t.prev}else t.prev.point.y<t.next.point.y?t=t.prev:t=t.next;Ms(r,t)}}}function vl(r,t){var e;return r.basin.left_highest?e=r.basin.left_node.point.y-t.point.y:e=r.basin.right_node.point.y-t.point.y,r.basin.width>e}function wl(r,t,e){r.edge_event.right?Tl(r,t,e):xl(r,t,e)}function Tl(r,t,e){for(;e.next.point.x<t.p.x;)nt(t.q,e.next.point,t.p)===tt.CCW?bs(r,t,e):e=e.next}function bs(r,t,e){e.point.x<t.p.x&&(nt(e.point,e.next.point,e.next.next.point)===tt.CCW?Pn(r,t,e):(_s(r,t,e),bs(r,t,e)))}function Pn(r,t,e){le(r,e.next),e.next.point!==t.p&&nt(t.q,e.next.point,t.p)===tt.CCW&&nt(e.point,e.next.point,e.next.next.point)===tt.CCW&&Pn(r,t,e)}function _s(r,t,e){nt(e.next.point,e.next.next.point,e.next.next.next.point)===tt.CCW?Pn(r,t,e.next):nt(t.q,e.next.next.point,t.p)===tt.CCW&&_s(r,t,e.next)}function xl(r,t,e){for(;e.prev.point.x>t.p.x;)nt(t.q,e.prev.point,t.p)===tt.CW?Es(r,t,e):e=e.prev}function Es(r,t,e){e.point.x>t.p.x&&(nt(e.point,e.prev.point,e.prev.prev.point)===tt.CW?kn(r,t,e):(Is(r,t,e),Es(r,t,e)))}function Is(r,t,e){nt(e.prev.point,e.prev.prev.point,e.prev.prev.prev.point)===tt.CW?kn(r,t,e.prev):nt(t.q,e.prev.prev.point,t.p)===tt.CW&&Is(r,t,e.prev)}function kn(r,t,e){le(r,e.prev),e.prev.point!==t.p&&nt(t.q,e.prev.point,t.p)===tt.CW&&nt(e.point,e.prev.point,e.prev.prev.point)===tt.CW&&kn(r,t,e)}function On(r,t,e,n,i){var s=n.neighborAcross(i);Rn(s,"FLIP failed due to missing triangle!");var a=s.oppositePoint(n,i);if(n.getConstrainedEdgeAcross(i)){var o=n.index(i);throw new Lr("poly2tri Intersecting Constraints",[i,a,n.getPoint((o+1)%3),n.getPoint((o+2)%3)])}if(vs(i,n.pointCCW(i),n.pointCW(i),a))if(xs(n,i,s,a),r.mapTriangleToNodes(n),r.mapTriangleToNodes(s),i===e&&a===t)e===r.edge_event.constrained_edge.q&&t===r.edge_event.constrained_edge.p&&(n.markConstrainedEdgeByPoints(t,e),s.markConstrainedEdgeByPoints(t,e),Zt(r,n),Zt(r,s));else{var c=nt(e,a,t);n=Ml(r,c,n,s,i,a),On(r,t,e,n,i)}else{var h=Ss(t,e,s,a);As(r,t,e,n,s,h),Cn(r,t,e,n,i)}}function Ml(r,t,e,n,i,s){var a;return t===tt.CCW?(a=n.edgeIndex(i,s),n.delaunay_edge[a]=!0,Zt(r,n),n.clearDelaunayEdges(),e):(a=e.edgeIndex(i,s),e.delaunay_edge[a]=!0,Zt(r,e),e.clearDelaunayEdges(),n)}function Ss(r,t,e,n){var i=nt(t,n,r);if(i===tt.CW)return e.pointCCW(n);if(i===tt.CCW)return e.pointCW(n);throw new Lr("poly2tri [Unsupported] nextFlipPoint: opposing point on constrained edge!",[t,n,r])}function As(r,t,e,n,i,s){var a=i.neighborAcross(s);Rn(a,"FLIP failed due to missing triangle");var o=a.oppositePoint(i,s);if(vs(e,n.pointCCW(e),n.pointCW(e),o))On(r,e,o,a,o);else{var c=Ss(t,e,a,o);As(r,t,e,n,a,c)}}An.triangulate=cl;var bl=En,Ge=ms,_l=Sn,El=An,Rs=De,Nn=Rs.Node,Cs=.3,Il=function(r,t){if(this.p=r,this.q=t,r.y>t.y)this.q=r,this.p=t;else if(r.y===t.y){if(r.x>t.x)this.q=r,this.p=t;else if(r.x===t.x)throw new bl("poly2tri Invalid Edge constructor: repeated points!",[r])}this.q._p2t_edge_list||(this.q._p2t_edge_list=[]),this.q._p2t_edge_list.push(this)},Ps=function(){this.left_node=null,this.bottom_node=null,this.right_node=null,this.width=0,this.left_highest=!1};Ps.prototype.clear=function(){this.left_node=null,this.bottom_node=null,this.right_node=null,this.width=0,this.left_highest=!1};var Sl=function(){this.constrained_edge=null,this.right=!1},Y=function(r,t){t=t||{},this.triangles_=[],this.map_=[],this.points_=t.cloneArrays?r.slice(0):r,this.edge_list=[],this.pmin_=this.pmax_=null,this.front_=null,this.head_=null,this.tail_=null,this.af_head_=null,this.af_middle_=null,this.af_tail_=null,this.basin=new Ps,this.edge_event=new Sl,this.initEdges(this.points_)};Y.prototype.addHole=function(r){this.initEdges(r);var t,e=r.length;for(t=0;t<e;t++)this.points_.push(r[t]);return this},Y.prototype.AddHole=Y.prototype.addHole,Y.prototype.addHoles=function(r){var t,e=r.length;for(t=0;t<e;t++)this.initEdges(r[t]);return this.points_=this.points_.concat.apply(this.points_,r),this},Y.prototype.addPoint=function(r){return this.points_.push(r),this},Y.prototype.AddPoint=Y.prototype.addPoint,Y.prototype.addPoints=function(r){return this.points_=this.points_.concat(r),this},Y.prototype.triangulate=function(){return El.triangulate(this),this},Y.prototype.getBoundingBox=function(){return{min:this.pmin_,max:this.pmax_}},Y.prototype.getTriangles=function(){return this.triangles_},Y.prototype.GetTriangles=Y.prototype.getTriangles,Y.prototype.front=function(){return this.front_},Y.prototype.pointCount=function(){return this.points_.length},Y.prototype.head=function(){return this.head_},Y.prototype.setHead=function(r){this.head_=r},Y.prototype.tail=function(){return this.tail_},Y.prototype.setTail=function(r){this.tail_=r},Y.prototype.getMap=function(){return this.map_},Y.prototype.initTriangulation=function(){var r=this.points_[0].x,t=this.points_[0].x,e=this.points_[0].y,n=this.points_[0].y,i,s=this.points_.length;for(i=1;i<s;i++){var a=this.points_[i];a.x>r&&(r=a.x),a.x<t&&(t=a.x),a.y>e&&(e=a.y),a.y<n&&(n=a.y)}this.pmin_=new Ge(t,n),this.pmax_=new Ge(r,e);var o=Cs*(r-t),c=Cs*(e-n);this.head_=new Ge(r+o,n-c),this.tail_=new Ge(t-o,n-c),this.points_.sort(Ge.compare)},Y.prototype.initEdges=function(r){var t,e=r.length;for(t=0;t<e;++t)this.edge_list.push(new Il(r[t],r[(t+1)%e]))},Y.prototype.getPoint=function(r){return this.points_[r]},Y.prototype.addToMap=function(r){this.map_.push(r)},Y.prototype.locateNode=function(r){return this.front_.locateNode(r.x)},Y.prototype.createAdvancingFront=function(){var r,t,e,n=new _l(this.points_[0],this.tail_,this.head_);this.map_.push(n),r=new Nn(n.getPoint(1),n),t=new Nn(n.getPoint(0),n),e=new Nn(n.getPoint(2)),this.front_=new Rs(r,e),r.next=t,t.next=e,t.prev=r,e.prev=t},Y.prototype.removeNode=function(r){},Y.prototype.mapTriangleToNodes=function(r){for(var t=0;t<3;++t)if(!r.getNeighbor(t)){var e=this.front_.locatePoint(r.pointCW(r.getPoint(t)));e&&(e.triangle=r)}},Y.prototype.removeFromMap=function(r){var t,e=this.map_,n=e.length;for(t=0;t<n;t++)if(e[t]===r){e.splice(t,1);break}},Y.prototype.meshClean=function(r){for(var t=[r],e,n;e=t.pop();)if(!e.isInterior())for(e.setInterior(!0),this.triangles_.push(e),n=0;n<3;n++)e.constrained_edge[n]||t.push(e.getNeighbor(n))};var Al=Y;(function(r){var t=globalThis.poly2tri;r.noConflict=function(){return globalThis.poly2tri=t,r},r.VERSION=Xh.version,r.PointError=En,r.Point=ms,r.Triangle=Sn,r.SweepContext=Al;var e=An;r.triangulate=e.triangulate,r.sweep={Triangulate:e.triangulate}})(kr);function Rl(r,t){const e=Ph(r,t),n=new kr.SweepContext(Ch(r,t).map(i=>new kr.Point(i[0],i[1])));for(let i=0;i<e.length;i++)Zh(r,e[i])===-1&&n.addPoint(new kr.Point(e[i][0],e[i][1]));try{n.triangulate()}catch{throw new Error("A Point Error occured during resource mask triangulation. This is typically because the resource mask contains duplicate or collinear points, or is self-intersecting.")}return n.getTriangles()}function Cl(r,t){return Rl(r,t).map(e=>e.getPoints().map(n=>[n.x,n.y]))}function ue(r,t){const e=t[0],n=t[1];return[r[0]*e+r[2]*n+r[4],r[1]*e+r[3]*n+r[5]]}function Pl(){return[1,0,0,1,0,0]}function kl(r,t){const e=r[0],n=r[1],i=r[2],s=r[3],a=r[4],o=r[5],c=t[0],h=t[1],l=t[2],u=t[3],g=t[4],v=t[5];return[e*c+i*h,n*c+s*h,e*l+i*u,n*l+s*u,e*g+i*v+a,n*g+s*v+o]}function ks(r,t,e,n,i,s,a){const o=Math.sin(i),c=Math.cos(i);return[e*c,n*o,-e*o,n*c,s*e*c-a*e*o+r,s*n*o+a*n*c+t]}function Ol(r){const t=Nl(r),e=r[0],n=r[1],i=r[2],s=r[3],a=r[4],o=r[5];return[s/t,-n/t,-i/t,e/t,(i*o-s*a)/t,-(e*o-n*a)/t]}function Nl(r){return r[0]*r[3]-r[1]*r[2]}function Ll(r){const t=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];return t[0]=r[0],t[1]=r[1],t[4]=r[2],t[5]=r[3],t[12]=r[4],t[13]=r[5],t}C.WarpedMapEventType=void 0,function(r){r.GEOREFERENCEANNOTATIONADDED="georeferenceannotationadded",r.GEOREFERENCEANNOTATIONREMOVED="georeferenceannotationremoved",r.WARPEDMAPADDED="warpedmapadded",r.WARPEDMAPREMOVED="warpedmapremoved",r.WARPEDMAPENTER="warpedmapenter",r.WARPEDMAPLEAVE="warpedmapleave",r.IMAGEINFOLOADED="imageinfoloaded",r.TILEFETCHED="tilefetched",r.TILEFETCHERROR="tilefetcherror",r.MAPTILELOADED="maptileloaded",r.MAPTILEREMOVED="maptileremoved",r.FIRSTMAPTILELOADED="firstmaptileloaded",r.ALLREQUESTEDTILESLOADED="allrequestedtilesloaded",r.TEXTURESUPDATED="texturesupdated",r.ZINDICESCHANGES="zindiceschanged",r.RESOURCEMASKUPDATED="resourcemaskupdated",r.VISIBILITYCHANGED="visibilitychanged",r.TRANSFORMATIONCHANGED="transformationchanged",r.CHANGED="changed",r.CLEARED="cleared"}(C.WarpedMapEventType||(C.WarpedMapEventType={}));class U extends Event{constructor(t,e){super(t),this.data=e}}const Dl=80,Os={maxOffsetRatio:.05,maxDepth:2},Ns={maxOffsetRatio:.05,maxDepth:2};class jl extends EventTarget{constructor(t,e,n,i=!0){super(),this.resourceViewportRing=[],this.resourceTrianglePoints=[],this.resourceTrianglePointsByBestScaleFactor=new Map,this.projectedGeoCurrentTrianglePoints=[],this.projectedGeoNewTrianglePoints=[],this.mapId=t,this.georeferencedMap=e,this.gcps=this.georeferencedMap.gcps,this.projectedGcps=this.gcps.map(({geo:s,resource:a})=>({geo:lc(s),resource:a})),this.resourceMask=this.georeferencedMap.resourceMask,this.resourceMaskBbox=st(this.resourceMask),this.resourceFullMask=[[0,0],[this.georeferencedMap.resource.width,0],[this.georeferencedMap.resource.width,this.georeferencedMap.resource.height],[0,this.georeferencedMap.resource.height]],this.resourceFullMaskBbox=st(this.resourceFullMask),this.imageInfoCache=n,this.visible=i,this.transformationType=this.georeferencedMap.transformation?.type||"polynomial",this.updateTransformerProperties()}getViewportMask(t){return this.projectedGeoMask.map(e=>ue(t.projectedGeoToViewportTransform,e))}getViewportMaskBbox(t){return st(this.getViewportMask(t))}getApproxViewportMaskBbox(t){return st(Pe(this.projectedGeoMaskBbox).map(e=>ue(t.projectedGeoToViewportTransform,e)))}getViewportFullMask(t){return this.projectedGeoFullMask.map(e=>ue(t.projectedGeoToViewportTransform,e))}getViewportFullMaskBbox(t){return st(this.getViewportFullMask(t))}getApproxViewportFullMaskBbox(t){return st(Pe(this.projectedGeoFullMaskBbox).map(e=>ue(t.projectedGeoToViewportTransform,e)))}getResourceToViewportScale(t){return cn(this.resourceMaskBbox,this.getViewportMaskBbox(t))}getResourceToCanvasScale(t){return this.getResourceToViewportScale(t)/t.devicePixelRatio}getApproxResourceToViewportScale(t){return cn(this.resourceMaskBbox,this.getApproxViewportMaskBbox(t))}getApproxResourceToCanvasScale(t){return this.getApproxResourceToViewportScale(t)/t.devicePixelRatio}setResourceViewportRing(t){this.resourceViewportRing=t,this.resourceViewportRingBbox=st(t)}setResourceMask(t){this.resourceMask=t,this.updateGeoMask(),this.updateProjectedGeoMask()}setTransformationType(t){this.transformationType=t,this.updateTransformerProperties()}setGcps(t){this.gcps=t,this.updateTransformerProperties()}updateBestScaleFactor(t){this.bestScaleFactor!=t&&(this.bestScaleFactor=t,this.updateTriangulation(!0))}updateTriangulation(t=!1){if(this.resourceTrianglePointsByBestScaleFactor.has(this.bestScaleFactor))this.resourceTrianglePoints=this.resourceTrianglePointsByBestScaleFactor.get(this.bestScaleFactor);else{const e=oc(this.resourceMask)*this.bestScaleFactor/Dl;this.resourceTrianglePoints=Cl(this.resourceMask,e).flat(),this.resourceTrianglePointsByBestScaleFactor.set(this.bestScaleFactor,this.resourceTrianglePoints)}this.updateProjectedGeoTrianglePoints(t)}updateProjectedGeoTrianglePoints(t=!1){this.projectedGeoNewTrianglePoints=this.resourceTrianglePoints.map(e=>this.projectedTransformer.transformToGeo(e)),(t||!this.projectedGeoCurrentTrianglePoints.length)&&(this.projectedGeoCurrentTrianglePoints=this.projectedGeoNewTrianglePoints)}resetCurrentTrianglePoints(){this.projectedGeoCurrentTrianglePoints=this.projectedGeoNewTrianglePoints}clearResourceTrianglePointsByBestScaleFactor(){this.resourceTrianglePointsByBestScaleFactor=new Map}mixProjectedGeoCurrentAndNewTrianglePoints(t){this.projectedGeoCurrentTrianglePoints=this.projectedGeoNewTrianglePoints.map((e,n)=>Qa(e,this.projectedGeoCurrentTrianglePoints[n],t))}hasImageInfo(){return this.imageId!==void 0&&this.parsedImage!==void 0}async loadImageInfo(){const t=this.georeferencedMap.resource.id,e=await Xa(t,{cache:this.imageInfoCache});this.parsedImage=Ba.parse(e),this.imageId=await Jn(t),this.dispatchEvent(new U(C.WarpedMapEventType.IMAGEINFOLOADED))}dispose(){this.resourceTrianglePoints=[],this.projectedGeoCurrentTrianglePoints=[],this.projectedGeoNewTrianglePoints=[]}updateTransformerProperties(){this.updateTransformer(),this.updateProjectedTransformer(),this.updateGeoMask(),this.updateFullGeoMask(),this.updateProjectedGeoMask(),this.updateProjectedFullGeoMask(),this.updateResourceToProjectedGeoScale()}updateTransformer(){this.transformer=new ds(this.gcps,this.transformationType)}updateProjectedTransformer(){this.projectedTransformer=new ds(this.projectedGcps,this.transformationType)}updateGeoMask(){this.geoMask=this.transformer.transformForwardAsGeojson([this.resourceMask],Os),this.geoMaskBbox=st(this.geoMask)}updateFullGeoMask(){this.geoFullMask=this.transformer.transformForwardAsGeojson([this.resourceFullMask],Os),this.geoFullMaskBbox=st(this.geoFullMask)}updateProjectedGeoMask(){this.projectedGeoMask=this.projectedTransformer.transformForward([this.resourceMask],Ns)[0],this.projectedGeoMaskBbox=st(this.projectedGeoMask)}updateProjectedFullGeoMask(){this.projectedGeoFullMask=this.projectedTransformer.transformForward([this.resourceFullMask],Ns)[0],this.projectedGeoFullMaskBbox=st(this.projectedGeoFullMask)}updateResourceToProjectedGeoScale(){this.resourceToProjectedGeoScale=cn(this.resourceMaskBbox,this.projectedGeoMaskBbox)}}const Bl=m.string().or(m.number()).or(m.boolean()),Gl=m.record(m.string(),Bl.array()),$t=m.tuple([m.number(),m.number()]),Ls=m.object({type:m.literal("Point"),coordinates:$t}),Ds=$t.array().min(3),Fe=m.enum(["ImageService1","ImageService2","ImageService3"]),Dr=m.object({id:m.string().url(),type:m.string(),label:Gl.optional()}).extend({partOf:m.lazy(()=>Dr.array()).optional()}),Fl=m.object({type:m.literal("polynomial"),options:m.object({order:m.number().min(1).max(3)}).optional()}),Wl=m.object({type:m.literal("thinPlateSpline")}),jr=Fl.or(Wl),Ul=/^<svg\s+width="\d+"\s+height="\d+"\s*>\s*<polygon\s+points="\s*(-?\d+(\.\d+)?,-?\d+(\.\d+)?\s+){2,}-?\d+(\.\d+)?,-?\d+(\.\d+)?\s*"\s*\/>\s*<\/svg>$/,Vl=m.object({type:m.literal("SvgSelector"),value:m.string().regex(Ul)}),zl=m.object({source:m.string().url(),service:m.array(m.object({"@id":m.string().url(),type:Fe})).length(1),selector:Vl}),js=m.object({pixelCoords:$t}),Zl=m.object({type:m.literal("FeatureCollection"),transformation:jr.optional(),features:m.array(m.object({type:m.literal("Feature"),properties:js,geometry:Ls}))}),Ln=m.object({id:m.string().optional(),type:m.literal("Annotation"),"@context":m.string().url().array().optional(),motivation:m.string().default("georeferencing").optional(),target:zl,body:Zl}),Bs=m.object({id:m.string().optional(),type:m.literal("AnnotationPage"),"@context":m.string().url().array().optional(),items:m.array(Ln)}),Dn=/<polygon\s+points="\s*(-?\d+(\.\d+)?,-?\d+(\.\d+)?\s+){2,}-?\d+(\.\d+)?,-?\d+(\.\d+)?\s*"\s*\/>/,$l=new RegExp(`^<svg\\s+width="\\d+"\\s+height="\\d+"\\s*>\\s*${Dn.source}\\s*</svg>$`),Xl=new RegExp(`^<svg\\s+height="\\d+"\\s+width="\\d+"\\s*>\\s*${Dn.source}\\s*</svg>$`),ql=new RegExp(`^<svg\\s*>\\s*${Dn.source}\\s*</svg>$`),Hl=m.string().regex(ql),Yl=m.string().regex($l),Jl=m.string().regex(Xl),Kl=m.object({type:m.literal("SvgSelector"),value:Hl.or(Yl).or(Jl)}),Ql=m.object({"@id":m.string().url(),type:Fe,height:m.number().positive(),width:m.number().positive(),partOf:Dr.array().optional()}),tu=m.object({id:m.string().url(),type:Fe,height:m.number().positive(),width:m.number().positive(),partOf:Dr.array().optional()}),eu=m.object({type:m.literal("SpecificResource"),source:Ql.or(tu),selector:Kl}),Gs=m.object({resourceCoords:$t}),ru=m.object({type:m.literal("FeatureCollection"),transformation:jr.optional(),features:m.array(m.object({type:m.literal("Feature"),properties:Gs,geometry:Ls}))}),jn=m.object({id:m.string().optional(),type:m.literal("Annotation"),"@context":m.string().url().array().optional(),motivation:m.string().default("georeferencing").optional(),target:eu,body:ru}),Fs=m.object({id:m.string().optional(),type:m.literal("AnnotationPage"),"@context":m.string().url().array().optional(),items:m.array(jn)});Ln.or(jn),Bs.or(Fs),js.or(Gs);function Ws(r){return Array.isArray(r)}function nu(r){return!!(r&&typeof r=="object"&&"type"in r&&r.type==="AnnotationPage")}function Br(r){return!!(r&&typeof r=="object"&&"type"in r&&r.type==="GeoreferencedMap")}function Us(r){return!!(r&&typeof r=="object"&&"target"in r&&r.target&&typeof r.target=="object"&&"source"in r.target&&typeof r.target.source=="string")}function Bn(r){return"type"in r&&r.type==="GeoreferencedMap"}function Gn(r){return"source"in r.target&&typeof r.target.source=="object"}function iu(r){return{id:su(r),...lu(r),type:ou(r),partOf:au(r)}}function su(r){if(Gn(r)){const t=r.target.source;return"id"in t?t.id:t["@id"]}else return r.target.service[0]["@id"]}function ou(r){return"service"in r.target?r.target.service[0].type:r.target.source.type}function au(r){if(Gn(r))return r.target.source.partOf}function cu(r){return"pixelCoords"in r?r.pixelCoords:r.resourceCoords}function hu(r){return r.body.features.map(t=>({resource:cu(t.properties),geo:t.geometry.coordinates}))}function lu(r){if(Gn(r))return{width:r.target.source.width,height:r.target.source.height};const e=r.target.selector.value,n=/width="(?<width>\d+)"/.exec(e),i=/height="(?<height>\d+)"/.exec(e),s=n?.groups?.width,a=i?.groups?.height;if(!s||!a)throw new Error("Could not parse image dimensions");return{width:parseInt(s),height:parseInt(a)}}function uu(r){const e=r.target.selector.value,i=/points="(?<points>.+)"/.exec(e)?.groups;if(i&&i.points){const s=i.points.trim().split(/\s+/);if(s[0]===s[s.length-1]&&s.splice(-1),s.length>=3)return s.map(a=>{const o=a.split(",");if(o.length===2)return[parseFloat(o[0]),parseFloat(o[1])];throw new Error("Could not parse resource mask")});throw new Error("Could not parse resource mask")}else throw new Error("Could not parse resource mask")}function Vs(r){return{"@context":"https://schemas.allmaps.org/map/2/context.json",type:"GeoreferencedMap",id:r.id,resource:iu(r),gcps:hu(r),resourceMask:uu(r),transformation:r.body.transformation}}function Fn(r){if(nu(r)){let t;return"items"in r&&Array.isArray(r.items)&&Us(r.items[0])?t=Bs.parse(r):t=Fs.parse(r),t.items.map(e=>Vs(e))}else{let t;return Us(r)?t=Ln.parse(r):t=jn.parse(r),[Vs(t)]}}const zs=m.object({image:$t,world:$t}),du=m.object({uri:m.string().url(),width:m.number(),height:m.number(),type:Fe}),Gr=m.object({id:m.string().optional(),version:m.number().min(1).max(1).default(1),image:du,gcps:zs.array(),pixelMask:Ds,transformation:jr.optional()}),Wn=m.array(Gr),Zs=m.object({resource:$t,geo:$t}),fu=m.object({id:m.string().url(),width:m.number(),height:m.number(),type:Fe,partOf:Dr.array().optional()}),Fr=m.object({"@context":m.literal("https://schemas.allmaps.org/map/2/context.json").optional(),type:m.literal("GeoreferencedMap"),id:m.string().optional(),resource:fu,gcps:Zs.array(),resourceMask:Ds,transformation:jr.optional()}),Un=m.array(Fr);Gr.or(Fr),Wn.or(Un),zs.or(Zs);function pu(r){let t,e,n;return Bn(r)?(t=r.resource.width,e=r.resource.height,n=r.resourceMask):(t=r.image.width,e=r.image.height,n=r.pixelMask),{type:"SvgSelector",value:`<svg width="${t}" height="${e}"><polygon points="${n.map(i=>i.join(",")).join(" ")}" /></svg>`}}function gu(r){let t,e,n,i,s;return Bn(r)?(t=r.resource.id,e=r.resource.type,n=r.resource.width,i=r.resource.height,s=r.resource.partOf):(t=r.image.uri,e=r.image.type,n=r.image.width,i=r.image.height),{id:t,type:e,height:i,width:n,partOf:s}}function $s(){return["http://iiif.io/api/extension/georef/1/context.json","http://iiif.io/api/presentation/3/context.json"]}function mu(r){let t,e;return"resource"in r?(t=r.resource,e=r.geo):(t=r.image,e=r.world),{type:"Feature",properties:{resourceCoords:t},geometry:{type:"Point",coordinates:e}}}function Xs(r,t=!0){const e={type:"SpecificResource",source:gu(r),selector:pu(r)},n={type:"FeatureCollection",transformation:r.transformation,features:r.gcps.map(i=>mu(i))};return{id:r.id,type:"Annotation","@context":t?$s():void 0,motivation:"georeferencing",target:e,body:n}}function yu(r){if(Ws(r)){let t;Br(r[0])?t=Un.parse(r):t=Wn.parse(r);const e=t.map(n=>Xs(n,!1));return{type:"AnnotationPage","@context":$s(),items:e}}else{let t;return Br(r)?t=Fr.parse(r):t=Gr.parse(r),Xs(t)}}function qs(r){return Bn(r)?r:Fn(yu(r))[0]}function vu(r){return r.map(qs)}function Hs(r){if(Ws(r)){let t;return Br(r[0])?t=Un.parse(r):t=Wn.parse(r),vu(t)}else{let t;return Br(r)?t=Fr.parse(r):t=Gr.parse(r),qs(t)}}function wu(r,t,e,n,i){Ys(r,t,e||0,n||r.length-1,i||Tu)}function Ys(r,t,e,n,i){for(;n>e;){if(n-e>600){var s=n-e+1,a=t-e+1,o=Math.log(s),c=.5*Math.exp(2*o/3),h=.5*Math.sqrt(o*c*(s-c)/s)*(a-s/2<0?-1:1),l=Math.max(e,Math.floor(t-a*c/s+h)),u=Math.min(n,Math.floor(t+(s-a)*c/s+h));Ys(r,t,l,u,i)}var g=r[t],v=e,y=n;for(We(r,e,t),i(r[n],g)>0&&We(r,e,n);v<y;){for(We(r,v,y),v++,y--;i(r[v],g)<0;)v++;for(;i(r[y],g)>0;)y--}i(r[e],g)===0?We(r,e,y):(y++,We(r,y,n)),y<=t&&(e=y+1),t<=y&&(n=y-1)}}function We(r,t,e){var n=r[t];r[t]=r[e],r[e]=n}function Tu(r,t){return r<t?-1:r>t?1:0}class xu{constructor(t=9){this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(this._maxEntries*.4)),this.clear()}all(){return this._all(this.data,[])}search(t){let e=this.data;const n=[];if(!Ur(t,e))return n;const i=this.toBBox,s=[];for(;e;){for(let a=0;a<e.children.length;a++){const o=e.children[a],c=e.leaf?i(o):o;Ur(t,c)&&(e.leaf?n.push(o):zn(t,c)?this._all(o,n):s.push(o))}e=s.pop()}return n}collides(t){let e=this.data;if(!Ur(t,e))return!1;const n=[];for(;e;){for(let i=0;i<e.children.length;i++){const s=e.children[i],a=e.leaf?this.toBBox(s):s;if(Ur(t,a)){if(e.leaf||zn(t,a))return!0;n.push(s)}}e=n.pop()}return!1}load(t){if(!(t&&t.length))return this;if(t.length<this._minEntries){for(let n=0;n<t.length;n++)this.insert(t[n]);return this}let e=this._build(t.slice(),0,t.length-1,0);if(!this.data.children.length)this.data=e;else if(this.data.height===e.height)this._splitRoot(this.data,e);else{if(this.data.height<e.height){const n=this.data;this.data=e,e=n}this._insert(e,this.data.height-e.height-1,!0)}return this}insert(t){return t&&this._insert(t,this.data.height-1),this}clear(){return this.data=fe([]),this}remove(t,e){if(!t)return this;let n=this.data;const i=this.toBBox(t),s=[],a=[];let o,c,h;for(;n||s.length;){if(n||(n=s.pop(),c=s[s.length-1],o=a.pop(),h=!0),n.leaf){const l=Mu(t,n.children,e);if(l!==-1)return n.children.splice(l,1),s.push(n),this._condense(s),this}!h&&!n.leaf&&zn(n,i)?(s.push(n),a.push(o),o=0,c=n,n=n.children[0]):c?(o++,n=c.children[o],h=!1):n=null}return this}toBBox(t){return t}compareMinX(t,e){return t.minX-e.minX}compareMinY(t,e){return t.minY-e.minY}toJSON(){return this.data}fromJSON(t){return this.data=t,this}_all(t,e){const n=[];for(;t;)t.leaf?e.push(...t.children):n.push(...t.children),t=n.pop();return e}_build(t,e,n,i){const s=n-e+1;let a=this._maxEntries,o;if(s<=a)return o=fe(t.slice(e,n+1)),de(o,this.toBBox),o;i||(i=Math.ceil(Math.log(s)/Math.log(a)),a=Math.ceil(s/Math.pow(a,i-1))),o=fe([]),o.leaf=!1,o.height=i;const c=Math.ceil(s/a),h=c*Math.ceil(Math.sqrt(a));Js(t,e,n,h,this.compareMinX);for(let l=e;l<=n;l+=h){const u=Math.min(l+h-1,n);Js(t,l,u,c,this.compareMinY);for(let g=l;g<=u;g+=c){const v=Math.min(g+c-1,u);o.children.push(this._build(t,g,v,i-1))}}return de(o,this.toBBox),o}_chooseSubtree(t,e,n,i){for(;i.push(e),!(e.leaf||i.length-1===n);){let s=1/0,a=1/0,o;for(let c=0;c<e.children.length;c++){const h=e.children[c],l=Vn(h),u=Eu(t,h)-l;u<a?(a=u,s=l<s?l:s,o=h):u===a&&l<s&&(s=l,o=h)}e=o||e.children[0]}return e}_insert(t,e,n){const i=n?t:this.toBBox(t),s=[],a=this._chooseSubtree(i,this.data,e,s);for(a.children.push(t),Ve(a,i);e>=0&&s[e].children.length>this._maxEntries;)this._split(s,e),e--;this._adjustParentBBoxes(i,s,e)}_split(t,e){const n=t[e],i=n.children.length,s=this._minEntries;this._chooseSplitAxis(n,s,i);const a=this._chooseSplitIndex(n,s,i),o=fe(n.children.splice(a,n.children.length-a));o.height=n.height,o.leaf=n.leaf,de(n,this.toBBox),de(o,this.toBBox),e?t[e-1].children.push(o):this._splitRoot(n,o)}_splitRoot(t,e){this.data=fe([t,e]),this.data.height=t.height+1,this.data.leaf=!1,de(this.data,this.toBBox)}_chooseSplitIndex(t,e,n){let i,s=1/0,a=1/0;for(let o=e;o<=n-e;o++){const c=Ue(t,0,o,this.toBBox),h=Ue(t,o,n,this.toBBox),l=Iu(c,h),u=Vn(c)+Vn(h);l<s?(s=l,i=o,a=u<a?u:a):l===s&&u<a&&(a=u,i=o)}return i||n-e}_chooseSplitAxis(t,e,n){const i=t.leaf?this.compareMinX:bu,s=t.leaf?this.compareMinY:_u,a=this._allDistMargin(t,e,n,i),o=this._allDistMargin(t,e,n,s);a<o&&t.children.sort(i)}_allDistMargin(t,e,n,i){t.children.sort(i);const s=this.toBBox,a=Ue(t,0,e,s),o=Ue(t,n-e,n,s);let c=Wr(a)+Wr(o);for(let h=e;h<n-e;h++){const l=t.children[h];Ve(a,t.leaf?s(l):l),c+=Wr(a)}for(let h=n-e-1;h>=e;h--){const l=t.children[h];Ve(o,t.leaf?s(l):l),c+=Wr(o)}return c}_adjustParentBBoxes(t,e,n){for(let i=n;i>=0;i--)Ve(e[i],t)}_condense(t){for(let e=t.length-1,n;e>=0;e--)t[e].children.length===0?e>0?(n=t[e-1].children,n.splice(n.indexOf(t[e]),1)):this.clear():de(t[e],this.toBBox)}}function Mu(r,t,e){if(!e)return t.indexOf(r);for(let n=0;n<t.length;n++)if(e(r,t[n]))return n;return-1}function de(r,t){Ue(r,0,r.children.length,t,r)}function Ue(r,t,e,n,i){i||(i=fe(null)),i.minX=1/0,i.minY=1/0,i.maxX=-1/0,i.maxY=-1/0;for(let s=t;s<e;s++){const a=r.children[s];Ve(i,r.leaf?n(a):a)}return i}function Ve(r,t){return r.minX=Math.min(r.minX,t.minX),r.minY=Math.min(r.minY,t.minY),r.maxX=Math.max(r.maxX,t.maxX),r.maxY=Math.max(r.maxY,t.maxY),r}function bu(r,t){return r.minX-t.minX}function _u(r,t){return r.minY-t.minY}function Vn(r){return(r.maxX-r.minX)*(r.maxY-r.minY)}function Wr(r){return r.maxX-r.minX+(r.maxY-r.minY)}function Eu(r,t){return(Math.max(t.maxX,r.maxX)-Math.min(t.minX,r.minX))*(Math.max(t.maxY,r.maxY)-Math.min(t.minY,r.minY))}function Iu(r,t){const e=Math.max(r.minX,t.minX),n=Math.max(r.minY,t.minY),i=Math.min(r.maxX,t.maxX),s=Math.min(r.maxY,t.maxY);return Math.max(0,i-e)*Math.max(0,s-n)}function zn(r,t){return r.minX<=t.minX&&r.minY<=t.minY&&t.maxX<=r.maxX&&t.maxY<=r.maxY}function Ur(r,t){return t.minX<=r.maxX&&t.minY<=r.maxY&&t.maxX>=r.minX&&t.maxY>=r.minY}function fe(r){return{children:r,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function Js(r,t,e,n,i){const s=[t,e];for(;s.length;){if(e=s.pop(),t=s.pop(),e-t<=n)continue;const a=t+Math.ceil((e-t)/n/2)*n;wu(r,a,t,e,i),s.push(t,a,a,e)}}function Su(r,t,e){if(e===void 0&&(e={}),!r)throw new Error("point is required");if(!t)throw new Error("polygon is required");var n=ne(r),i=Va(t),s=i.type,a=t.bbox,o=i.coordinates;if(a&&Au(n,a)===!1)return!1;s==="Polygon"&&(o=[o]);for(var c=!1,h=0;h<o.length&&!c;h++)if(Ks(n,o[h][0],e.ignoreBoundary)){for(var l=!1,u=1;u<o[h].length&&!l;)Ks(n,o[h][u],!e.ignoreBoundary)&&(l=!0),u++;l||(c=!0)}return c}function Ks(r,t,e){var n=!1;t[0][0]===t[t.length-1][0]&&t[0][1]===t[t.length-1][1]&&(t=t.slice(0,t.length-1));for(var i=0,s=t.length-1;i<t.length;s=i++){var a=t[i][0],o=t[i][1],c=t[s][0],h=t[s][1],l=r[1]*(a-c)+o*(c-r[0])+h*(r[0]-a)===0&&(a-r[0])*(c-r[0])<=0&&(o-r[1])*(h-r[1])<=0;if(l)return!e;var u=o>r[1]!=h>r[1]&&r[0]<(c-a)*(r[1]-o)/(h-o)+a;u&&(n=!n)}return n}function Au(r,t){return t[0]<=r[0]&&t[1]<=r[1]&&t[2]>=r[0]&&t[3]>=r[1]}const Ru=!0;class Cu{constructor(){this.rbush=new xu,this.polygonsById=new Map,this.bboxesById=new Map,this.itemsById=new Map}addItem(t,e){this.removeItem(t);const n=st(e),i={minX:n[0],minY:n[1],maxX:n[2],maxY:n[3],id:t};this.polygonsById.set(t,e),this.bboxesById.set(t,n),this.itemsById.set(t,i),this.rbush.insert(i)}removeItem(t){const e=this.itemsById.get(t);e&&(this.rbush.remove(e),this.polygonsById.delete(t),this.bboxesById.delete(t),this.itemsById.delete(t))}clear(){this.rbush.clear()}search(t,e,n,i){return this.rbush.search({minX:t,minY:e,maxX:n,maxY:i})}getBbox(t){return this.bboxesById.get(t)}getPolygon(t){return this.polygonsById.get(t)}searchFromBbox(t){const[e,n,i,s]=t;return this.search(e,n,i,s).map(a=>a.id)}searchFromPoint(t,e=Ru){const[n,i,s,a]=[t[0],t[1],t[0],t[1]],o=this.search(n,i,s,a);return e?o.filter(c=>{const h=this.polygonsById.get(c.id);return h?Su(t,h):!1}).map(c=>c.id):o.map(c=>c.id)}}class Pu extends EventTarget{constructor(t,e){super(),this.warpedMapsById=new Map,this.zIndices=new Map,e=Object.assign({createRTree:!0},e),this.imageInfoCache=t,e.createRTree&&(this.rtree=new Cu)}getMaps(){return this.warpedMapsById.keys()}getWarpedMaps(t){if(t===void 0)return this.warpedMapsById.values();{const e=[];for(const n of t){const i=this.warpedMapsById.get(n);i&&e.push(i)}return e}}getWarpedMap(t){return this.warpedMapsById.get(t)}getMapZIndex(t){return this.zIndices.get(t)}getTotalBbox(){let t;for(const e of this.getWarpedMaps())e.visible&&(t?t=Vi(t,e.geoMaskBbox):t=e.geoMaskBbox);return t}getTotalProjectedGeoMaskBbox(){let t;for(const e of this.getWarpedMaps())e.visible&&(t?t=Vi(t,e.projectedGeoMaskBbox):t=e.projectedGeoMaskBbox);return t}getMapsByGeoBbox(t){return this.rtree?this.rtree.searchFromBbox(t):Array.from(this.warpedMapsById.keys())}setImageInfoCache(t){this.imageInfoCache=t}setMapResourceMask(t,e){const n=this.warpedMapsById.get(t);n&&(n.setResourceMask(e),this.addToOrUpdateRtree(n),this.dispatchEvent(new U(C.WarpedMapEventType.RESOURCEMASKUPDATED,t)))}setMapsTransformationType(t,e){for(const n of t){const i=this.warpedMapsById.get(n);i&&(i.setTransformationType(e),this.addToOrUpdateRtree(i))}this.dispatchEvent(new U(C.WarpedMapEventType.TRANSFORMATIONCHANGED,t))}bringMapsToFront(t){let e=this.warpedMapsById.size;for(const n of t)this.zIndices.has(n)&&(this.zIndices.set(n,e),e++);this.removeZIndexHoles(),this.dispatchEvent(new U(C.WarpedMapEventType.ZINDICESCHANGES))}sendMapsToBack(t){let e=-Array.from(t).length;for(const n of t)this.zIndices.has(n)&&(this.zIndices.set(n,e),e++);this.removeZIndexHoles(),this.dispatchEvent(new U(C.WarpedMapEventType.ZINDICESCHANGES))}bringMapsForward(t){for(const[e,n]of this.zIndices.entries())this.zIndices.set(e,n*2);for(const e of t){const n=this.zIndices.get(e);n!==void 0&&this.zIndices.set(e,n+3)}this.removeZIndexHoles(),this.dispatchEvent(new U(C.WarpedMapEventType.ZINDICESCHANGES))}sendMapsBackward(t){for(const[e,n]of this.zIndices.entries())this.zIndices.set(e,n*2);for(const e of t){const n=this.zIndices.get(e);n!==void 0&&this.zIndices.set(e,n-3)}this.removeZIndexHoles(),this.dispatchEvent(new U(C.WarpedMapEventType.ZINDICESCHANGES))}showMaps(t){for(const e of t){const n=this.warpedMapsById.get(e);n&&(n.visible=!0)}this.dispatchEvent(new U(C.WarpedMapEventType.VISIBILITYCHANGED,t))}hideMaps(t){for(const e of t){const n=this.warpedMapsById.get(e);n&&(n.visible=!1)}this.dispatchEvent(new U(C.WarpedMapEventType.VISIBILITYCHANGED,t))}async addGeoreferencedMap(t){const e=Hs(t),n=Array.isArray(e)?e[0]:e;return this.addGeoreferencedMapInternal(n)}async removeGeoreferencedMap(t){const e=Hs(t),n=Array.isArray(e)?e[0]:e;return this.removeGeoreferencedMapInternal(n)}async addGeoreferenceAnnotation(t){const e=[],n=Fn(t),i=await Promise.allSettled(n.map(s=>this.addGeoreferencedMapInternal(s)));for(const s of i)s.status==="fulfilled"?e.push(s.value):e.push(s.reason);return this.dispatchEvent(new U(C.WarpedMapEventType.GEOREFERENCEANNOTATIONADDED)),this.dispatchEvent(new U(C.WarpedMapEventType.ZINDICESCHANGES)),e}async removeGeoreferenceAnnotation(t){const e=[],n=Fn(t);for(const i of n){const s=await this.removeGeoreferencedMapInternal(i);e.push(s)}return this.dispatchEvent(new U(C.WarpedMapEventType.GEOREFERENCEANNOTATIONREMOVED)),e}clear(){this.warpedMapsById=new Map,this.zIndices=new Map,this.rtree?.clear(),this.dispatchEvent(new U(C.WarpedMapEventType.CLEARED))}dispose(){for(const t of this.getWarpedMaps())this.removeEventListenersFromWarpedMap(t),t.dispose()}async addGeoreferencedMapInternal(t){const e=await this.getOrComputeMapId(t),n=new jl(e,t,this.imageInfoCache);return this.warpedMapsById.set(e,n),this.zIndices.set(e,this.warpedMapsById.size-1),this.addToOrUpdateRtree(n),this.addEventListenersToWarpedMap(n),this.dispatchEvent(new U(C.WarpedMapEventType.WARPEDMAPADDED,e)),e}async removeGeoreferencedMapInternal(t){const e=await this.getOrComputeMapId(t),n=this.warpedMapsById.get(e);if(n)this.warpedMapsById.delete(e),this.zIndices.delete(e),this.removeFromRtree(n),this.dispatchEvent(new U(C.WarpedMapEventType.WARPEDMAPREMOVED,e)),this.removeZIndexHoles(),this.dispatchEvent(new U(C.WarpedMapEventType.ZINDICESCHANGES));else throw new Error(`No map found with ID ${e}`);return e}async getOrComputeMapId(t){return t.id||await po(t)}addToOrUpdateRtree(t){this.rtree&&(this.rtree.removeItem(t.mapId),this.rtree.addItem(t.mapId,t.geoMask))}removeFromRtree(t){this.rtree&&this.rtree.removeItem(t.mapId)}removeZIndexHoles(){const t=[...this.zIndices.entries()].sort((n,i)=>n[1]-i[1]);let e=0;for(const n of t){const i=n[0];this.zIndices.set(i,e),e++}}imageInfoLoaded(){this.dispatchEvent(new U(C.WarpedMapEventType.IMAGEINFOLOADED))}addEventListenersToWarpedMap(t){t.addEventListener(C.WarpedMapEventType.IMAGEINFOLOADED,this.imageInfoLoaded.bind(this))}removeEventListenersFromWarpedMap(t){t.removeEventListener(C.WarpedMapEventType.IMAGEINFOLOADED,this.imageInfoLoaded.bind(this))}}class ku extends EventTarget{constructor(t,e,n,i,s=1){super(),this.projectedGeoToViewportTransform=[1,0,0,1,0,0],this.projectedGeoToClipTransform=[1,0,0,1,0,0],this.projectedGeoCenter=t,this.projectedGeoPerViewportScale=i,this.rotation=n,this.viewportSize=e,this.devicePixelRatio=s,this.projectedGeoRectangle=this.computeProjectedGeoRectangle(this.projectedGeoCenter,this.projectedGeoPerViewportScale,this.rotation,this.viewportSize),this.projectedGeoBbox=st(this.projectedGeoRectangle),this.projectedGeoSize=[this.viewportSize[0]*i,this.viewportSize[1]*i],this.geoCenter=qi(this.projectedGeoCenter),this.geoRectangle=this.projectedGeoRectangle.map(a=>qi(a)),this.geoBbox=st(this.geoRectangle),this.geoSize=dr(this.geoBbox),this.viewportCenter=[this.viewportSize[0]/2,this.viewportSize[1]/2],this.viewportBbox=[0,0,...this.viewportSize],this.viewportRectangle=Pe(this.viewportBbox),this.canvasCenter=[this.viewportCenter[0]*this.devicePixelRatio,this.viewportSize[1]*this.devicePixelRatio],this.canvasSize=[this.viewportSize[0]*this.devicePixelRatio,this.viewportSize[1]*this.devicePixelRatio],this.canvasBbox=[0,0,...this.canvasSize],this.canvasRectangle=Pe(this.canvasBbox),this.projectedGeoPerCanvasScale=this.projectedGeoPerViewportScale/this.devicePixelRatio,this.projectedGeoToViewportTransform=this.composeProjectedGeoToViewportTransform(),this.projectedGeoToClipTransform=this.composeProjectedGeoToClipTransform()}composeProjectedGeoToViewportTransform(){return ks(this.viewportSize[0]/2,this.viewportSize[1]/2,1/this.projectedGeoPerViewportScale,-1/this.projectedGeoPerViewportScale,-this.rotation,-this.projectedGeoCenter[0],-this.projectedGeoCenter[1])}composeProjectedGeoToClipTransform(){return ks(0,0,2/(this.projectedGeoPerViewportScale*this.viewportSize[0]),2/(this.projectedGeoPerViewportScale*this.viewportSize[1]),-this.rotation,-this.projectedGeoCenter[0],-this.projectedGeoCenter[1])}computeProjectedGeoRectangle(t,e,n,i){const s=e*i[0]/2,a=e*i[1]/2,o=Math.cos(n),c=Math.sin(n),h=s*o,l=s*c,u=a*o,g=a*c,v=t[0],y=t[1];return[[v-h+g,y-l-u],[v-h-g,y-l+u],[v+h-g,y+l+u],[v+h+g,y+l-u]]}}class Ou extends EventTarget{constructor(t){super(),this.tile=t.tile,this.imageRequest=t.imageRequest,this.tileUrl=t.tileUrl,this.abortController=new AbortController}async fetch(){try{const t=await qa(this.tileUrl,this.abortController.signal);return this.imageBitmap=await createImageBitmap(t),this.dispatchEvent(new U(C.WarpedMapEventType.TILEFETCHED,this.tileUrl)),this.imageBitmap}catch(t){t instanceof Error&&t.name==="AbortError"||this.dispatchEvent(new U(C.WarpedMapEventType.TILEFETCHERROR,this.tileUrl))}}isCachedTile(){return this.imageBitmap!==void 0}abort(){this.abortController.signal.aborted||this.abortController.abort()}}const Nu=.75;function Qs(r,t){return`${r}:${t}`}function to(r){return Qs(r.mapId,r.tileUrl)}function Zn(r){return new Set(r.map(t=>to(t)))}function Lu(r,t,e={maxOffsetRatio:1e-5,maxDepth:2}){const n=ic(t)[0];return r.transformBackward(n,e)}function Du(r,t,e=Nu){let n=Number.POSITIVE_INFINITY,i=r.tileZoomLevels.at(-1);for(const s of r.tileZoomLevels){const a=Math.abs(Math.log(s.scaleFactor)-(Math.log(t)-Math.log(e)));a<n&&(n=a,i=s)}return i}function ju(r,t,e){const n=Bu(r,t),i=Gu(n),s=Wu(i,e,t),a=an(st(r));return s.sort((o,c)=>eo(o,a)-eo(c,a)),s}function Bu(r,t){return r.map(e=>[e[0]/t.originalWidth,e[1]/t.originalHeight])}function Gu(r){const t={};for(let e=0;e<r.length;e++){const n=[r[e],r[(e+1)%r.length]];Fu(n).forEach(([s,a])=>{t[s]||(t[s]=[Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY]),a<t[s][0]&&(t[s][0]=a),a>t[s][1]&&(t[s][1]=a)})}return t}function Fu([r,t]){let e=Math.floor(r[0]),n=Math.floor(r[1]);const i=Math.floor(t[0]),s=Math.floor(t[1]),a=[[e,n]];if(e===i&&n===s)return a;const o=Math.sign(t[0]-r[0]),c=Math.sign(t[1]-r[1]),h=Math.abs(r[0]-e-Math.max(0,o)),l=Math.abs(r[1]-n-Math.max(0,c)),u=Math.abs(r[0]-t[0]),g=Math.abs(r[1]-t[1]);let v=h/u,y=l/g;const E=1/u,I=1/g;for(;!(e===i&&n===s);)v<y?(v=v+E,e=e+o):(y=y+I,n=n+c),a.push([e,n]);return a}function Wu(r,t,e){const n=[];for(const i in r){const s=parseInt(i);if(s<0||s>=e.columns)break;const a=Math.max(r[s][0],0),o=Math.min(r[s][1],e.rows-1);for(let c=a;c<=o;c++)n.push({column:s,row:c,tileZoomLevel:e,imageSize:[t.width,t.height]})}return n}function Uu(r){return(r.imageRequest.size?.height||0)*(r.imageRequest.size?.width||0)*3}function eo(r,t){return Lt(Vu(r),t)}function Vu(r){const t=ro(r);return[(t[2]-t[0])/2+t[0],(t[3]-t[1])/2+t[1]]}function zu(r){const t=r.column*r.tileZoomLevel.originalWidth,e=r.row*r.tileZoomLevel.originalHeight;return[t,e]}function ro(r){const t=zu(r),e=Math.min(t[0]+r.tileZoomLevel.originalWidth,r.imageSize[0]),n=Math.min(t[1]+r.tileZoomLevel.originalHeight,r.imageSize[1]);return[t[0],t[1],e,n]}const Zu=50,$u=32*1e3*1e3;class Xu extends EventTarget{constructor(){super(...arguments),this.tilesByTileUrl=new Map,this.mapIdsByTileUrl=new Map,this.tileUrlsByMapId=new Map,this.tilesFetchingCount=0,this.previousRequestedTiles=[],this.outgoingTilesHistory=[]}getCacheableTile(t){return this.tilesByTileUrl.get(t)}getCachedTile(t){const e=this.tilesByTileUrl.get(t);if(e&&e.isCachedTile())return e}getCacheableTiles(){return this.tilesByTileUrl.values()}getCachedTiles(){const t=Array.from(this.tilesByTileUrl.values()),e=[];return t.forEach(n=>{n.isCachedTile()&&e.push(n)}),e}getTileUrls(){return this.tilesByTileUrl.keys()}requestFetcableMapTiles(t){const e=Zn(this.previousRequestedTiles),n=Zn(t);if(cc(e,n))return;const i=[];for(const o of this.previousRequestedTiles)n.has(to(o))||i.push(o);this.updateOutgoingTilesHistory(i,t.length);const s=Zn(this.outgoingTilesHistory),a=new Set([...n,...s]);for(const[o,c]of this.mapIdsByTileUrl)for(const h of c)a.has(Qs(h,o))||this.removeMapTile(h,o);for(const o of t)this.addMapTile(o);this.previousRequestedTiles=t}clear(){this.tilesByTileUrl=new Map,this.mapIdsByTileUrl=new Map,this.tileUrlsByMapId=new Map,this.tilesFetchingCount=0,this.outgoingTilesHistory=[]}dispose(){for(const t of this.getCacheableTiles())this.removeEventListenersFromTile(t)}addMapTile(t){const e=t.mapId,n=t.tileUrl;if(this.tilesByTileUrl.has(n))this.dispatchEvent(new U(C.WarpedMapEventType.MAPTILELOADED,{mapId:e,tileUrl:n}));else{const i=new Ou(t);this.addEventListenersToTile(i),this.tilesByTileUrl.set(n,i),this.updateTilesFetchingCount(1),i.fetch()}this.addTileUrlForMapId(e,n),this.addMapIdForTileUrl(e,n)}removeMapTile(t,e){const n=this.tilesByTileUrl.get(e);if(!n)return;const i=this.removeMapIdForTileUrl(t,e);this.removeTileUrlForMapId(t,e),i.size||(n.isCachedTile()||(n.abort(),this.updateTilesFetchingCount(-1)),this.tilesByTileUrl.delete(e)),this.dispatchEvent(new U(C.WarpedMapEventType.MAPTILEREMOVED,{mapId:t,tileUrl:e}))}updateOutgoingTilesHistory(t,e){for(let a=t.length-1;a>=0;a--){const o=t[a];this.outgoingTilesHistory.unshift(o)}this.outgoingTilesHistory=Array.from(new Set(this.outgoingTilesHistory));let n=0,i=0,s=0;for(const a of this.outgoingTilesHistory){if(n+=1,s=Uu(a),i+=s,n+e>Zu){n-=1,i-=s;break}if(i>$u){n-=1,i-=s;break}}this.outgoingTilesHistory=this.outgoingTilesHistory.slice(0,n)}tileFetched(t){if(t instanceof U){const e=t.data;this.updateTilesFetchingCount(-1);for(const n of this.mapIdsByTileUrl.get(e)||[])this.dispatchEvent(new U(C.WarpedMapEventType.MAPTILELOADED,{mapId:n,tileUrl:e})),this.tileUrlsByMapId.get(n)?.values().next().value===e&&this.dispatchEvent(new U(C.WarpedMapEventType.FIRSTMAPTILELOADED,{mapId:n,tileUrl:e}))}}tileFetchError(t){if(t instanceof U){const e=t.data;this.tilesByTileUrl.has(e)||(this.updateTilesFetchingCount(-1),this.tilesByTileUrl.delete(e))}}addMapIdForTileUrl(t,e){let n=this.mapIdsByTileUrl.get(e);return n?n.add(t):n=new Set([t]),this.mapIdsByTileUrl.set(e,n),n}removeMapIdForTileUrl(t,e){const n=this.mapIdsByTileUrl.get(e);if(n)n.delete(t);else return new Set;return n.size?this.mapIdsByTileUrl.set(e,n):this.mapIdsByTileUrl.delete(e),n}addTileUrlForMapId(t,e){let n=this.tileUrlsByMapId.get(t);return n?n.add(e):n=new Set([e]),this.tileUrlsByMapId.set(t,n),n}removeTileUrlForMapId(t,e){const n=this.tileUrlsByMapId.get(t);return n?(n.delete(e),n.size?this.tileUrlsByMapId.set(t,n):this.tileUrlsByMapId.delete(t),n):new Set}updateTilesFetchingCount(t){this.tilesFetchingCount+=t,this.tilesFetchingCount===0&&this.dispatchEvent(new U(C.WarpedMapEventType.ALLREQUESTEDTILESLOADED))}addEventListenersToTile(t){t.addEventListener(C.WarpedMapEventType.TILEFETCHED,this.tileFetched.bind(this)),t.addEventListener(C.WarpedMapEventType.TILEFETCHERROR,this.tileFetchError.bind(this))}removeEventListenersFromTile(t){t.removeEventListener(C.WarpedMapEventType.TILEFETCHED,this.tileFetched.bind(this)),t.removeEventListener(C.WarpedMapEventType.TILEFETCHERROR,this.tileFetchError.bind(this))}}class qu{constructor(t,e){this.mapId=e.mapId,this.tile=t;const n=e.parsedImage.getIiifTile(t.tileZoomLevel,t.column,t.row);this.imageRequest=n;const i=e.parsedImage.getImageUrl(n);this.tileUrl=i}}var Hu=typeof globalThis=="object"&&globalThis&&globalThis.Object===Object&&globalThis;const Yu=Hu;var Ju=typeof self=="object"&&self&&self.Object===Object&&self,Ku=Yu||Ju||Function("return this")();const no=Ku;var Qu=no.Symbol;const Vr=Qu;var io=Object.prototype,td=io.hasOwnProperty,ed=io.toString,ze=Vr?Vr.toStringTag:void 0;function rd(r){var t=td.call(r,ze),e=r[ze];try{r[ze]=void 0;var n=!0}catch{}var i=ed.call(r);return n&&(t?r[ze]=e:delete r[ze]),i}var nd=Object.prototype,id=nd.toString;function sd(r){return id.call(r)}var od="[object Null]",ad="[object Undefined]",so=Vr?Vr.toStringTag:void 0;function cd(r){return r==null?r===void 0?ad:od:so&&so in Object(r)?rd(r):sd(r)}function hd(r){return r!=null&&typeof r=="object"}var ld="[object Symbol]";function ud(r){return typeof r=="symbol"||hd(r)&&cd(r)==ld}var dd=/\s/;function fd(r){for(var t=r.length;t--&&dd.test(r.charAt(t)););return t}var pd=/^\s+/;function gd(r){return r&&r.slice(0,fd(r)+1).replace(pd,"")}function zr(r){var t=typeof r;return r!=null&&(t=="object"||t=="function")}var oo=0/0,md=/^[-+]0x[0-9a-f]+$/i,yd=/^0b[01]+$/i,vd=/^0o[0-7]+$/i,wd=parseInt;function ao(r){if(typeof r=="number")return r;if(ud(r))return oo;if(zr(r)){var t=typeof r.valueOf=="function"?r.valueOf():r;r=zr(t)?t+"":t}if(typeof r!="string")return r===0?r:+r;r=gd(r);var e=yd.test(r);return e||vd.test(r)?wd(r.slice(2),e?2:8):md.test(r)?oo:+r}var Td=function(){return no.Date.now()};const $n=Td;var xd="Expected a function",Md=Math.max,bd=Math.min;function _d(r,t,e){var n,i,s,a,o,c,h=0,l=!1,u=!1,g=!0;if(typeof r!="function")throw new TypeError(xd);t=ao(t)||0,zr(e)&&(l=!!e.leading,u="maxWait"in e,s=u?Md(ao(e.maxWait)||0,t):s,g="trailing"in e?!!e.trailing:g);function v(A){var k=n,_=i;return n=i=void 0,h=A,a=r.apply(_,k),a}function y(A){return h=A,o=setTimeout(w,t),l?v(A):a}function E(A){var k=A-c,_=A-h,d=t-k;return u?bd(d,s-_):d}function I(A){var k=A-c,_=A-h;return c===void 0||k>=t||k<0||u&&_>=s}function w(){var A=$n();if(I(A))return S(A);o=setTimeout(w,E(A))}function S(A){return o=void 0,g&&n?v(A):(n=i=void 0,a)}function f(){o!==void 0&&clearTimeout(o),h=0,n=c=i=o=void 0}function p(){return o===void 0?a:S($n())}function x(){var A=$n(),k=I(A);if(n=arguments,i=this,c=A,k){if(o===void 0)return y(c);if(u)return clearTimeout(o),o=setTimeout(w,t),v(c)}return o===void 0&&(o=setTimeout(w,t)),a}return x.cancel=f,x.flush=p,x}var Ed="Expected a function";function Xn(r,t,e){var n=!0,i=!0;if(typeof r!="function")throw new TypeError(Ed);return zr(e)&&(n="leading"in e?!!e.leading:n,i="trailing"in e?!!e.trailing:i),_d(r,t,{leading:n,maxWait:t,trailing:i})}function Id(r){let t=0,e=0;for(const o of r)t+=o.w*o.h,e=Math.max(e,o.w);r.sort((o,c)=>c.h-o.h);const i=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(t/.95)),e),h:1/0}];let s=0,a=0;for(const o of r)for(let c=i.length-1;c>=0;c--){const h=i[c];if(!(o.w>h.w||o.h>h.h)){if(o.x=h.x,o.y=h.y,a=Math.max(a,o.y+o.h),s=Math.max(s,o.x+o.w),o.w===h.w&&o.h===h.h){const l=i.pop();c<i.length&&(i[c]=l)}else o.h===h.h?(h.x+=o.w,h.w-=o.w):o.w===h.w?(h.y+=o.h,h.h-=o.h):(i.push({x:h.x+o.w,y:h.y,w:h.w-o.w,h:o.h}),h.y+=o.h,h.h-=o.h);break}}return{w:s,h:a,fill:t/(s*a)||0}}function co(r,t,e){const n=r.createShader(t);if(n){if(r.shaderSource(n,e),r.compileShader(n),r.getShaderParameter(n,r.COMPILE_STATUS))return n;{const s=r.getShaderInfoLog(n);throw r.deleteShader(n),new Error("Failed to compile shader: "+s)}}else throw new Error("Failed to create shader")}function Sd(r,t,e){const n=r.createProgram();if(n){if(r.attachShader(n,t),r.attachShader(n,e),r.linkProgram(n),r.getProgramParameter(n,r.LINK_STATUS))return n;{const s=r.getProgramInfoLog(n);throw r.deleteProgram(n),new Error("Failed to link program: "+s)}}else throw new Error("Failed to create program")}function Zr(r,t,e,n,i){const s=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,s),r.bufferData(r.ARRAY_BUFFER,e,r.STATIC_DRAW);const a=r.FLOAT,o=!1,c=0,h=0,l=r.getAttribLocation(t,i);r.vertexAttribPointer(l,n,a,o,c,h),r.enableVertexAttribArray(l)}const Ad=250,Rd={leading:!0,trailing:!0},Cd=1,Pd=1;class kd extends EventTarget{constructor(t,e,n){super(),this.CachedTilesByTileUrl=new Map,this.opacity=Cd,this.saturation=Pd,this.renderOptions={},this.warpedMap=n,this.gl=t,this.program=e,this.vao=t.createVertexArray(),this.packedTilesTexture=t.createTexture(),this.packedTilesScaleFactorsTexture=t.createTexture(),this.packedTilesPositionsTexture=t.createTexture(),this.packedTilesResourcePositionsAndDimensionsTexture=t.createTexture(),this.throttledUpdateTextures=Xn(this.updateTextures.bind(this),Ad,Rd)}updateVertexBuffers(t){this.projectedGeoToClipTransform=t,this.updateVertexBuffersInternal()}addCachedTileAndUpdateTextures(t){this.CachedTilesByTileUrl.set(t.tileUrl,t),this.throttledUpdateTextures()}removeCachedTileAndUpdateTextures(t){this.CachedTilesByTileUrl.delete(t),this.throttledUpdateTextures()}dispose(){this.gl.deleteVertexArray(this.vao),this.gl.deleteTexture(this.packedTilesTexture),this.gl.deleteTexture(this.packedTilesScaleFactorsTexture),this.gl.deleteTexture(this.packedTilesPositionsTexture),this.gl.deleteTexture(this.packedTilesResourcePositionsAndDimensionsTexture)}updateVertexBuffersInternal(){if(!this.vao||!this.projectedGeoToClipTransform)return;this.gl.bindVertexArray(this.vao),Zr(this.gl,this.program,new Float32Array(this.warpedMap.resourceTrianglePoints.flat()),2,"a_resourceTrianglePoint");const t=this.warpedMap.projectedGeoCurrentTrianglePoints.map(i=>ue(this.projectedGeoToClipTransform,i));Zr(this.gl,this.program,new Float32Array(t.flat()),2,"a_clipCurrentTrianglePoint");const e=this.warpedMap.projectedGeoNewTrianglePoints.map(i=>ue(this.projectedGeoToClipTransform,i));Zr(this.gl,this.program,new Float32Array(e.flat()),2,"a_clipNewTrianglePoint");let n=new Float32Array(this.warpedMap.resourceTrianglePoints.length);n=n.map((i,s)=>Math.round((s-1)/3)),Zr(this.gl,this.program,n,1,"a_triangleIndex")}async updateTextures(){const t=this.gl;if(this.CachedTilesByTileUrl.size===0)return;let e=[...this.CachedTilesByTileUrl.values()];e=e.filter(l=>this.warpedMap.resourceViewportRingBbox?nc(ro(l.tile),this.warpedMap.resourceViewportRingBbox):!0);const n=e.length,i=e.map((l,u)=>({w:l.imageBitmap.width,h:l.imageBitmap.height,x:0,y:0,index:u})),{w:s,h:a}=Id(i);t.pixelStorei(t.UNPACK_ALIGNMENT,4),t.bindTexture(t.TEXTURE_2D,this.packedTilesTexture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,s,a,0,t.RGBA,t.UNSIGNED_BYTE,null);for(const l of i){const u=e[l.index].imageBitmap;t.texSubImage2D(t.TEXTURE_2D,0,l.x,l.y,u.width,u.height,t.RGBA,t.UNSIGNED_BYTE,u)}t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);const o=i.map(l=>[l.x,l.y]);t.bindTexture(t.TEXTURE_2D,this.packedTilesPositionsTexture),t.texImage2D(t.TEXTURE_2D,0,t.RG32I,1,n,0,t.RG_INTEGER,t.INT,new Int32Array(o.flat())),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);const c=i.map(l=>{const u=e[l.index];if(u&&u.imageRequest&&u.imageRequest.region)return[u.imageRequest.region.x,u.imageRequest.region.y,u.imageRequest.region.width,u.imageRequest.region.height]});t.bindTexture(t.TEXTURE_2D,this.packedTilesResourcePositionsAndDimensionsTexture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA32I,1,n,0,t.RGBA_INTEGER,t.INT,new Int32Array(c.flat())),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);const h=i.map(({index:l})=>e[l].tile.tileZoomLevel.scaleFactor);t.bindTexture(t.TEXTURE_2D,this.packedTilesScaleFactorsTexture),t.texImage2D(t.TEXTURE_2D,0,t.R32I,1,n,0,t.RED_INTEGER,t.INT,new Int32Array(h)),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),this.dispatchEvent(new U(C.WarpedMapEventType.TEXTURESUPDATED))}}const Od=`#version 300 es

precision highp float;

uniform mat4 u_renderTransform;

uniform float u_animationProgress;

in vec2 a_clipCurrentTrianglePoint;
in vec2 a_clipNewTrianglePoint;
in vec2 a_resourceTrianglePoint;
in float a_triangleIndex;

out vec2 v_resourceTrianglePoint;
out float v_triangleIndex;

float cubicInOut(float t) {
  return t < 0.5f ? 4.0f * t * t * t : 0.5f * pow(2.0f * t - 2.0f, 3.0f) + 1.0f;
}

void main() {
  // Pass attributes as varyings to fragment shader
  v_resourceTrianglePoint = a_resourceTrianglePoint;
  v_triangleIndex = a_triangleIndex;

  // Compute triangle vertex coordinates by mixing current and new
  vec2 clipTrianglePoint = mix(a_clipCurrentTrianglePoint, a_clipNewTrianglePoint, cubicInOut(u_animationProgress));

  // Set triangle points coordinates
  // Variables that start with gl_ are special globalThis variables
  // gl_Position stores the vertex (or 'point') positions (or 'coordinates') in clip coordinates (which go from -1 to 1.)

  gl_Position = u_renderTransform * vec4(clipTrianglePoint, 0.0f, 1.0f);
}
`,Nd=`#version 300 es

precision highp float;
precision highp isampler2D;

uniform bool u_removeColor;
uniform vec3 u_removeColorOptionsColor;
uniform float u_removeColorOptionsThreshold;
uniform float u_removeColorOptionsHardness;

uniform bool u_colorize;
uniform vec3 u_colorizeOptionsColor;

uniform float u_opacity;
uniform float u_saturation;

uniform int u_bestScaleFactor;

uniform sampler2D u_packedTilesTexture;
uniform isampler2D u_packedTilesPositionsTexture;
uniform isampler2D u_packedTilesResourcePositionsAndDimensionsTexture;
uniform isampler2D u_packedTilesScaleFactorsTexture;

in vec2 v_resourceTrianglePoint;
in float v_triangleIndex;

out vec4 color;

void main() {
  // The treated triangle point
  int resourceTrianglePointX = int(round(v_resourceTrianglePoint.x));
  int resourceTrianglePointY = int(round(v_resourceTrianglePoint.y));

  // Reading information on packed tiles from textures
  int packedTilesCount = textureSize(u_packedTilesPositionsTexture, 0).y;
  ivec2 packedTilesTextureSize = textureSize(u_packedTilesTexture, 0);

  // Setting references for the for loop
  int smallestScaleFactorDiff = 256 * 256; // Starting with very high number
  int bestScaleFactor = 0;

  // Prepare storage for the resulting packed tiles texture point that corresponds to the treated triangle point
  vec2 packedTilesTexturePoint = vec2(0.0f, 0.0f);

  color = vec4(0.0f, 0.0f, 0.0f, 0.0f);

  bool found = false;

  // Loop through all packed tiles
  for(int index = 0; index < packedTilesCount; index += 1) {

    // Read the information of the tile
    ivec2 packedTilePosition = texelFetch(u_packedTilesPositionsTexture, ivec2(0, index), 0).rg;
    ivec4 packedTileResourcePositionAndDimension = texelFetch(u_packedTilesResourcePositionsAndDimensionsTexture, ivec2(0, index), 0);
    int packedTileScaleFactor = texelFetch(u_packedTilesScaleFactorsTexture, ivec2(0, index), 0).r;

    float packedTilePositionX = float(packedTilePosition.r);
    float packedTilePositionY = float(packedTilePosition.g);

    int packedTileResourcePositionX = packedTileResourcePositionAndDimension.r;
    int packedTileResourcePositionY = packedTileResourcePositionAndDimension.g;

    int packedTileDimensionWidth = packedTileResourcePositionAndDimension.b;
    int packedTileDimensionHeight = packedTileResourcePositionAndDimension.a;

    // If the treated triangle point is inside the tile, consider to use the tile:
    // if the scale factor is closer to the best scale factor for this map then currently known one
    // update the smallest scale factor diff
    // and compute the packed tiles texture point that corresponds to the treated triangle point
    if(resourceTrianglePointX >= packedTileResourcePositionX &&
      resourceTrianglePointX < packedTileResourcePositionX + packedTileDimensionWidth &&
      resourceTrianglePointY >= packedTileResourcePositionY &&
      resourceTrianglePointY < packedTileResourcePositionY + packedTileDimensionHeight) {
      found = true;

      int scaleFactorDiff = abs(u_bestScaleFactor - packedTileScaleFactor);

      if(scaleFactorDiff < smallestScaleFactorDiff || bestScaleFactor == 0) {

        smallestScaleFactorDiff = scaleFactorDiff;
        bestScaleFactor = packedTileScaleFactor;

        float packedTilePointX = float(resourceTrianglePointX - packedTileResourcePositionX) / float(bestScaleFactor);
        float packedTilePointY = float(resourceTrianglePointY - packedTileResourcePositionY) / float(bestScaleFactor);

        float packedTilesPointX = packedTilePositionX + packedTilePointX;
        float packedTilesPointY = packedTilePositionY + packedTilePointY;

        float packedTilesTexturePointX = round(packedTilesPointX) / float(packedTilesTextureSize.x);
        float packedTilesTexturePointY = round(packedTilesPointY) / float(packedTilesTextureSize.y);

        packedTilesTexturePoint = vec2(packedTilesTexturePointX, packedTilesTexturePointY);
      }
    }
  }

  if(found == true) {
    // Read color of the treated point at it's packed tiles texture point coordinates in the packed tiles texture
    color = texture(u_packedTilesTexture, packedTilesTexturePoint);

    // Remove background color
    if(u_removeColorOptionsThreshold > 0.0f) {
      vec3 backgroundColorDiff = color.rgb - u_removeColorOptionsColor.rgb;
      float backgroundColorDistance = length(backgroundColorDiff);
      if(u_removeColor && backgroundColorDistance < u_removeColorOptionsThreshold) {
        float amount = smoothstep(u_removeColorOptionsThreshold - u_removeColorOptionsThreshold * (1.0f - u_removeColorOptionsHardness), u_removeColorOptionsThreshold, backgroundColorDistance);
        color = vec4(color.rgb * amount, amount);
      }
    }

    // Saturation
    float gray = 0.21f * color.r + 0.71f * color.g + 0.07f * color.b;
    color = vec4(color.rgb * (u_saturation) + (gray * (1.0f - u_saturation)), color.a);

    // Colorize
    if(u_colorize) {
      color = vec4((u_colorizeOptionsColor + color.rgb) * color.a, color.a);
    }

    // Opacity
    color = vec4(color.rgb * u_opacity, color.a * u_opacity);

    // Debugging: uncomment to override color of the treated point with a color made from the point's triangle index
    // vec4 debugColor = vec4(abs(sin(v_triangleIndex)), abs(sin(v_triangleIndex + 1.0f)), abs(sin(v_triangleIndex + 2.0f)), 1);
    // color = debugColor;
  }
}
`,Ld=500,Dd={leading:!0,trailing:!0},jd=50,Bd={leading:!0,trailing:!0},qn=1,Hn=1,Gd=0,Fd=.7,Wd=5,Ud=5,ho=750;class Vd extends EventTarget{constructor(t,e){super(),this.webgl2WarpedMapsById=new Map,this.tileCache=new Xu,this.mapsInViewport=new Set,this.opacity=qn,this.saturation=Hn,this.renderOptions={},this.animating=!1,this.animationProgress=1,this.warpedMapList=e,this.gl=t;const n=co(t,t.VERTEX_SHADER,Od),i=co(t,t.FRAGMENT_SHADER,Nd);this.program=Sd(t,n,i),t.deleteShader(n),t.deleteShader(i),t.disable(t.DEPTH_TEST),this.invertedRenderTransform=Pl(),this.addEventListeners(),this.throttledPrepareRenderInternal=Xn(this.prepareRenderInternal.bind(this),Ld,Dd),this.throttledChanged=Xn(this.changed.bind(this),jd,Bd)}getOpacity(){return this.opacity}setOpacity(t){this.opacity=t}resetOpacity(){this.opacity=qn}getMapOpacity(t){const e=this.webgl2WarpedMapsById.get(t);if(e)return e.opacity}setMapOpacity(t,e){const n=this.webgl2WarpedMapsById.get(t);n&&(n.opacity=Math.min(Math.max(e,0),1))}resetMapOpacity(t){const e=this.webgl2WarpedMapsById.get(t);e&&(e.opacity=qn)}getRemoveColorOptions(){return this.renderOptions.removeColorOptions}setRemoveColorOptions(t){this.renderOptions.removeColorOptions=t}resetRemoveColorOptions(){this.renderOptions.removeColorOptions=void 0}getMapRemoveColorOptions(t){const e=this.webgl2WarpedMapsById.get(t);if(e)return e.renderOptions.removeColorOptions}setMapRemoveColorOptions(t,e){const n=this.webgl2WarpedMapsById.get(t);n&&(n.renderOptions.removeColorOptions=e)}resetMapRemoveColorOptions(t){const e=this.webgl2WarpedMapsById.get(t);e&&(e.renderOptions.removeColorOptions=void 0)}getColorizeOptions(){return this.renderOptions.colorizeOptions}setColorizeOptions(t){this.renderOptions.colorizeOptions=t}resetColorizeOptions(){this.renderOptions.colorizeOptions=void 0}getMapColorizeOptions(t){const e=this.webgl2WarpedMapsById.get(t);if(e)return e.renderOptions.colorizeOptions}setMapColorizeOptions(t,e){const n=this.webgl2WarpedMapsById.get(t);n&&(n.renderOptions.colorizeOptions=e)}resetMapColorizeOptions(t){const e=this.webgl2WarpedMapsById.get(t);e&&(e.renderOptions.colorizeOptions=void 0)}getSaturation(){return this.saturation}setSaturation(t){this.saturation=t}resetSaturation(){this.saturation=Hn}getMapSaturation(t){const e=this.webgl2WarpedMapsById.get(t);if(e)return e.saturation}setMapSaturation(t,e){const n=this.webgl2WarpedMapsById.get(t);n&&(n.saturation=e)}resetMapSaturation(t){const e=this.webgl2WarpedMapsById.get(t);e&&(e.saturation=Hn)}render(t){this.viewport=t,this.throttledPrepareRenderInternal(),this.renderInternal()}clear(){this.webgl2WarpedMapsById=new Map,this.mapsInViewport=new Set,this.gl.clear(this.gl.DEPTH_BUFFER_BIT|this.gl.COLOR_BUFFER_BIT),this.tileCache.clear()}dispose(){for(const t of this.webgl2WarpedMapsById.values())this.removeEventListenersFromWebGL2WarpedMap(t),t.dispose();this.tileCache.clear(),this.tileCache.dispose(),this.removeEventListeners(),this.gl.deleteProgram(this.program)}startTransformationTransition(){this.lastAnimationFrameRequestId!==void 0&&cancelAnimationFrame(this.lastAnimationFrameRequestId),this.animating=!0,this.transformationTransitionStart=void 0,this.lastAnimationFrameRequestId=requestAnimationFrame(this.transformationTransitionFrame.bind(this))}transformationTransitionFrame(t){if(this.transformationTransitionStart||(this.transformationTransitionStart=t),t-this.transformationTransitionStart<ho)this.animationProgress=(t-this.transformationTransitionStart)/ho,this.renderInternal(),this.lastAnimationFrameRequestId=requestAnimationFrame(this.transformationTransitionFrame.bind(this));else{for(const e of this.warpedMapList.getWarpedMaps())e.resetCurrentTrianglePoints();this.updateVertexBuffers(),this.animating=!1,this.animationProgress=0,this.transformationTransitionStart=void 0}}prepareRenderInternal(){this.updateRequestedTiles(),this.updateVertexBuffers()}updateVertexBuffers(){if(this.viewport){this.invertedRenderTransform=Ol(this.viewport.projectedGeoToClipTransform);for(const t of this.mapsInViewport){const e=this.webgl2WarpedMapsById.get(t);if(!e)break;e.updateVertexBuffers(this.viewport.projectedGeoToClipTransform)}}}updateRequestedTiles(){if(!this.viewport||!this.viewportMovedSignificantly())return;const t=Array.from(this.warpedMapList.getMapsByGeoBbox(this.viewport.geoBbox)).sort((n,i)=>Lt(an(this.warpedMapList.getWarpedMap(n).geoMaskBbox),this.viewport.geoCenter)-Lt(an(this.warpedMapList.getWarpedMap(i).geoMaskBbox),this.viewport.geoCenter)),e=[];for(const n of t){const i=this.warpedMapList.getWarpedMap(n);if(!i||!i.visible)continue;if(!i.hasImageInfo()){i.loadImageInfo();continue}if(sc(i.getApproxViewportMaskBbox(this.viewport))<Wd)continue;const s=Du(i.parsedImage,i.getApproxResourceToCanvasScale(this.viewport));i.updateBestScaleFactor(s.scaleFactor);const a={maxDepth:0},o=Lu(i.projectedTransformer,this.viewport.projectedGeoBbox,a);i.setResourceViewportRing(o);const c=ju(o,s,i.parsedImage);for(const h of c)e.push(new qu(h,i))}this.tileCache.requestFetcableMapTiles(e),this.updateMapsInViewport(e)}viewportMovedSignificantly(){if(!this.viewport)return!1;if(this.previousSignificantViewport){const t=[];for(let n=0;n<4;n++)t.push(Lt(this.previousSignificantViewport.projectedGeoRectangle[n],this.viewport.projectedGeoRectangle[n])/this.viewport.projectedGeoPerViewportScale);const e=Math.max(...t);return e==0?!0:e>Ud?(this.previousSignificantViewport=this.viewport,!0):!1}else return this.previousSignificantViewport=this.viewport,!1}updateMapsInViewport(t){const e=Array.from(this.mapsInViewport),n=t.map(a=>a.mapId).filter((a,o,c)=>c.indexOf(a)===o);this.mapsInViewport=new Set(n.sort((a,o)=>{const c=this.warpedMapList.getMapZIndex(a),h=this.warpedMapList.getMapZIndex(o);return c!==void 0&&h!==void 0?c-h:0}));const i=n.filter(a=>!e.includes(a)),s=e.filter(a=>!n.includes(a));for(const a in i)this.dispatchEvent(new U(C.WarpedMapEventType.WARPEDMAPENTER,a));for(const a in s)this.dispatchEvent(new U(C.WarpedMapEventType.WARPEDMAPLEAVE,a))}renderInternal(){if(!this.viewport)return;const t=kl(this.viewport.projectedGeoToClipTransform,this.invertedRenderTransform),e=this.gl;e.viewport(0,0,e.canvas.width,e.canvas.height),e.enable(e.BLEND),e.blendFunc(e.ONE,e.ONE_MINUS_SRC_ALPHA),e.useProgram(this.program);const n=e.getUniformLocation(this.program,"u_renderTransform");e.uniformMatrix4fv(n,!1,Ll(t));const i=e.getUniformLocation(this.program,"u_animationProgress");e.uniform1f(i,this.animationProgress);for(const s of this.mapsInViewport){const a=this.webgl2WarpedMapsById.get(s);if(!a)continue;this.setRenderOptionsUniforms(this.renderOptions,a.renderOptions);const o=e.getUniformLocation(this.program,"u_opacity");e.uniform1f(o,this.opacity*a.opacity);const c=e.getUniformLocation(this.program,"u_saturation");e.uniform1f(c,this.saturation*a.saturation);const h=e.getUniformLocation(this.program,"u_bestScaleFactor"),l=a.warpedMap.bestScaleFactor;e.uniform1i(h,l);const u=e.getUniformLocation(this.program,"u_packedTilesTexture");e.uniform1i(u,0),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,a.packedTilesTexture);const g=e.getUniformLocation(this.program,"u_packedTilesPositionsTexture");e.uniform1i(g,1),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,a.packedTilesPositionsTexture);const v=e.getUniformLocation(this.program,"u_packedTilesResourcePositionsAndDimensionsTexture");e.uniform1i(v,2),e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,a.packedTilesResourcePositionsAndDimensionsTexture);const y=e.getUniformLocation(this.program,"u_packedTilesScaleFactorsTexture");e.uniform1i(y,3),e.activeTexture(e.TEXTURE3),e.bindTexture(e.TEXTURE_2D,a.packedTilesScaleFactorsTexture);const E=a.vao,I=a.warpedMap.resourceTrianglePoints.length,w=this.gl.TRIANGLES,S=0;e.bindVertexArray(E),e.drawArrays(w,S,I)}}setRenderOptionsUniforms(t,e){const n=this.gl,i={removeColorOptions:{color:e.removeColorOptions?.color||t.removeColorOptions?.color,hardness:Xi(e.removeColorOptions?.hardness,t.removeColorOptions?.hardness),threshold:Xi(e.removeColorOptions?.threshold,t.removeColorOptions?.threshold)},colorizeOptions:{...t.colorizeOptions,...e.colorizeOptions}},s=i.removeColorOptions?.color,a=n.getUniformLocation(this.program,"u_removeColor");if(n.uniform1f(a,s?1:0),s){const h=n.getUniformLocation(this.program,"u_removeColorOptionsColor");n.uniform3fv(h,s);const l=n.getUniformLocation(this.program,"u_removeColorOptionsThreshold");n.uniform1f(l,i.removeColorOptions?.threshold||Gd);const u=n.getUniformLocation(this.program,"u_removeColorOptionsHardness");n.uniform1f(u,i.removeColorOptions?.hardness||Fd)}const o=i.colorizeOptions?.color,c=n.getUniformLocation(this.program,"u_colorize");if(n.uniform1f(c,o?1:0),o){const h=n.getUniformLocation(this.program,"u_colorizeOptionsColor");n.uniform3fv(h,o)}}changed(){this.dispatchEvent(new U(C.WarpedMapEventType.CHANGED))}imageInfoLoaded(t){t instanceof U&&this.dispatchEvent(new U(C.WarpedMapEventType.IMAGEINFOLOADED))}mapTileLoaded(t){if(t instanceof U){const{mapId:e,tileUrl:n}=t.data,i=this.tileCache.getCacheableTile(n);if(!i||!i.isCachedTile())return;const s=this.webgl2WarpedMapsById.get(e);if(!s)return;s.addCachedTileAndUpdateTextures(i)}}mapTileRemoved(t){if(t instanceof U){const{mapId:e,tileUrl:n}=t.data,i=this.webgl2WarpedMapsById.get(e);if(!i)return;i.removeCachedTileAndUpdateTextures(n)}}warpedMapAdded(t){if(t instanceof U){const e=t.data,n=this.warpedMapList.getWarpedMap(e);if(n){const i=new kd(this.gl,this.program,n);this.webgl2WarpedMapsById.set(n.mapId,i),this.addEventListenersToWebGL2WarpedMap(i)}}}transformationChanged(t){if(t instanceof U){const e=t.data;for(const n of this.warpedMapList.getWarpedMaps(e))this.animating&&n.mixProjectedGeoCurrentAndNewTrianglePoints(this.animationProgress),n.updateProjectedGeoTrianglePoints(!1);this.updateVertexBuffers(),this.startTransformationTransition()}}resourceMaskUpdated(t){if(t instanceof U){const e=t.data,n=this.warpedMapList.getWarpedMap(e);n&&(n.clearResourceTrianglePointsByBestScaleFactor(),n.updateTriangulation(!1))}}addEventListenersToWebGL2WarpedMap(t){t.addEventListener(C.WarpedMapEventType.TEXTURESUPDATED,this.throttledChanged.bind(this))}removeEventListenersFromWebGL2WarpedMap(t){t.removeEventListener(C.WarpedMapEventType.TEXTURESUPDATED,this.throttledChanged.bind(this))}addEventListeners(){this.tileCache.addEventListener(C.WarpedMapEventType.MAPTILELOADED,this.mapTileLoaded.bind(this)),this.tileCache.addEventListener(C.WarpedMapEventType.MAPTILEREMOVED,this.mapTileRemoved.bind(this)),this.warpedMapList.addEventListener(C.WarpedMapEventType.IMAGEINFOLOADED,this.imageInfoLoaded.bind(this)),this.warpedMapList.addEventListener(C.WarpedMapEventType.WARPEDMAPADDED,this.warpedMapAdded.bind(this)),this.warpedMapList.addEventListener(C.WarpedMapEventType.TRANSFORMATIONCHANGED,this.transformationChanged.bind(this)),this.warpedMapList.addEventListener(C.WarpedMapEventType.RESOURCEMASKUPDATED,this.resourceMaskUpdated.bind(this)),this.warpedMapList.addEventListener(C.WarpedMapEventType.CLEARED,this.clear.bind(this))}removeEventListeners(){this.tileCache.removeEventListener(C.WarpedMapEventType.MAPTILELOADED,this.mapTileLoaded.bind(this)),this.tileCache.removeEventListener(C.WarpedMapEventType.MAPTILEREMOVED,this.mapTileRemoved.bind(this)),this.warpedMapList.removeEventListener(C.WarpedMapEventType.IMAGEINFOLOADED,this.imageInfoLoaded.bind(this)),this.warpedMapList.removeEventListener(C.WarpedMapEventType.WARPEDMAPADDED,this.warpedMapAdded.bind(this)),this.warpedMapList.removeEventListener(C.WarpedMapEventType.TRANSFORMATIONCHANGED,this.transformationChanged.bind(this)),this.warpedMapList.removeEventListener(C.WarpedMapEventType.RESOURCEMASKUPDATED,this.resourceMaskUpdated.bind(this)),this.warpedMapList.removeEventListener(C.WarpedMapEventType.CLEARED,this.clear.bind(this))}}const zd=pt.Layer.extend({options:{opacity:1,interactive:!1,className:"",pane:"tilePane",zIndex:"1"},initialize(r,t){this._annotation=r,pt.setOptions(this,t),this._initGl()},async onAdd(r){const t=this.getPaneName();return this._map.getPane(t).appendChild(this.container),r.on("zoomend viewreset move",this._update,this),r.on("zoomanim",this._animateZoom,this),r.on("unload",this._unload,this),this.resizeObserver=new ResizeObserver(this._resized.bind(this)),this.resizeObserver.observe(this._map.getContainer(),{box:"content-box"}),this._annotation&&(hc(this._annotation)?await this.addGeoreferenceAnnotationByUrl(this._annotation):await this.addGeoreferenceAnnotation(this._annotation)),this._update(),this},onRemove(r){this.container.remove(),r.off("zoomend viewreset move",this._update,this),r.off("zoomanim",this._animateZoom,this)},async addGeoreferenceAnnotation(r){const t=await this.renderer.warpedMapList.addGeoreferenceAnnotation(r);return this._update(),t},async removeGeoreferenceAnnotation(r){const t=await this.renderer.warpedMapList.removeGeoreferenceAnnotation(r);return this._update(),t},async addGeoreferenceAnnotationByUrl(r){const t=await fetch(r).then(n=>n.json());return this.addGeoreferenceAnnotation(t)},async removeGeoreferenceAnnotationByUrl(r){const t=await fetch(r).then(n=>n.json());return this.removeGeoreferenceAnnotation(t)},async addGeoreferencedMap(r){const t=this.renderer.warpedMapList.addGeoreferencedMap(r);return this._update(),t},async removeGeoreferencedMap(r){const t=this.renderer.warpedMapList.removeGeoreferencedMap(r);return this._update(),t},getContainer(){return this.container},getCanvas(){return this.canvas},getWarpedMapList(){return this.renderer.warpedMapList},getWarpedMap(r){return this.renderer.warpedMapList.getWarpedMap(r)},showMap(r){this.renderer.warpedMapList.showMaps([r]),this._update()},showMaps(r){this.renderer.warpedMapList.showMaps(r),this._update()},hideMap(r){this.renderer.warpedMapList.hideMaps([r]),this._update()},hideMaps(r){this.renderer.warpedMapList.hideMaps(r),this._update()},isMapVisible(r){return this.renderer.warpedMapList.getWarpedMap(r)?.visible},setMapResourceMask(r,t){this.renderer.warpedMapList.setMapResourceMask(r,t),this._update()},setMapsTransformationType(r,t){this.renderer.warpedMapList.setMapsTransformationType(r,t),this._update()},getTotalBbox(){return this.renderer.warpedMapList.getBbox()},getTotalProjectedBbox(){return this.renderer.warpedMapList.getProjectedBbox()},getTotalBounds(){const r=this.getTotalBbox();return pt.latLngBounds(pt.latLng(r[1],r[0]),pt.latLng(r[3],r[2]))},getTotalProjectedBounds(){const r=this.getTotalProjectedBbox();return pt.latLngBounds(pt.latLng(r[1],r[0]),pt.latLng(r[3],r[2]))},bringMapsToFront(r){this.renderer.warpedMapList.bringMapsToFront(r),this._update()},sendMapsToBack(r){this.renderer.warpedMapList.sendMapsToBack(r),this._update()},bringMapsForward(r){this.renderer.warpedMapList.bringMapsForward(r),this._update()},sendMapsBackward(r){this.renderer.warpedMapList.sendMapsBackward(r),this._update()},bringToFront(){return this._map&&pt.DomUtil.toFront(this.container),this},bringToBack(){return this._map&&pt.DomUtil.toBack(this.container),this},getMapZIndex(r){return this.renderer.warpedMapList.getMapZIndex(r)},getZIndex(){return this.options.zIndex},setZIndex(r){return this.options.zIndex=r,this._updateZIndex(),this},setImageInfoCache(r){this.renderer.warpedMapList.setImageInfoCache(r)},getPaneName(){return this._map.getPane(this.options.pane)?this.options.pane:"tilePane"},getOpacity(){return this.options.opacity},setOpacity(r){return this.options.opacity=r,this._update(),this},resetOpacity(){return this.options.opacity=1,this._update(),this},getMapOpacity(r){return this.renderer.getMapOpacity(r)},setMapOpacity(r,t){return this.renderer.setMapOpacity(r,t),this._update(),this},resetMapOpacity(r){return this.renderer.resetMapOpacity(r),this._update(),this},setSaturation(r){return this.renderer.setSaturation(r),this._update(),this},resetSaturation(){return this.renderer.resetSaturation(),this._update(),this},setMapSaturation(r,t){return this.renderer.setMapSaturation(r,t),this._update(),this},resetMapSaturation(r){return this.renderer.resetMapSaturation(r),this._update(),this},setRemoveColor(r){const t=r.hexColor?$i(r.hexColor):void 0;return this.renderer.setRemoveColorOptions({color:t,threshold:r.threshold,hardness:r.hardness}),this._update(),this},resetRemoveColor(){return this.renderer.resetRemoveColorOptions(),this._update(),this},setMapRemoveColor(r,t){const e=t.hexColor?$i(t.hexColor):void 0;return this.renderer.setMapRemoveColorOptions(r,{color:e,threshold:t.threshold,hardness:t.hardness}),this._update(),this},resetMapRemoveColor(r){return this.renderer.resetMapRemoveColorOptions(r),this},setColorize(r){const t=this.hexToRgb(r);return t&&(this.renderer.setColorizeOptions({color:t}),this._update()),this},resetColorize(){return this.renderer.resetColorizeOptions(),this._update(),this},setMapColorize(r,t){const e=this.hexToRgb(t);return e&&(this.renderer.setMapColorizeOptions(r,{color:e}),this._update()),this},resetMapColorize(r){return this.renderer.resetMapColorizeOptions(r),this._update(),this},_initGl(){if(this.container=pt.DomUtil.create("div"),this.container.classList.add("leaflet-layer"),this.container.classList.add("allmaps-warped-map-layer"),this.options.zIndex&&this._updateZIndex(),this.canvas=pt.DomUtil.create("canvas",void 0,this.container),this.canvas.classList.add("leaflet-zoom-animated"),this.canvas.classList.add("leaflet-image-layer"),this.options.interactive&&this.canvas.classList.add("leaflet-interactive"),this.options.className&&this.canvas.classList.add(this.options.className),this.gl=this.canvas.getContext("webgl2",{premultipliedAlpha:!0}),!this.gl)throw new Error("WebGL 2 not available");const r=new Pu(this.options.imageInfoCache);this.renderer=new Vd(this.gl,r),this._addEventListeners()},_resized(r){for(const t of r){const e=t.contentRect.width,n=t.contentRect.height,i=window.devicePixelRatio,s=Math.round(e*i),a=Math.round(n*i);this.canvas.width=s,this.canvas.height=a,this.canvas.style.width=e+"px",this.canvas.style.height=n+"px"}this._update()},_animateZoom(r){const t=this._map.getZoomScale(r.zoom),e=this._map._latLngBoundsToNewLayerBounds(this._map.getBounds(),r.zoom,r.center).min;pt.DomUtil.setTransform(this.canvas,e,t)},_updateZIndex(){this.container&&this.options.zIndex!==void 0&&this.options.zIndex!==null&&(this.container.style.zIndex=this.options.zIndex)},_update(){if(!this._map)return;const r=this._map.containerPointToLayerPoint([0,0]);pt.DomUtil.setPosition(this.canvas,r),this.renderer.setOpacity(this.getOpacity());const t=this._map.getCenter(),e=this._map.options.crs.project(t),n=[e.x,e.y],i=this._map.getSize(),s=[i.x,i.y],a=this._map.getBounds(),o=this._map.options.crs.project(a.getNorthEast()),c=this._map.options.crs.project(a.getSouthWest()),h=[c.x,c.y,o.x,o.y],l=dr(h),u=Zi(l,s),g=new ku(n,s,0,u,window.devicePixelRatio);return this.renderer.render(g),this.container},_addEventListeners(){this.renderer.addEventListener(C.WarpedMapEventType.CHANGED,this._update.bind(this)),this.renderer.addEventListener(C.WarpedMapEventType.IMAGEINFOLOADED,this._update.bind(this)),this.renderer.addEventListener(C.WarpedMapEventType.WARPEDMAPENTER,this._passWarpedMapEvent.bind(this)),this.renderer.addEventListener(C.WarpedMapEventType.WARPEDMAPLEAVE,this._passWarpedMapEvent.bind(this)),this.renderer.tileCache.addEventListener(C.WarpedMapEventType.FIRSTMAPTILELOADED,this._passWarpedMapEvent.bind(this)),this.renderer.tileCache.addEventListener(C.WarpedMapEventType.ALLREQUESTEDTILESLOADED,this._passWarpedMapEvent.bind(this)),this.renderer.warpedMapList.addEventListener(C.WarpedMapEventType.WARPEDMAPADDED,this._passWarpedMapEvent.bind(this)),this.renderer.warpedMapList.addEventListener(C.WarpedMapEventType.WARPEDMAPREMOVED,this._passWarpedMapEvent.bind(this)),this.renderer.warpedMapList.addEventListener(C.WarpedMapEventType.VISIBILITYCHANGED,this._update.bind(this)),this.renderer.warpedMapList.addEventListener(C.WarpedMapEventType.CLEARED,this._update.bind(this))},_removeEventListeners(){this.renderer.removeEventListener(C.WarpedMapEventType.CHANGED,this._update.bind(this)),this.renderer.removeEventListener(C.WarpedMapEventType.IMAGEINFOLOADED,this._update.bind(this)),this.renderer.removeEventListener(C.WarpedMapEventType.WARPEDMAPENTER,this._passWarpedMapEvent.bind(this)),this.renderer.removeEventListener(C.WarpedMapEventType.WARPEDMAPLEAVE,this._passWarpedMapEvent.bind(this)),this.renderer.tileCache.removeEventListener(C.WarpedMapEventType.FIRSTMAPTILELOADED,this._passWarpedMapEvent.bind(this)),this.renderer.tileCache.removeEventListener(C.WarpedMapEventType.ALLREQUESTEDTILESLOADED,this._passWarpedMapEvent.bind(this)),this.renderer.warpedMapList.removeEventListener(C.WarpedMapEventType.WARPEDMAPADDED,this._passWarpedMapEvent.bind(this)),this.renderer.warpedMapList.removeEventListener(C.WarpedMapEventType.WARPEDMAPREMOVED,this._passWarpedMapEvent.bind(this)),this.renderer.warpedMapList.removeEventListener(C.WarpedMapEventType.VISIBILITYCHANGED,this._update.bind(this)),this.renderer.warpedMapList.removeEventListener(C.WarpedMapEventType.CLEARED,this._update.bind(this))},_passWarpedMapEvent(r){r instanceof U&&this._map&&this._map.fire(r.type,r.data)},_unload(){this.renderer.dispose();const r=this.gl.getExtension("WEBGL_lose_context");r&&r.loseContext();const t=this.gl.canvas;t.width=1,t.height=1,this.resizeObserver.disconnect(),this._removeEventListeners()}});C.WarpedMapEvent=U,C.WarpedMapLayer=zd,Object.defineProperty(C,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=allmaps-leaflet-1.9.umd.js.map
